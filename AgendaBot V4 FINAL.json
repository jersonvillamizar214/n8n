{
  "name": "AgendaBot V4",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {"appendAttribution": false}
      },
      "id": "46873181-2128-4a84-8b07-dde8c17078c2",
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [
        -111648,
        120016
      ],
      "webhookId": "d1e7877b-4151-4aff-9c3a-0bf8cdd950cd",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "telegram_user",
              "name": "telegram_user",
              "value": "={{ String($json.message.from.id) }}",
              "type": "string"
            },
            {
              "id": "username",
              "name": "username",
              "value": "={{ $json.message.from.first_name || $json.message.from.username || 'Usuario' }}",
              "type": "string"
            },
            {
              "id": "mensaje",
              "name": "mensaje",
              "value": "={{ ($json.message.text || '').trim() }}",
              "type": "string"
            },
            {
              "id": "chat_id",
              "name": "chat_id",
              "value": "={{ String($json.message.chat.id) }}",
              "type": "string"
            },
            {
              "id": "timestamp",
              "name": "timestamp",
              "value": "={{ new Date().toISOString() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "0340d351-cc5e-4a6c-a603-9b013f25c648",
      "name": "Set Variables",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -111424,
        120016
      ]
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit?usp=drivesdk",
          "mode": "url"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "SESSIONS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "=telegram_user",
              "lookupValue": "={{ $json.telegram_user }}"
            }
          ]
        },
        "options": {}
      },
      "id": "2e997306-aa99-4d56-99e4-b1acde18d681",
      "name": "Get Session",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -111200,
        120016
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "session-exists",
              "leftValue": "={{ $json.pantalla_actual }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "f08135e1-b265-4cf6-b999-7704905e5959",
      "name": "Session Exists?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -110976,
        120016
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "telegram_user",
              "name": "telegram_user",
              "value": "={{ $('Set Variables').item.json.telegram_user }}",
              "type": "string"
            },
            {
              "id": "chat_id",
              "name": "chat_id",
              "value": "={{ $('Set Variables').item.json.chat_id }}",
              "type": "string"
            },
            {
              "id": "mensaje",
              "name": "mensaje",
              "value": "={{ $('Set Variables').item.json.mensaje }}",
              "type": "string"
            },
            {
              "id": "username",
              "name": "username",
              "value": "={{ $('Set Variables').item.json.username }}",
              "type": "string"
            },
            {
              "id": "timestamp",
              "name": "timestamp",
              "value": "={{ $('Set Variables').item.json.timestamp }}",
              "type": "string"
            },
            {
              "id": "pantalla_actual",
              "name": "pantalla_actual",
              "value": "={{ $json.pantalla_actual || 'menu_principal' }}",
              "type": "string"
            },
            {
              "id": "paso_actual",
              "name": "paso_actual",
              "value": "={{ $json.paso_actual || '0' }}",
              "type": "string"
            },
            {
              "id": "datos_parciales",
              "name": "datos_parciales",
              "value": "={{ $json.datos_parciales || '{}' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "13e72c3a-3027-4d37-9080-02896c285516",
      "name": "Merge Session Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -110528,
        119872
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "telegram_user",
              "name": "telegram_user",
              "value": "={{ $('Set Variables').item.json.telegram_user }}",
              "type": "string"
            },
            {
              "id": "chat_id",
              "name": "chat_id",
              "value": "={{ $('Set Variables').item.json.chat_id }}",
              "type": "string"
            },
            {
              "id": "mensaje",
              "name": "mensaje",
              "value": "={{ $('Set Variables').item.json.mensaje }}",
              "type": "string"
            },
            {
              "id": "username",
              "name": "username",
              "value": "={{ $('Set Variables').item.json.username }}",
              "type": "string"
            },
            {
              "id": "timestamp",
              "name": "timestamp",
              "value": "={{ $('Set Variables').item.json.timestamp }}",
              "type": "string"
            },
            {
              "id": "pantalla_actual",
              "name": "pantalla_actual",
              "value": "nuevo_usuario",
              "type": "string"
            },
            {
              "id": "paso_actual",
              "name": "paso_actual",
              "value": "0",
              "type": "string"
            },
            {
              "id": "datos_parciales",
              "name": "datos_parciales",
              "value": "{}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "37f38331-9e38-4daa-93ce-8686ae54de4b",
      "name": "Set New User Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -110752,
        120112
      ]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 319260215,
          "mode": "list",
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1hotrf-91CoJyrer3T8fgQzWAZaC6NZn-FfVSDZtKUn8/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $json.telegram_user }}",
            "pantalla_actual": "={{ $json.pantalla_actual }}",
            "paso_actual": "={{ $json.paso_actual }}",
            "datos_parciales": "={{ $json.datos_parciales }}",
            "timestamp_ultima_interaccion": "={{ $json.timestamp }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telegram_user",
              "displayName": "telegram_user",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pantalla_actual",
              "displayName": "pantalla_actual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "paso_actual",
              "displayName": "paso_actual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "datos_parciales",
              "displayName": "datos_parciales",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "timestamp_ultima_interaccion",
              "displayName": "timestamp_ultima_interaccion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "46ba271b-b439-408f-8d75-07d97b7ebb0f",
      "name": "Create New Session",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -110528,
        120112
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 2000502643,
          "mode": "list",
          "cachedResultName": "LOGS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1hotrf-91CoJyrer3T8fgQzWAZaC6NZn-FfVSDZtKUn8/edit#gid=2000502643"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "timestamp": "={{ $json.timestamp }}",
            "telegram_user": "={{ $json.telegram_user }}",
            "pantalla": "={{ $json.pantalla_actual }}",
            "opcion_elegida": "={{ $json.mensaje }}",
            "resultado": "procesando"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_user",
              "displayName": "telegram_user",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pantalla",
              "displayName": "pantalla",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "opcion_elegida",
              "displayName": "opcion_elegida",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "resultado",
              "displayName": "resultado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "ef77d324-9704-4d8f-a88d-b162b266ecea",
      "name": "Log Interaction",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -110304,
        119920
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "=Hola {{ $json.username }}, soy AgendaBot ðŸ‘‹\n\nEstoy aquÃ­ para ayudarte a organizar tus citas, tareas y recordatorios de forma sencilla y sin complicaciones.\n\nPuedes escribirme en cualquier momento.\nPara avanzar, solo tienes que escribir el nÃºmero de la opciÃ³n que quieras usar.\n\nMenÃº principal:\n0. Ayuda\n1. Agenda (citas)\n2. Tareas\n3. Recordatorios\n4. HÃ¡bitos\n5. Listas\n6. Reportes\n\nðŸ’¡ Tip: escribe solo el nÃºmero (ej: 1) y presiona enviar.",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "04821fce-9adb-45a1-961b-1dfd38cc2234",
      "name": "Send Bienvenida",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109856,
        114368
      ],
      "webhookId": "40628ee4-c0d7-41e8-868a-6714b571035a",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 319260215,
          "mode": "list",
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1hotrf-91CoJyrer3T8fgQzWAZaC6NZn-FfVSDZtKUn8/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $json.telegram_user }}",
            "pantalla_actual": "menu_principal",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ],
          "schema": [
            {
              "id": "telegram_user",
              "displayName": "telegram_user",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "pantalla_actual",
              "displayName": "pantalla_actual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "paso_actual",
              "displayName": "paso_actual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "datos_parciales",
              "displayName": "datos_parciales",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "timestamp_ultima_interaccion",
              "displayName": "timestamp_ultima_interaccion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "dbfcc5d6-bee2-479f-ab52-8a0ea25ffa52",
      "name": "Update Session to Menu",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109408,
        114368
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fcf71e05-8000-4cf2-bc68-c48b3f232755",
              "name": "=telegram_user",
              "value": "={{ $('Set Variables').item.json.telegram_user }}",
              "type": "string"
            },
            {
              "id": "78e868ab-851a-4b9c-81a6-79cfb640560d",
              "name": "timestamp",
              "value": "={{ $('Set Variables').item.json.timestamp }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -109632,
        114368
      ],
      "id": "5dea253d-d6fd-4866-800d-4cc0d24953ef",
      "name": "Prepare Update Data"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "nuevo_usuario",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "78ae880b-7907-4375-ba18-175e41ba057f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "bienvenida"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "reset",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "/start",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "or"
              },
              "renameOutput": true,
              "outputKey": "inicio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "menu_principal",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "46d39ddb-d57d-49de-83d0-2b2de8613b20"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "menu_principal"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "agenda_menu",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "8efa232e-9513-44cf-85d5-516eebcc9339"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "agenda_menu"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "agenda_crear_paso",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    },
                    "id": "1eeaf8e8-f782-4d21-a504-88d6049dc594"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "agenda_wizard"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "tareas_menu",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "68f4f53e-5398-4e8b-8df7-e751e9e4a927"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "tareas_menu"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "tarea_crear_paso",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    },
                    "id": "tarea-wizard-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "tarea_wizard"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "habitos_menu",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "c94dec9f-13e2-4ff4-b4eb-e0c7a9eacdbb"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "habitos_menu"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "listas_menu",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "acfd0fd7-8ca3-4e8c-9532-9feb7dfe9e99"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "listas_menu"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "recordatorios_menu",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "eba92eb3-0f47-4ef0-82c4-4e7d1a276cc6"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "recordatorios_menu"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "reportes_menu",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f9f5b1cf-eeed-4f59-a238-687aea491b5d"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reportes_menu"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "config_menu",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "cb04c32b-2d72-48bc-8df1-bfcf70f52e9b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "config_menu"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "admin_menu",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "ff5f693e-9967-489c-935a-2c4ef27a74ff"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "admin_menu"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "ayuda_menu",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "ayuda-menu-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ayuda_menu"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "agenda_repro_1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "agenda_repro_1"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "agenda_repro_2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "agenda_repro_2"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "agenda_cancel_1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "agenda_cancel_1"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "agenda_completar_1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "agenda_completar_1"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "consultar_citas",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar_citas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "ver_tareas_pendientes",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ver_tareas_pendientes"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "ver_tareas_completadas",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ver_tareas_completadas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "tarea_completar_1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "tarea_completar_1"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "tarea_completada_confirm",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "tarea_completada_confirm"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "tarea_eliminar_1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "tarea_eliminar_1"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "tarea_eliminada_confirm",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "tarea_eliminada_confirm"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "ver_habitos",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ver_habitos"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "habito_eliminar_1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "habito_eliminar_1"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "habito_eliminado_confirm",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "habito_eliminado_confirm"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "habito_crear_1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "habito_crear_1"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "habito_crear_2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "habito_crear_2"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "habito_crear_3",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "habito_crear_3"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "recordatorio_editar_1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "recordatorio_editar_1"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "recordatorio_editar_2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "recordatorio_editar_2"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "lista_crear_1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "lista_crear_1"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "lista_crear_2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "lista_crear_2"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "ver_listas",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ver_listas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "items_lista",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "items_lista"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "items_agregar",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "items_agregar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "items_completar_1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "items_completar_1"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "items_eliminar_1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "items_eliminar_1"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "reporte_dia",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reporte_dia"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "reporte_semanal",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reporte_semanal"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "reporte_productividad",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reporte_productividad"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "b55f07fc-3e23-4eae-9691-d55c757bd939",
      "name": "Router Principal",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -110080,
        119248
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "0",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ayuda"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "agenda"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "tareas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "3",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "recordatorios"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "4",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "habitos"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "5",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "listas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "6",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reportes"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "7",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "config"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "8",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "admin"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "9a21cfe3-2343-4f77-a812-80189312f45c",
      "name": "Menu Principal Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -109632,
        121824
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "AYUDA - AgendaBot\n\nAgenda: Gestiona citas\nTareas: Pendientes\nRecordatorios: No olvides nada\nHabitos: Rutinas\nListas: Organiza items\nReportes: Resumen\n\n9. Volver al menu",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "7f95c3e4-cf2c-4031-94f2-ca8d9f284456",
      "name": "Send Ayuda",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109408,
        121144
      ],
      "webhookId": "2c99b8a0-e5e8-4668-9000-345f26006eb3",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "AGENDA\n\n1. Agendar cita\n2. Consultar agenda\n3. Reprogramar\n4. Cancelar\n5. Completar\n9. Volver",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "fd41622d-fae9-4f4d-882f-5f59a9f375bf",
      "name": "Send Agenda Menu",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109408,
        121336
      ],
      "webhookId": "b638330f-35a7-4398-806e-7fc06d94f707",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "agenda_menu",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}",
            "row_number": 0
          },
          "matchingColumns": [
            "telegram_user"
          ],
          "schema": [
            {
              "id": "telegram_user",
              "displayName": "telegram_user",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pantalla_actual",
              "displayName": "pantalla_actual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "paso_actual",
              "displayName": "paso_actual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "datos_parciales",
              "displayName": "datos_parciales",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "timestamp_ultima_interaccion",
              "displayName": "timestamp_ultima_interaccion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "24370c3c-4f70-4306-823f-7cf0e5f8aecc",
      "name": "Update to Agenda Menu",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109184,
        121336
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "TAREAS\n\n1. Crear tarea\n2. Ver pendientes\n3. Ver completadas\n4. Completar\n5. Eliminar\n9. Volver",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "beeea628-7281-4a65-8db6-817416461245",
      "name": "Send Tareas Menu",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108064,
        125800
      ],
      "webhookId": "4700a0c5-c904-4103-8d94-d4e046dee0d7",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "tareas_menu",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "76e2a993-cae2-4112-9408-0ff64611f089",
      "name": "Update to Tareas Menu",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -107840,
        125800
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "HABITOS\n\n1. Crear habito\n2. Ver habitos\n3. Eliminar\n9. Volver",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "d65f6ca1-3ef7-4569-b947-f04ffb9be3d3",
      "name": "Send Habitos Menu",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        114896
      ],
      "webhookId": "dc65c4be-26df-48bd-ba1e-84086a142a8b",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "habitos_menu",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "31b03c91-eef2-470b-804c-d700fd80882a",
      "name": "Update to Habitos",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108960,
        114896
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ver"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "3",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "eliminar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "volver"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "e9677ec2-e690-4d7c-aab6-bfc8030009a6",
      "name": "Habitos Menu Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -108288,
        116920
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Escribe el nombre del habito:\n\n9. Cancelar",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "ea99a261-e7f8-4434-9cd3-7556fe97c437",
      "name": "Send Habito Paso 1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108064,
        116632
      ],
      "webhookId": "910bda63-2c18-4683-b92d-4f9257a00bec",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "habito_crear_1",
            "paso_actual": "1",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "41741eb2-f122-4f74-9e8e-53bf79ee38b3",
      "name": "Update Habito Paso 1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -107840,
        116632
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 563773723,
          "cachedResultName": "HABITOS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "estado",
              "lookupValue": "activo"
            }
          ]
        },
        "options": {}
      },
      "id": "166eb72f-9146-47f9-8c19-169772043219",
      "name": "Get Habitos Activos",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108064,
        116824
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nif (!items.length || !items[0].json.nombre) {\n  return [{json:{mensaje:'HABITOS:\\n\\nNo tienes habitos activos.\\n\\n9. Volver'}}];\n}\nlet t = 'HABITOS ACTIVOS:\\n\\n';\nfor (let i = 0; i < items.length; i++) {\n  const freq = items[i].json.frecuencia ? ' - ' + items[i].json.frecuencia : '';\n  const hora = items[i].json.hora_recordatorio ? ' - ' + items[i].json.hora_recordatorio : '';\n  t += (i+1)+'. '+items[i].json.nombre + freq + hora + '\\n';\n}\nreturn [{json:{mensaje:t+'\\n9. Volver'}}];"
      },
      "id": "e7c60d2c-c823-4454-9e65-0e22e79962ab",
      "name": "Format Habitos Activos",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -107840,
        116824
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $json.mensaje }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "d298573e-4812-4913-b290-b587a8ebbd61",
      "name": "Send Habitos Activos",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -107616,
        117280
      ],
      "webhookId": "ecb062d1-d677-4cb0-9e40-a23d41f6829c",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "ver_habitos",
            "paso_actual": "1",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "f8f9b75e-6e46-4217-a747-8bac805a3d2d",
      "name": "Update Session Ver Habitos",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -107392,
        117280
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').first().json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "volver"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "46f4bf8e-3874-4018-8c12-d60195333e3a",
      "name": "Ver Habitos Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -109408,
        116488
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "Opcion no valida. Presiona 9 para volver.",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "81171f93-8a83-44e5-ae99-f115197d9bc0",
      "name": "Send Invalid Ver Habitos",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        116584
      ],
      "webhookId": "bbbdbb4b-0ebe-4514-afad-d71221df44f1",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 563773723,
          "cachedResultName": "HABITOS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "estado",
              "lookupValue": "activo"
            }
          ]
        },
        "options": {}
      },
      "id": "b8f22590-40c8-4e43-afe7-8fd1ab60f2bd",
      "name": "Get Habitos Para Eliminar",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108064,
        118096
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nif (!items.length || !items[0].json.nombre) {\n  return [{json:{mensaje:'ELIMINAR HABITO:\\n\\nNo tienes habitos activos.\\n\\n9. Volver', list: []}}];\n}\nlet t = 'ELIMINAR HABITO:\\n\\nSelecciona el numero del habito a eliminar:\\n\\n';\nconst list = [];\nfor (let i = 0; i < items.length; i++) {\n  t += (i+1)+'. '+items[i].json.nombre + '\\n';\n  list.push({index: i+1, id_habito: items[i].json.id_habito, nombre: items[i].json.nombre});\n}\nreturn [{json:{mensaje:t+'\\n9. Volver', list: list}}];"
      },
      "id": "92c541fe-f6b6-4944-bc21-4a34d1773b21",
      "name": "Format Lista Eliminar Habitos",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -107840,
        118096
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $json.mensaje }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "9346601d-c009-404e-8bbb-6d29395095c5",
      "name": "Send Lista Eliminar Habitos",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -107616,
        118552
      ],
      "webhookId": "0ab9fab1-e09b-4e30-b2f9-bb971945e179",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "habito_eliminar_1",
            "paso_actual": "1",
            "datos_parciales": "={{ JSON.stringify($('Format Lista Eliminar Habitos').first().json.list) }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "4f0c6585-99b1-4349-a69d-9f26e07d6113",
      "name": "Update Session Eliminar Habito",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -107392,
        118552
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const mensaje = $('Set Variables').first().json.mensaje;\nconst listJson = $('Merge Session Data').first().json.datos_parciales || '[]';\nlet list = [];\ntry { list = JSON.parse(listJson); if (!Array.isArray(list)) list = []; } catch(e) { list = []; }\n\nif (mensaje === '9') { return [{json: {valid: false, cancel: true}}]; }\n\nconst index = parseInt(mensaje);\nif (isNaN(index) || index < 1 || index > list.length || !list[index - 1]) {\n  return [{json: {valid: false, cancel: false, error: 'Seleccion no valida. Escribe el numero o 9 para volver.'}}];\n}\n\nconst selected = list[index - 1];\nreturn [{json: {valid: true, id_habito: selected.id_habito, nombre: selected.nombre}}];"
      },
      "id": "63da7e3c-c033-4ce0-a7bd-5df763de2e5b",
      "name": "Logic Seleccion Eliminar Habito",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109856,
        117880
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "285d12e3-d62a-42a8-b664-a778e4667dca",
      "name": "If Valid Eliminar Habito",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109632,
        117880
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 563773723,
          "cachedResultName": "HABITOS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id_habito": "={{ $json.id_habito }}",
            "estado": "eliminado"
          },
          "matchingColumns": [
            "id_habito"
          ]
        },
        "options": {}
      },
      "id": "f3aed2bc-4bdf-46cd-b1cb-8ed3b3b97eb6",
      "name": "Update Habito Eliminado",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109408,
        117880
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "=ðŸ—‘ï¸ Habito eliminado: {{ $('Logic Seleccion Eliminar Habito').first().json.nombre }}\n\n9. Volver",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "cf895c4c-7a62-4987-80af-c53cf880ee1d",
      "name": "Send Habito Eliminado",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        117880
      ],
      "webhookId": "81638b66-227b-4881-ab74-a5cd0296f95b",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.cancel }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "45bdee3b-1c9f-4cdd-a940-a4ca19a8ee95",
      "name": "If Cancel Eliminar Habito",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109408,
        118072
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $('Logic Seleccion Eliminar Habito').first().json.error }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "fc339ed1-5fa7-4a4d-a8eb-16279bc132aa",
      "name": "Send Error Eliminar Habito",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        118248
      ],
      "webhookId": "88f2a318-2211-474c-b857-40adabc6ef12",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "habito_eliminado_confirm",
            "paso_actual": "1",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "04296d2d-c3e5-42fa-9cd3-2e6834eae505",
      "name": "Update Session Habito Eliminado",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108960,
        117880
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').first().json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "volver"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "00294260-4d8f-48bc-b386-abae85c91160",
      "name": "Habito Eliminado Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -109408,
        117112
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "Opcion no valida. Presiona 9 para volver.",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "bcb5dc0b-e8dc-4691-bdf9-02d1a1723802",
      "name": "Send Invalid Habito Eliminado",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        117208
      ],
      "webhookId": "f8f22735-3d4e-42d7-ae76-deff01f02079",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Opcion no valida en Habitos. Presiona 9 para volver.",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "dc05d498-00ff-4519-af96-6e4a42eb8ee7",
      "name": "Send Invalid Habitos",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108064,
        118392
      ],
      "webhookId": "881e1c44-ef60-48ce-a3b7-202a8fb1bd60",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const mensaje = $('Set Variables').first().json.mensaje;\nif (mensaje === '9') { return [{json: {cancel: true}}]; }\nconst datos = JSON.parse($('Merge Session Data').first().json.datos_parciales || '{}');\ndatos.nombre = mensaje;\nreturn [{json: {cancel: false, datos_parciales: JSON.stringify(datos)}}];"
      },
      "id": "f0b6e8a2-13c8-4c91-a05b-9a60969b35b5",
      "name": "Habito Crear Paso 2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109632,
        115424
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.cancel }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "cc7cbb9e-5dde-4540-9429-90e413ab6367",
      "name": "If Cancel Crear Habito",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109408,
        115424
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "Selecciona la frecuencia:\n\n1. Diario\n2. Semanal\n\n9. Cancelar",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "d40520ae-3714-4062-a28f-402dbd698e3c",
      "name": "Send Habito Paso 2",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        115424
      ],
      "webhookId": "a775d0a2-d2d9-4bb9-aa04-7c953c38057c",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "habito_crear_2",
            "paso_actual": "2",
            "datos_parciales": "={{ $('Habito Crear Paso 2').first().json.datos_parciales }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "b6611dc2-b892-4c74-8ac4-ad87c382954b",
      "name": "Update Habito Paso 2",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108960,
        115424
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const mensaje = $('Set Variables').first().json.mensaje;\nif (mensaje === '9') { return [{json: {cancel: true}}]; }\nconst datos = JSON.parse($('Merge Session Data').first().json.datos_parciales || '{}');\nif (mensaje === '1') datos.frecuencia = 'diario';\nelse if (mensaje === '2') datos.frecuencia = 'semanal';\nelse { return [{json: {cancel: false, error: true}}]; }\nreturn [{json: {cancel: false, error: false, datos_parciales: JSON.stringify(datos)}}];"
      },
      "id": "b9836da1-15c4-4a93-b800-e567eca138ed",
      "name": "Habito Crear Paso 3",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109632,
        114704
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.cancel }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "560a69e2-7a44-49e6-841d-eec0df953507",
      "name": "If Cancel Crear Habito 2",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109408,
        114704
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "Escribe la hora del recordatorio (ej: 08:00):\n\n9. Cancelar",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "8c55f8bc-12c1-4599-a33e-9b6ce63cb0e0",
      "name": "Send Habito Paso 3",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        114704
      ],
      "webhookId": "2c22256c-a74b-4ec0-9923-c0733fceb956",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "habito_crear_3",
            "paso_actual": "3",
            "datos_parciales": "={{ $('Habito Crear Paso 3').first().json.datos_parciales }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "2b6b4299-6224-44f8-94c7-b9b194831779",
      "name": "Update Habito Paso 3",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108960,
        114704
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const mensaje = $('Set Variables').first().json.mensaje;\nif (mensaje === '9') { return [{json: {cancel: true}}]; }\nconst datos = JSON.parse($('Merge Session Data').first().json.datos_parciales || '{}');\ndatos.hora_recordatorio = mensaje;\nconst id_habito = 'HAB-' + Date.now();\nreturn [{json: {cancel: false, id_habito: id_habito, nombre: datos.nombre, frecuencia: datos.frecuencia, hora_recordatorio: datos.hora_recordatorio, estado: 'activo'}}];"
      },
      "id": "9936b1a1-22d4-4cea-8ffc-5a3447084be6",
      "name": "Guardar Habito",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109632,
        115088
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.cancel }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "f0a9843c-f2d3-46ca-9e57-336451930a53",
      "name": "If Cancel Crear Habito 3",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109408,
        115088
      ]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 563773723,
          "cachedResultName": "HABITOS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id_habito": "={{ $json.id_habito }}",
            "nombre": "={{ $json.nombre }}",
            "frecuencia": "={{ $json.frecuencia }}",
            "hora_recordatorio": "={{ $json.hora_recordatorio }}",
            "estado": "={{ $json.estado }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "id_habito",
              "displayName": "id_habito",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "nombre",
              "displayName": "nombre",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "frecuencia",
              "displayName": "frecuencia",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hora_recordatorio",
              "displayName": "hora_recordatorio",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "estado",
              "displayName": "estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "c9e981eb-1c66-48b8-aa73-cbd74481e4b5",
      "name": "Insert Habito",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109184,
        115088
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "=âœ… Habito creado: {{ $('Guardar Habito').first().json.nombre }}\nFrecuencia: {{ $('Guardar Habito').first().json.frecuencia }}\nRecordatorio: {{ $('Guardar Habito').first().json.hora_recordatorio }}\n\n9. Volver",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "b100ca57-aeb9-416b-9962-0bff0ed0586f",
      "name": "Send Habito Creado",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108960,
        115088
      ],
      "webhookId": "b72c3018-aaf2-474c-9428-4f86dbd8c07a",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 563773723,
          "cachedResultName": "HABITOS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "estado",
              "lookupValue": "activo"
            }
          ]
        },
        "options": {}
      },
      "id": "b68654be-fe41-4a75-b4d0-175538a13857",
      "name": "Get Habitos Recordatorio",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109408,
        121624
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nif (!items.length || !items[0].json.nombre) {\n  return [{json:{mensaje:'RECORDATORIOS:\\n\\nNo tienes habitos para configurar.\\n\\n9. Volver', list: []}}];\n}\nlet t = 'RECORDATORIOS:\\n\\nSelecciona un habito para cambiar su hora:\\n\\n';\nconst list = [];\nfor (let i = 0; i < items.length; i++) {\n  const hora = items[i].json.hora_recordatorio || 'sin hora';\n  t += (i+1)+'. '+items[i].json.nombre + ' - ' + hora + '\\n';\n  list.push({index: i+1, id_habito: items[i].json.id_habito, nombre: items[i].json.nombre});\n}\nreturn [{json:{mensaje:t+'\\n9. Volver', list: list}}];"
      },
      "id": "08f75da0-1f38-49f3-8163-a3c0793a5385",
      "name": "Format Lista Recordatorios",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109184,
        121624
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $json.mensaje }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "1c0471fd-00bd-45e0-b4f9-1b7ee148e085",
      "name": "Send Lista Recordatorios",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108960,
        121624
      ],
      "webhookId": "3aebe909-632f-4f84-b2e6-a7fb78b76d80",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "recordatorio_editar_1",
            "paso_actual": "1",
            "datos_parciales": "={{ JSON.stringify($('Format Lista Recordatorios').first().json.list) }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "98ca8192-5408-4ca1-9174-1193c186b9b7",
      "name": "Update Session Recordatorio",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108736,
        121624
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const mensaje = $('Set Variables').first().json.mensaje;\nconst listJson = $('Merge Session Data').first().json.datos_parciales || '[]';\nlet list = [];\ntry { list = JSON.parse(listJson); if (!Array.isArray(list)) list = []; } catch(e) { list = []; }\n\nif (mensaje === '9') { return [{json: {valid: false, cancel: true}}]; }\n\nconst index = parseInt(mensaje);\nif (isNaN(index) || index < 1 || index > list.length || !list[index - 1]) {\n  return [{json: {valid: false, cancel: false, error: 'Seleccion no valida.'}}];\n}\n\nconst selected = list[index - 1];\nreturn [{json: {valid: true, id_habito: selected.id_habito, nombre: selected.nombre}}];"
      },
      "id": "284583ff-b07b-4037-81e7-9f12bb61ed45",
      "name": "Logic Seleccion Recordatorio",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -108736,
        115280
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "28d611b5-56a9-4e14-8de8-ee13d9bc3fc4",
      "name": "If Valid Recordatorio",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -108512,
        115280
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "=Escribe la nueva hora para {{ $json.nombre }} (ej: 08:00):\n\n9. Cancelar",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "1346977c-807a-47ac-bd54-01c39f219998",
      "name": "Send Pedir Hora",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108288,
        115280
      ],
      "webhookId": "90438c68-03aa-49d5-b2e4-0f6701d430a9",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "recordatorio_editar_2",
            "paso_actual": "2",
            "datos_parciales": "={{ JSON.stringify({id_habito: $('Logic Seleccion Recordatorio').first().json.id_habito, nombre: $('Logic Seleccion Recordatorio').first().json.nombre}) }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "56a2d31b-4690-4296-b829-32a7022d8b62",
      "name": "Update Session Recordatorio 2",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108064,
        115712
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.cancel }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "bf192a98-88e7-4d86-bf1b-0810f2ab81d9",
      "name": "If Cancel Recordatorio",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -108288,
        115608
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $('Logic Seleccion Recordatorio').first().json.error }}\n\n9. Volver",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "83debaae-f4ec-45fb-a517-15681502d211",
      "name": "Send Error Recordatorio",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108064,
        115960
      ],
      "webhookId": "d9c8c689-5fa1-4c1d-a99e-5172aebf9ee7",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const mensaje = $('Set Variables').first().json.mensaje;\nif (mensaje === '9') { return [{json: {cancel: true}}]; }\nconst datos = JSON.parse($('Merge Session Data').first().json.datos_parciales || '{}');\nreturn [{json: {cancel: false, id_habito: datos.id_habito, nombre: datos.nombre, hora_recordatorio: mensaje}}];"
      },
      "id": "f658d6c1-108a-495c-889c-2efdbeff29bb",
      "name": "Guardar Hora Recordatorio",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -108960,
        114512
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.cancel }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "60b443b7-af53-4a9e-b980-aeff0bcd08d7",
      "name": "If Cancel Guardar Hora",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -108736,
        114512
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 563773723,
          "cachedResultName": "HABITOS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id_habito": "={{ $json.id_habito }}",
            "hora_recordatorio": "={{ $json.hora_recordatorio }}"
          },
          "matchingColumns": [
            "id_habito"
          ]
        },
        "options": {}
      },
      "id": "c889da99-eeb6-48a5-a5c2-0334ac9bbf6f",
      "name": "Update Hora Habito",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108512,
        114512
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "=âœ… Hora actualizada para {{ $('Guardar Hora Recordatorio').first().json.nombre }}: {{ $('Guardar Hora Recordatorio').first().json.hora_recordatorio }}\n\nVolviendo al menÃº",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "2186e0c8-934b-4fdf-9461-ca3242d55a69",
      "name": "Send Hora Actualizada",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108288,
        114512
      ],
      "webhookId": "3791f4be-d63f-40f5-8160-5ea276489b65",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "LISTAS\n\n1. Crear lista\n2. Ver mis listas\n9. Volver",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "42c86326-4fb3-41a4-ba2f-dc757e0e59e9",
      "name": "Send Listas Menu",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        116008
      ],
      "webhookId": "c046e4ab-d9dc-4590-ac6d-6e8cfb6797c0",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "listas_menu",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "4bd0d2db-b895-425a-a50d-408496f4825e",
      "name": "Update to Listas",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108960,
        116008
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ver"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "volver"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "948a6e25-1a8a-4417-a485-d5051b318f2a",
      "name": "Listas Menu Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -109856,
        119648
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "CREAR LISTA\n\nEscribe el nombre de la lista:\n\n9. Cancelar",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "3df90174-b492-4cf0-bf6d-bd6aaeb90781",
      "name": "Send Lista Paso 1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109632,
        119736
      ],
      "webhookId": "82876878-351a-4ba5-8717-7f29c01d4707",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "lista_crear_1",
            "paso_actual": "1",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "3a9225da-ef73-4c8b-b2d3-bbb6cc1be201",
      "name": "Update Lista Paso 1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109408,
        119736
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const mensaje = String($('Set Variables').first().json.mensaje).trim();\nif (mensaje === '9') { return [{json: {cancel: true}}]; }\nconst id_lista = 'LIST-' + Date.now();\nreturn [{json: {cancel: false, id_lista: id_lista, nombre_lista: mensaje, items_count: 0}}];"
      },
      "id": "b01c5a99-96bf-4ae0-b8fb-2697dfeab72b",
      "name": "Lista Crear Nombre",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109632,
        116776
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.cancel }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "8ef637d7-5ad4-4725-a4d7-62a620c2ce46",
      "name": "If Cancel Lista 1",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109408,
        116776
      ]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 704259980,
          "cachedResultName": "LISTAS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id_lista": "={{ $json.id_lista }}",
            "nombre_lista": "={{ $json.nombre_lista }}",
            "tipo": "general",
            "creado_por": "={{ $('Set Variables').first().json.telegram_user }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "id_lista",
              "displayName": "id_lista",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "nombre_lista",
              "displayName": "nombre_lista",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "tipo",
              "displayName": "tipo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "creado_por",
              "displayName": "creado_por",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "ad9617c4-07f9-44ec-95b0-cf14b9f6e304",
      "name": "Insert Lista",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109184,
        116776
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "=Lista \"{{ $('Lista Crear Nombre').first().json.nombre_lista }}\" creada.\n\nEscribe un item para agregar:\n\n0. Terminar\n9. Cancelar",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "62832f7b-f61c-425d-afe4-b61389eb2aa1",
      "name": "Send Lista Paso 2",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108960,
        116776
      ],
      "webhookId": "4dc0043c-a2d6-492f-80b3-b556c61f5eb7",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "lista_crear_2",
            "paso_actual": "2",
            "datos_parciales": "={{ JSON.stringify({id_lista: $('Lista Crear Nombre').first().json.id_lista, nombre_lista: $('Lista Crear Nombre').first().json.nombre_lista, items_count: $('Lista Crear Nombre').first().json.items_count}) }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "266d94fb-f426-4b2c-bef9-862c50dbc5d1",
      "name": "Update Lista Paso 2",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108736,
        116776
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const mensaje = String($('Set Variables').first().json.mensaje).trim();\nconst datos = JSON.parse($('Merge Session Data').first().json.datos_parciales || '{}');\n\nif (mensaje === '9') { return [{json: {action: 'cancel'}}]; }\nif (mensaje === '0') { return [{json: {action: 'terminar', nombre_lista: datos.nombre_lista, items_count: datos.items_count || 0}}]; }\n\nconst id_item = 'ITEM-' + Date.now();\nreturn [{json: {action: 'agregar', id_item: id_item, id_lista: datos.id_lista, item: mensaje, nombre_lista: datos.nombre_lista, items_count: (datos.items_count || 0) + 1}}];"
      },
      "id": "915b2015-a55f-4d2d-b7b6-20dee67124fb",
      "name": "Lista Agregar Item",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109632,
        115720
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "agregar",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "agregar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "terminar",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "terminar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "cancel",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cancel"
            }
          ]
        },
        "options": {
          "fallbackOutput": "none"
        }
      },
      "id": "900be748-cfb0-4e33-98fe-6c444d7a20cc",
      "name": "Lista Action Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -109408,
        115704
      ]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 913068970,
          "cachedResultName": "ITEMS_LISTA"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id_item": "={{ $json.id_item }}",
            "id_lista": "={{ $json.id_lista }}",
            "item": "={{ $json.item }}",
            "estado": "pendiente"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "id_item",
              "displayName": "id_item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "id_lista",
              "displayName": "id_lista",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "item",
              "displayName": "item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "estado",
              "displayName": "estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "c2681ccd-b024-4809-970b-287fba9e9ee3",
      "name": "Insert Item Lista",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109184,
        115624
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "=âœ“ Item agregado: {{ $('Lista Agregar Item').first().json.item }}\n\nEscribe otro item:\n\n0. Terminar\n9. Cancelar",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "07f9d0a0-c302-425a-b8eb-233bdf0ed02a",
      "name": "Send Item Agregado Loop",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108960,
        115624
      ],
      "webhookId": "a1593d02-70dd-45a0-9a8d-2dc0d8a2f6ac",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "lista_crear_2",
            "paso_actual": "2",
            "datos_parciales": "={{ JSON.stringify({id_lista: $('Lista Agregar Item').first().json.id_lista, nombre_lista: $('Lista Agregar Item').first().json.nombre_lista, items_count: $('Lista Agregar Item').first().json.items_count}) }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "5787823a-858b-42f9-9ecb-d1045bf0ebf7",
      "name": "Update Session Item Loop",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108736,
        115624
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "=âœ… Lista \"{{ $json.nombre_lista }}\" creada con {{ $json.items_count }} items.\n\nVolviendo al menÃº",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "77b60b8d-dc19-497b-9072-b717533e3e5f",
      "name": "Send Lista Creada",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        115816
      ],
      "webhookId": "2b989aff-f25b-4c8a-a8e7-fd05db685f54",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 704259980,
          "cachedResultName": "LISTAS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=704259980"
        },
        "options": {}
      },
      "id": "566807fa-9a34-481d-8c61-746acfb41200",
      "name": "Get Listas Usuario",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109632,
        118648
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst telegramUser = String($('Set Variables').first().json.telegram_user);\nconst filtered = items.filter(i => String(i.json.creado_por) === telegramUser);\nif (!filtered.length) {\n  return [{json: {mensaje: 'MIS LISTAS\\n\\nNo tienes listas creadas.\\n\\n9. Volver', list: []}}];\n}\nlet t = 'MIS LISTAS\\n\\n';\nlet list = [];\nfor (let i = 0; i < filtered.length; i++) {\n  t += (i+1) + '. ' + filtered[i].json.nombre_lista + '\\n';\n  list.push({id_lista: filtered[i].json.id_lista, nombre_lista: filtered[i].json.nombre_lista});\n}\nt += '\\n9. Volver';\nreturn [{json: {mensaje: t, list: list}}];"
      },
      "id": "181461e6-7e3c-4e00-a705-8c9e68b4492f",
      "name": "Format Listas Usuario",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109408,
        118648
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $json.mensaje }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "2b838619-e5fc-4252-8f4a-b25fbc38e5ae",
      "name": "Send Listas Usuario",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        118648
      ],
      "webhookId": "c660296e-0b1e-4b53-8d22-e462b893e9f7",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "ver_listas",
            "paso_actual": "1",
            "datos_parciales": "={{ JSON.stringify($('Format Listas Usuario').first().json.list) }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "3962af3d-7a1c-472f-b0af-07b99287e852",
      "name": "Update Session Ver Listas",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108960,
        118648
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const mensaje = String($('Set Variables').first().json.mensaje).trim();\nconst listJson = $('Merge Session Data').first().json.datos_parciales || '[]';\nlet list = [];\ntry { list = JSON.parse(listJson); if (!Array.isArray(list)) list = []; } catch(e) { list = []; }\n\nif (mensaje === '9') { return [{json: {valid: false, cancel: true}}]; }\n\nconst index = parseInt(mensaje);\nif (isNaN(index) || index < 1 || index > list.length || !list[index - 1]) {\n  return [{json: {valid: false, cancel: false, error: 'Seleccion no valida.'}}];\n}\n\nconst selected = list[index - 1];\nreturn [{json: {valid: true, id_lista: selected.id_lista, nombre_lista: selected.nombre_lista}}];"
      },
      "id": "ae4e8622-6b89-4c0c-8b7d-5e5b05c2735f",
      "name": "Logic Seleccion Lista",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109856,
        119224
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ba5ec28f-43ca-4ac3-8e5e-8e5b6bb128f7",
      "name": "If Valid Lista",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109632,
        119224
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.cancel }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "5faec08e-d328-4cd9-aa9c-380653dffe87",
      "name": "If Cancel Ver Listas",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109408,
        119368
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $('Logic Seleccion Lista').first().json.error }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "93de153d-802f-4e64-8181-e411f3436d25",
      "name": "Send Error Ver Listas",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        119448
      ],
      "webhookId": "e7976afb-458a-48a0-8102-0ecb4a7be427",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 913068970,
          "cachedResultName": "ITEMS_LISTA",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=913068970"
        },
        "options": {}
      },
      "id": "a713158d-9e4d-4719-865e-a3b6bb099085",
      "name": "Get Items Lista",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108960,
        116352
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst datos = JSON.parse($('Merge Session Data').first().json.datos_parciales || '{}');\n\n// Try to get id_lista and nombre_lista from multiple sources\nlet id_lista, nombre_lista;\ntry { id_lista = $('Logic Seleccion Lista').first().json.id_lista; nombre_lista = $('Logic Seleccion Lista').first().json.nombre_lista; } catch(e) {}\nif (!id_lista) { try { id_lista = $('Logic Agregar Item').first().json.id_lista; nombre_lista = $('Logic Agregar Item').first().json.nombre_lista; } catch(e) {} }\nif (!id_lista) { try { id_lista = $('Logic Seleccion Completar Item').first().json.id_lista; nombre_lista = $('Logic Seleccion Completar Item').first().json.nombre_lista; } catch(e) {} }\nif (!id_lista) { try { id_lista = $('Logic Seleccion Eliminar Item').first().json.id_lista; nombre_lista = $('Logic Seleccion Eliminar Item').first().json.nombre_lista; } catch(e) {} }\nif (!id_lista) { id_lista = datos.id_lista; nombre_lista = datos.nombre_lista; }\nid_lista = String(id_lista || '');\nnombre_lista = nombre_lista || 'Lista';\n\nlet filteredItems = items.filter(i => String(i.json.id_lista) === id_lista && (i.json.estado === 'pendiente' || i.json.estado === 'completado'));\n\nif (!filteredItems.length) {\n  return [{json: {mensaje: nombre_lista.toUpperCase() + '\\n\\n(Sin items)\\n\\n1. Agregar item\\n9. Volver', list: [], id_lista: id_lista, nombre_lista: nombre_lista}}];\n}\n\nlet t = nombre_lista.toUpperCase() + '\\n\\n';\nlet list = [];\nfor (let i = 0; i < filteredItems.length; i++) {\n  const check = filteredItems[i].json.estado === 'completado' ? 'â˜‘' : 'â˜';\n  t += check + ' ' + filteredItems[i].json.item + '\\n';\n  list.push({id_item: filteredItems[i].json.id_item, item: filteredItems[i].json.item, estado: filteredItems[i].json.estado});\n}\nt += '\\n1. Agregar item\\n2. Marcar completado\\n3. Eliminar item\\n9. Volver';\nreturn [{json: {mensaje: t, list: list, id_lista: id_lista, nombre_lista: nombre_lista}}];"
      },
      "id": "23dfef04-6905-4595-9457-3e6204f7742f",
      "name": "Format Items Lista",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -108736,
        116352
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $json.mensaje }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "e79b18d1-e616-44c9-90c3-de2d5df1880f",
      "name": "Send Items Lista",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108512,
        116352
      ],
      "webhookId": "9ee67143-a325-411c-8172-ac32e764045d",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "items_lista",
            "paso_actual": "1",
            "datos_parciales": "={{ JSON.stringify({id_lista: $('Format Items Lista').first().json.id_lista, nombre_lista: $('Format Items Lista').first().json.nombre_lista, list: $('Format Items Lista').first().json.list}) }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "9e02ed78-6476-486f-adcc-7f068caa80c8",
      "name": "Update Session Items Lista",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108288,
        116352
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "agregar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "completar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "3",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "eliminar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "volver"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "7bec1835-0c6e-4386-9077-8816f9f110ca",
      "name": "Items Lista Menu Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -109856,
        118408
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "Escribe el item a agregar:\n\n9. Cancelar",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "d732c81d-b785-4fbf-94d3-3872fb7c497a",
      "name": "Send Agregar Item",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109632,
        118264
      ],
      "webhookId": "c1c6dddf-ebb8-4e83-87ce-014de57d0b7c",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "items_agregar",
            "paso_actual": "1",
            "datos_parciales": "={{ $('Merge Session Data').first().json.datos_parciales }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "8727fbfd-a406-4c8a-94db-811bae1dd1b5",
      "name": "Update Session Agregar Item",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109408,
        118264
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const mensaje = String($('Set Variables').first().json.mensaje).trim();\nconst datos = JSON.parse($('Merge Session Data').first().json.datos_parciales || '{}');\n\nif (mensaje === '9') { return [{json: {cancel: true, id_lista: datos.id_lista, nombre_lista: datos.nombre_lista}}]; }\n\nconst id_item = 'ITEM-' + Date.now();\nreturn [{json: {cancel: false, id_item: id_item, id_lista: datos.id_lista, item: mensaje, nombre_lista: datos.nombre_lista}}];"
      },
      "id": "08c47b5f-581d-4a82-9fc1-60bfac0dee08",
      "name": "Logic Agregar Item",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109856,
        116200
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.cancel }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "62025457-31e0-41e6-9005-0991ea9863cd",
      "name": "If Cancel Agregar Item",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109632,
        116200
      ]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 913068970,
          "cachedResultName": "ITEMS_LISTA"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id_item": "={{ $json.id_item }}",
            "id_lista": "={{ $json.id_lista }}",
            "item": "={{ $json.item }}",
            "estado": "pendiente"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "id_item",
              "displayName": "id_item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "id_lista",
              "displayName": "id_lista",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "item",
              "displayName": "item",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "estado",
              "displayName": "estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "ff43d9c2-41bd-49ef-ae33-46773d422d2e",
      "name": "Insert Item",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109408,
        116200
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "=âœ“ Item agregado: {{ $('Logic Agregar Item').first().json.item }}\n\nVolviendo a la lista...",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "538d295e-836d-4fa2-8ca8-78ea57caab78",
      "name": "Send Item Agregado",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        116200
      ],
      "webhookId": "89370c29-7b2f-4cfa-b364-05dfc2e97207",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const datos = JSON.parse($('Merge Session Data').first().json.datos_parciales || '{}');\nconst list = datos.list || [];\nconst pendientes = list.filter(i => i.estado === 'pendiente');\n\nif (!pendientes.length) {\n  return [{json: {mensaje: 'MARCAR COMPLETADO\\n\\nNo hay items pendientes.\\n\\n9. Volver', list: []}}];\n}\n\nlet t = 'MARCAR COMPLETADO\\n\\nSelecciona el item:\\n\\n';\nfor (let i = 0; i < pendientes.length; i++) {\n  t += (i+1) + '. ' + pendientes[i].item + '\\n';\n}\nt += '\\n9. Volver';\nreturn [{json: {mensaje: t, list: pendientes}}];"
      },
      "id": "06fe73d1-a009-4619-82de-42deea2e05c1",
      "name": "Format Items Completar",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109632,
        118456
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $json.mensaje }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "aa65c9b5-b1bf-457d-a4b6-739543c6fd22",
      "name": "Send Items Completar",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109408,
        118456
      ],
      "webhookId": "900d06c0-dde1-4871-9e83-2f8a93fe3dfa",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "items_completar_1",
            "paso_actual": "1",
            "datos_parciales": "={{ JSON.stringify({id_lista: JSON.parse($('Merge Session Data').first().json.datos_parciales || '{}').id_lista, nombre_lista: JSON.parse($('Merge Session Data').first().json.datos_parciales || '{}').nombre_lista, list: $('Format Items Completar').first().json.list}) }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "8994ea5c-5963-4eee-9ac6-71e4d0936d2b",
      "name": "Update Session Completar",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109184,
        118456
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const mensaje = String($('Set Variables').first().json.mensaje).trim();\nconst datos = JSON.parse($('Merge Session Data').first().json.datos_parciales || '{}');\nconst list = datos.list || [];\n\nif (mensaje === '9') { return [{json: {valid: false, cancel: true, id_lista: datos.id_lista, nombre_lista: datos.nombre_lista}}]; }\n\nconst index = parseInt(mensaje);\nif (isNaN(index) || index < 1 || index > list.length) {\n  return [{json: {valid: false, cancel: false, error: 'Seleccion no valida.', id_lista: datos.id_lista, nombre_lista: datos.nombre_lista}}];\n}\n\nconst selected = list[index - 1];\nreturn [{json: {valid: true, id_item: selected.id_item, item: selected.item, id_lista: datos.id_lista, nombre_lista: datos.nombre_lista}}];"
      },
      "id": "785408bd-f90b-4fcd-8433-aeb5ddaf79fe",
      "name": "Logic Seleccion Completar Item",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109856,
        117400
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "9a88f4e9-e564-41a4-a40f-9db80fee9fa0",
      "name": "If Valid Completar Item",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109632,
        117400
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 913068970,
          "cachedResultName": "ITEMS_LISTA"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id_item": "={{ $json.id_item }}",
            "estado": "completado"
          },
          "matchingColumns": [
            "id_item"
          ],
          "schema": [
            {
              "id": "id_item",
              "displayName": "id_item",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "estado",
              "displayName": "estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "341519de-57bb-4339-9dcc-733f5e43c76f",
      "name": "Update Item Completado",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109408,
        117400
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "=â˜‘ Item completado: {{ $('Logic Seleccion Completar Item').first().json.item }}\n\nVolviendo a la lista...",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "d516382f-35e9-428c-a711-3f8cfd96afc7",
      "name": "Send Item Completado",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        117400
      ],
      "webhookId": "13af50b0-5491-4a0f-b530-91eebe89508f",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.cancel }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "02d47baf-172b-4ce7-ae11-46724b8eceec",
      "name": "If Cancel Completar Item",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109184,
        117592
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $('Logic Seleccion Completar Item').first().json.error }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "b1492173-b785-4527-962a-b97bdda61955",
      "name": "Send Error Completar Item",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108960,
        117688
      ],
      "webhookId": "4a6cc94f-bdf1-46d1-990f-522cb6d14da2",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const datos = JSON.parse($('Merge Session Data').first().json.datos_parciales || '{}');\nconst list = datos.list || [];\n\nif (!list.length) {\n  return [{json: {mensaje: 'ELIMINAR ITEM\\n\\nNo hay items para eliminar.\\n\\n9. Volver', list: []}}];\n}\n\nlet t = 'ELIMINAR ITEM\\n\\nSelecciona el item:\\n\\n';\nfor (let i = 0; i < list.length; i++) {\n  t += (i+1) + '. ' + list[i].item + '\\n';\n}\nt += '\\n9. Volver';\nreturn [{json: {mensaje: t, list: list}}];"
      },
      "id": "0aaf2d3d-73ac-4475-a599-75acc2eb316b",
      "name": "Format Items Eliminar",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109632,
        118840
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $json.mensaje }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "652d44cb-89af-4a6d-9edb-bfcdc4162392",
      "name": "Send Items Eliminar",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109408,
        118840
      ],
      "webhookId": "1a93bd32-9bac-4651-9ab0-62afefbd1393",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "items_eliminar_1",
            "paso_actual": "1",
            "datos_parciales": "={{ JSON.stringify({id_lista: JSON.parse($('Merge Session Data').first().json.datos_parciales || '{}').id_lista, nombre_lista: JSON.parse($('Merge Session Data').first().json.datos_parciales || '{}').nombre_lista, list: $('Format Items Eliminar').first().json.list}) }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "61c46f6b-3cf0-4965-bb0f-64347ed0f49f",
      "name": "Update Session Eliminar",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109184,
        118840
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const mensaje = String($('Set Variables').first().json.mensaje).trim();\nconst datos = JSON.parse($('Merge Session Data').first().json.datos_parciales || '{}');\nconst list = datos.list || [];\n\nif (mensaje === '9') { return [{json: {valid: false, cancel: true, id_lista: datos.id_lista, nombre_lista: datos.nombre_lista}}]; }\n\nconst index = parseInt(mensaje);\nif (isNaN(index) || index < 1 || index > list.length) {\n  return [{json: {valid: false, cancel: false, error: 'Seleccion no valida.', id_lista: datos.id_lista, nombre_lista: datos.nombre_lista}}];\n}\n\nconst selected = list[index - 1];\nreturn [{json: {valid: true, id_item: selected.id_item, item: selected.item, id_lista: datos.id_lista, nombre_lista: datos.nombre_lista}}];"
      },
      "id": "11db6a54-d82f-4909-904c-e5b6c3773570",
      "name": "Logic Seleccion Eliminar Item",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109856,
        120136
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "4282fc1f-d1cd-4758-a0f6-4f8c4096ae7a",
      "name": "If Valid Eliminar Item",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109632,
        120136
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 913068970,
          "cachedResultName": "ITEMS_LISTA"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id_item": "={{ $json.id_item }}",
            "estado": "eliminado"
          },
          "matchingColumns": [
            "id_item"
          ],
          "schema": [
            {
              "id": "id_item",
              "displayName": "id_item",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "estado",
              "displayName": "estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "5ad5d14f-bf76-4f1a-83b3-5b31dc02581c",
      "name": "Update Item Eliminado",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109408,
        120024
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "=ðŸ—‘ Item eliminado: {{ $('Logic Seleccion Eliminar Item').first().json.item }}\n\nVolviendo a la lista...",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "27d91124-a866-4639-b76e-88f877c1f19f",
      "name": "Send Item Eliminado",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        120024
      ],
      "webhookId": "7bb3cae8-4663-45e3-838a-f5987570c2b2",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.cancel }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "c47d571f-7d1a-4b42-8249-e1866c6fd869",
      "name": "If Cancel Eliminar Item",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109184,
        120232
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $('Logic Seleccion Eliminar Item').first().json.error }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "6e72de9f-ea93-4a17-9cee-055351864b1b",
      "name": "Send Error Eliminar Item",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108960,
        120280
      ],
      "webhookId": "61906e06-d883-49d4-9c4b-de50adfd9ba3",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "Opcion no valida en Listas.",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "36dfebe7-f7ef-4742-a434-8b5a3033c27c",
      "name": "Send Invalid Listas",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109632,
        119928
      ],
      "webhookId": "18e51f63-0ab2-473e-9224-8b44864364f2",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "Opcion no valida.",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "a349ea27-0c0c-4fa7-84f1-7fd492dda6af",
      "name": "Send Invalid Items Lista",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109632,
        119032
      ],
      "webhookId": "4bc8b1cd-d153-47b3-9e27-9934f5d73768",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "ðŸ“Š REPORTES\n\n1. Resumen del dÃ­a\n2. Resumen semanal\n3. Productividad\n9. Volver",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "3a9a9e9a-4975-4920-bee3-05f07576f3c0",
      "name": "Send Reportes Menu",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109408,
        122296
      ],
      "webhookId": "44b9fd01-c18f-4118-8896-f052638f35cf",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "reportes_menu",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "ce2fd4ee-66c0-4792-a64f-b0640a2ed17b",
      "name": "Update to Reportes",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109184,
        122296
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "CONFIG\n\n1. Zona horaria\n2. Recordatorios on/off\n3. Mi info\n9. Volver",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "4b9ce25e-0efa-4766-8040-36000513871c",
      "name": "Send Config Menu",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109408,
        122488
      ],
      "webhookId": "feff8cb3-3df3-44f4-81b7-51cf70a0d814",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "config_menu",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "e942ee48-dfd9-4a9d-8fef-97e56edfad6a",
      "name": "Update to Config",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109184,
        122488
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "ADMIN\n\n1. Usuarios\n2. Agregar\n3. Bloquear\n4. Logs\n5. Exportar\n9. Volver",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "3159739c-753e-41bf-aadc-d3b4efc42b65",
      "name": "Send Admin Menu",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108960,
        122296
      ],
      "webhookId": "30c27c63-1d53-4420-bc9f-d0e7458fc9f8",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "admin_menu",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "cebab116-cce7-4a7d-9bd8-e446f7038268",
      "name": "Update to Admin",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108736,
        122296
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "={{ $json.pantalla === 'menu_principal' ? 'Opcion no valida. Escribe 0-6.\\n\\nMENU\\n0. Ayuda\\n1. Agenda\\n2. Tareas\\n3. Recordatorios\\n4. Habitos\\n5. Listas\\n6. Reportes' : 'Opcion no valida. Presiona \"9\" para ir al menÃº principal.' }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "919d4296-86d3-4e91-9432-03eed1dd0d89",
      "name": "Send Invalid Option",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109408,
        122680
      ],
      "webhookId": "65fa2ff9-5e6c-4c68-8883-e1ac385a2597",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "MENU\n0. Ayuda\n1. Agenda\n2. Tareas\n3. Recordatorios\n4. Habitos\n5. Listas\n6. Reportes",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "ac102733-db2b-47de-b4f2-01fda45e6533",
      "name": "Send Menu Principal",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -107616,
        116072
      ],
      "webhookId": "45631ab8-208d-4386-bd31-3c9222a55563",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "ayuda_menu",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "e4d38b3b-eecb-4e6a-b726-23c54be3fdd1",
      "name": "Update to Ayuda",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109184,
        121144
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "volver"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "cf353753-a2c0-49ce-a3b7-e09f15d20bf0",
      "name": "Ayuda Menu Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -109632,
        122872
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "menu_principal",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "5361299e-99be-403e-aa63-6e4e187e35eb",
      "name": "Update Volver Menu",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -107392,
        116264
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear_cita"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "3",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reprogramar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "4",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cancelar_cita"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "5",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "completar_cita"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "volver"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "0e372374-bfb2-482d-b8ad-3e7b4b502574",
      "name": "Agenda Menu Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -109632,
        124168
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "CREAR CITA - Paso 1/6\n\nFecha? (YYYY-MM-DD)\nEj: 2025-12-20\n\n9. Cancelar",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "6fd16f7f-2d4f-460e-8b52-957d34b2b6a3",
      "name": "Send Agenda Paso 1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109408,
        123736
      ],
      "webhookId": "4d888603-60fe-40d4-a4a4-166e31b410e5",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "agenda_crear_paso_1",
            "paso_actual": "1",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "f0a8ac65-a983-4945-933d-44fb2522ce3a",
      "name": "Update Agenda Paso 1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109184,
        123736
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 0,
          "cachedResultName": "CITAS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "creado_por",
              "lookupValue": "={{ $('Set Variables').item.json.telegram_user }}"
            },
            {
              "lookupColumn": "estado",
              "lookupValue": "pendiente"
            }
          ]
        },
        "options": {}
      },
      "id": "9dcb18d2-e424-4da1-ba52-786583b25787",
      "name": "Get Citas Usuario",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109408,
        123928
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $json.mensaje }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "3a01a2c1-0798-41b3-a981-00acdfae9590",
      "name": "Send Consultar Citas",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108960,
        123928
      ],
      "webhookId": "1952b1bd-5052-4cc8-961f-42e179c4571a",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "consultar_citas",
            "paso_actual": "1",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "b8783589-0033-47e6-a0ae-f733e1152965",
      "name": "Update Session Consultar",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108736,
        123928
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').first().json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "volver"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "8b3c179a-5f96-4601-a32f-13b55d7bd8cc",
      "name": "Consultar Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -109632,
        123400
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "Opcion no valida. Presiona 9 para volver al menu de agenda.",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "e1b02e27-ce40-4207-9706-b9e72f4e21e5",
      "name": "Send Invalid Consultar",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109408,
        123448
      ],
      "webhookId": "c747125c-8ace-4b01-9bd6-7cd441d013d3",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nif (!items.length || !items[0].json.fecha) {\n  return [{json:{mensaje:'TUS CITAS:\\n\\nNo tienes citas pendientes.\\n\\n9. Volver'}}];\n}\nlet t = 'TUS CITAS:\\n\\n';\nfor (let i = 0; i < items.length; i++) {\n  t += (i+1)+'. '+items[i].json.fecha+' '+items[i].json.hora+' - '+items[i].json.nombre+'\\n';\n}\nreturn [{json:{mensaje:t+'\\n9. Volver'}}];"
      },
      "id": "1e297c42-6fe0-4533-8498-46c8fd231602",
      "name": "Format Citas Lista",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109184,
        123928
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Opcion no valida. Presiona 9 para ir al menÃº principal.",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "ad77f6a3-ccd8-4765-a721-865d0bc589fd",
      "name": "Send Invalid Agenda",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109408,
        124120
      ],
      "webhookId": "6f9d5ea2-acb6-42b6-a022-387d52c3be48",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Esta funcion esta en desarrollo.\n\n9. Volver al menu principal",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "240f4607-610a-47ec-8e4f-2acf58530462",
      "name": "Send En Desarrollo",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -111648,
        132784
      ],
      "webhookId": "fdb05f31-c445-4660-b66f-2a8bc5b39d90",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "agenda_crear_paso_1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "paso1"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "agenda_crear_paso_2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "paso2"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "agenda_crear_paso_3",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "paso3"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "agenda_crear_paso_4",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "paso4"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "agenda_crear_paso_5",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "paso5"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "agenda_crear_paso_6",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "paso6"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "d9f33dd0-1831-476e-8c1b-fd3340ff7520",
      "name": "Agenda Wizard Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -109856,
        125624
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
              "rightValue": "9",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "99b9c39e-5c74-47a2-9fd5-eea3b8c834dd",
      "name": "Cancelar?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109632,
        125240
      ]
    },
    {
      "parameters": {
        "jsCode": "const fecha = $('Set Variables').first().json.mensaje;\nconst regex = /^\\d{4}-\\d{2}-\\d{2}$/;\n\nif (!regex.test(fecha)) {\n  return { json: { valid: false, error: 'Formato incorrecto. Usa YYYY-MM-DD', fecha } };\n}\n\nconst fechaIngresada = new Date(fecha + 'T00:00:00');\nconst hoy = new Date();\nhoy.setHours(0, 0, 0, 0);\n\nif (fechaIngresada < hoy) {\n  return { json: { valid: false, error: 'No puedes agendar en una fecha pasada.', fecha } };\n}\n\nreturn { json: { valid: true, fecha } };"
      },
      "id": "433fa967-9a77-4ed5-8ba2-263aa060f652",
      "name": "Validar Fecha",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109408,
        125288
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "84712d79-a075-4447-8745-d39a6d5af61f",
      "name": "If Fecha Valida",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109184,
        125288
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ fecha: $('Validar Fecha').first().json.fecha }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "9ee5981f-8b1a-48c5-a72b-21f3f8c8c6e4",
      "name": "Set Fecha",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -108960,
        125080
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Paso 2/6 - Hora? (HH:MM)\nEj: 14:30\n\n9. Cancelar",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "540b4b28-2445-4883-9b5a-c2d9f8f53cb9",
      "name": "Send Paso 2",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108512,
        125080
      ],
      "webhookId": "3d76f4b0-6f25-4756-870d-31c32026135c",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "agenda_crear_paso_2",
            "paso_actual": "2",
            "datos_parciales": "={{ $json.datos_parciales }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "7f579386-74b2-4da0-a3d9-e4d48ce2e07c",
      "name": "Update Paso 2",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108736,
        125080
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $('Validar Fecha').first().json.error }}\n\n9. Cancelar",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "939f46ae-0b31-4724-a7ed-fc6b2c134ab7",
      "name": "Error Fecha",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108960,
        125384
      ],
      "webhookId": "54a4fb6c-28d6-4844-8d32-e72234220063",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
              "rightValue": "9",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "dca87b2b-d955-4d83-bba5-b6a16da78f25",
      "name": "Cancelar 2?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109632,
        125624
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
              "rightValue": "^\\d{2}:\\d{2}$",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "4cc27b96-e6d1-43e2-8133-c20bdf1cc0fc",
      "name": "Validar Hora",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109408,
        125672
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ ...JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}'), hora: $('Set Variables').item.json.mensaje }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "ceeef359-a632-4132-8a20-5fc6dfd47a59",
      "name": "Set Hora",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -109184,
        125576
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Paso 3/6 - Nombre cliente?\n\n9. Cancelar",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "b9da0a8c-62bb-49a6-8b50-6188cc0ca5d5",
      "name": "Send Paso 3",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108736,
        125576
      ],
      "webhookId": "c40e0757-23e2-4dba-a99c-f0e157b4c9d3",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "agenda_crear_paso_3",
            "paso_actual": "3",
            "datos_parciales": "={{ $json.datos_parciales }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "2e7da7bd-39dd-4b8a-9962-6b95a1e10696",
      "name": "Update Paso 3",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108960,
        125576
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Formato incorrecto. Usa HH:MM\n\n9. Cancelar",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "7142161c-72ab-42ee-aeda-22e49ec387fb",
      "name": "Error Hora",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        125768
      ],
      "webhookId": "10302139-a3a5-47f0-b855-4bef2988b9ba",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
              "rightValue": "9",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "5f1c302f-8965-4d69-8557-f7c248368f26",
      "name": "Cancelar 3?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109632,
        125912
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ ...JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}'), nombre: $('Set Variables').item.json.mensaje }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "11f28a88-318b-4c5d-bf4a-c311dd0cb10c",
      "name": "Set Nombre",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -109408,
        125960
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Paso 4/6 - Motivo?\n\n9. Cancelar",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "a29a581c-3a7b-438c-97ff-784c3a42a510",
      "name": "Send Paso 4",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108960,
        125960
      ],
      "webhookId": "529d9a9d-eb7b-401a-8fbf-56bd175e5eb0",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "agenda_crear_paso_4",
            "paso_actual": "4",
            "datos_parciales": "={{ $json.datos_parciales }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "e40b88a8-d897-4c60-95d4-c4b1cf988b1a",
      "name": "Update Paso 4",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109184,
        125960
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
              "rightValue": "9",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "74253753-a0bc-421f-82bd-9faaa7da9d5c",
      "name": "Cancelar 4?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109632,
        126104
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ ...JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}'), motivo: $('Set Variables').item.json.mensaje }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "f44635ec-3852-4791-913e-6f0767981de9",
      "name": "Set Motivo",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -109408,
        126152
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Paso 5/6 - Canal?\n\n1. Presencial\n2. Virtual\n3. Llamada\n9. Cancelar",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "bb9f3d7b-b7d9-4061-9d83-8ac8853b975f",
      "name": "Send Paso 5",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108960,
        126152
      ],
      "webhookId": "0de5a313-d9ea-4d93-a1fe-00ad758d9464",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "agenda_crear_paso_5",
            "paso_actual": "5",
            "datos_parciales": "={{ $json.datos_parciales }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "20b38718-6be9-4d1e-b03b-d6d52070de41",
      "name": "Update Paso 5",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109184,
        126152
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "presencial"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "virtual"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "3",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "llamada"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cancelar"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "09e1185e-f9b1-4837-84ab-200f24af2fd0",
      "name": "Canal Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -109632,
        126584
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ ...JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}'), canal: 'Presencial' }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "decc5014-4a65-4c2b-b785-f02a70947275",
      "name": "Set Presencial",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -109408,
        126440
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ ...JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}'), canal: 'Virtual' }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "58c3a604-cf07-4ec1-ac8c-261b1bf8b06e",
      "name": "Set Virtual",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -109408,
        126632
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ ...JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}'), canal: 'Llamada' }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "60818ab8-5780-4262-8880-0be383f57eea",
      "name": "Set Llamada",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -109408,
        126824
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "=Paso 6/6 - CONFIRMAR:\n\n{{ (() => { try { const d = JSON.parse($json.datos_parciales || '{}'); return 'Fecha: ' + d.fecha + '\\nHora: ' + d.hora + '\\nCliente: ' + d.nombre + '\\nMotivo: ' + d.motivo + '\\nCanal: ' + d.canal; } catch(e) { return 'Error: ' + e.message; } })() }}\n\n1. Confirmar\n2. Editar\n3. Cancelar",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "12870609-0abc-473a-8934-bd63b0111719",
      "name": "Send Paso 6",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108960,
        126536
      ],
      "webhookId": "794d2796-36be-421d-a174-2eb212240e6b",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "agenda_crear_paso_6",
            "paso_actual": "6",
            "datos_parciales": "={{ $json.datos_parciales }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "82002522-fd21-488a-bf1f-ec3ba8476899",
      "name": "Update Paso 6",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109184,
        126536
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "confirmar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "editar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "3",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cancelar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cancelar"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "23d3aaa7-9785-4e4e-b555-8db6c14e01ff",
      "name": "Confirmar Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -109632,
        127064
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "id_cita",
              "value": "={{ 'CITA-' + Date.now() }}",
              "type": "string"
            },
            {
              "id": "2",
              "name": "fecha",
              "value": "={{ JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}').fecha }}",
              "type": "string"
            },
            {
              "id": "3",
              "name": "hora",
              "value": "={{ JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}').hora }}",
              "type": "string"
            },
            {
              "id": "4",
              "name": "nombre",
              "value": "={{ JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}').nombre }}",
              "type": "string"
            },
            {
              "id": "5",
              "name": "motivo",
              "value": "={{ JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}').motivo }}",
              "type": "string"
            },
            {
              "id": "6",
              "name": "canal",
              "value": "={{ JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}').canal }}",
              "type": "string"
            },
            {
              "id": "7",
              "name": "estado",
              "value": "pendiente",
              "type": "string"
            },
            {
              "id": "8",
              "name": "creado_por",
              "value": "={{ String($('Set Variables').item.json.telegram_user) }}",
              "type": "string"
            },
            {
              "id": "9",
              "name": "timestamp_creacion",
              "value": "={{ $('Set Variables').item.json.timestamp }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "fd4879de-0a42-4951-9fa1-1f0786025a9e",
      "name": "Parse Cita",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -109408,
        127208
      ]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "CITAS",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id_cita": "={{ $('Parse Cita').first().json.id_cita }}",
            "fecha": "={{ $('Parse Cita').first().json.fecha }}",
            "hora": "={{ $('Parse Cita').first().json.hora }}",
            "nombre": "={{ $('Parse Cita').first().json.nombre }}",
            "motivo": "={{ $('Parse Cita').first().json.motivo }}",
            "canal": "={{ $('Parse Cita').first().json.canal }}",
            "estado": "={{ $('Parse Cita').first().json.estado }}",
            "creado_por": "={{ $('Parse Cita').first().json.creado_por }}",
            "timestamp_creacion": "={{ $('Parse Cita').first().json.timestamp_creacion }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "id_cita",
              "displayName": "id_cita",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "fecha",
              "displayName": "fecha",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "hora",
              "displayName": "hora",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "nombre",
              "displayName": "nombre",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "motivo",
              "displayName": "motivo",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "canal",
              "displayName": "canal",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "estado",
              "displayName": "estado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "creado_por",
              "displayName": "creado_por",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "timestamp_creacion",
              "displayName": "timestamp_creacion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "a3390ec2-087e-4a56-afcf-dc06b9c0f711",
      "name": "Guardar Cita",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108736,
        127664
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "=CITA GUARDADA!\n\nID: {{ $('Parse Cita').item.json.id_cita }}\nFecha: {{ $('Parse Cita').item.json.fecha }}\nHora: {{ $('Parse Cita').item.json.hora }}\n\n(Regresando al menÃº principal...)",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "cb8d20cb-6702-4420-a019-89b5418d1a5e",
      "name": "Cita OK",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108288,
        127664
      ],
      "webhookId": "19d6e4db-a355-472d-95bf-8f8c23659a80",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "menu_principal",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "96707a16-3449-41f4-806b-5dffab87c36f",
      "name": "Update After Cita",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108512,
        127664
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "volver"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "515b047e-470c-47d2-a411-7317eff76e6a",
      "name": "Volver Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -109632,
        132560
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "pendientes"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "3",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "completadas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "4",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "completar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "5",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "eliminar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "volver"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "b02eecc8-01e6-4732-ba1d-6c1828be3420",
      "name": "Tareas Menu Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -109856,
        129256
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "CREAR TAREA\n\nEscribe el titulo de la tarea:\n\n9. Cancelar",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "e48e2304-344c-45db-b26d-df050427e354",
      "name": "Send Tarea Paso 1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109632,
        128664
      ],
      "webhookId": "71457b51-b827-48c3-8fa9-0a1e2c78fce4",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "tarea_crear_paso_1",
            "paso_actual": "1",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "333842a9-183f-4c76-a981-f919cb23efe1",
      "name": "Update Tarea Paso 1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109408,
        128664
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 37820303,
          "cachedResultName": "TAREAS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "creado_por",
              "lookupValue": "={{ $('Set Variables').item.json.telegram_user }}"
            },
            {
              "lookupColumn": "estado",
              "lookupValue": "pendiente"
            }
          ]
        },
        "options": {}
      },
      "id": "2728d624-d96c-4731-aac1-26579915a242",
      "name": "Get Tareas Pendientes",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109632,
        128856
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $json.mensaje }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "7c8833fe-a3c1-456f-953d-f1f08a0498d8",
      "name": "Send Tareas Pendientes",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        128856
      ],
      "webhookId": "d29a2c1f-43b1-462c-b19e-1186215e70bb",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nif (!items.length || !items[0].json.titulo) {\n  return [{json:{mensaje:'TAREAS PENDIENTES:\\n\\nNo tienes tareas pendientes.\\n\\n9. Volver'}}];\n}\nlet t = 'TAREAS PENDIENTES:\\n\\n';\nfor (let i = 0; i < items.length; i++) {\n  const fecha = items[i].json.fecha_objetivo ? ' - Fecha: ' + items[i].json.fecha_objetivo : '';\n  const prioridad = items[i].json.prioridad ? ' - Prioridad: ' + items[i].json.prioridad : '';\n  t += (i+1)+'. '+items[i].json.titulo + fecha + prioridad + '\\n';\n}\nreturn [{json:{mensaje:t+'\\n9. Volver'}}];"
      },
      "id": "821c97b2-baf5-4961-a97f-6605064e216c",
      "name": "Format Tareas Pendientes",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109408,
        128856
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "ver_tareas_pendientes",
            "paso_actual": "1",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "d614b07e-1ae4-49b3-b621-5cff44b72458",
      "name": "Update Session Ver Pendientes",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108960,
        128856
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').first().json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "volver"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "f6cfb24a-794b-44c9-b6a1-90cb918e23e0",
      "name": "Ver Pendientes Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -108288,
        128352
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "Opcion no valida. Presiona 9 para volver al menu de tareas.",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "8840626b-9654-4b8b-ab2e-455888933ee5",
      "name": "Send Invalid Ver Pendientes",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108064,
        129352
      ],
      "webhookId": "e7cfa643-d74d-49d5-9fe7-69d8ca22c99f",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 37820303,
          "cachedResultName": "TAREAS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "creado_por",
              "lookupValue": "={{ $('Set Variables').item.json.telegram_user }}"
            },
            {
              "lookupColumn": "estado",
              "lookupValue": "completada"
            }
          ]
        },
        "options": {}
      },
      "id": "bcfa6ebe-7be2-41e4-98a0-83ade35b4bdd",
      "name": "Get Tareas Completadas",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109632,
        129048
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $json.mensaje }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "5481474a-d2df-41e9-829a-fe245b837b0b",
      "name": "Send Tareas Completadas",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        129048
      ],
      "webhookId": "08961623-960e-4664-abe4-4c00ae10a5b4",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nif (!items.length || !items[0].json.titulo) {\n  return [{json:{mensaje:'TAREAS COMPLETADAS:\\n\\nNo tienes tareas completadas.\\n\\n9. Volver'}}];\n}\nlet t = 'TAREAS COMPLETADAS:\\n\\n';\nfor (let i = 0; i < items.length; i++) {\n  t += (i+1)+'. '+items[i].json.titulo + ' âœ“\\n';\n}\nreturn [{json:{mensaje:t+'\\n9. Volver'}}];"
      },
      "id": "910666c6-4016-44f4-9bff-15a8b3a317bf",
      "name": "Format Tareas Completadas",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109408,
        129048
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "ver_tareas_completadas",
            "paso_actual": "1",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "a40c6dfd-bfab-41f0-9542-831f1565c2ef",
      "name": "Update Session Ver Completadas",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108960,
        129048
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').first().json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "volver"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "d814b716-43b0-44fc-bf5c-fe9b1067ead7",
      "name": "Ver Completadas Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -108288,
        129808
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "Opcion no valida. Presiona 9 para volver al menu de tareas.",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "15e01aa9-cf00-457f-96bc-838b8dce008e",
      "name": "Send Invalid Ver Completadas",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108064,
        130168
      ],
      "webhookId": "3e620326-fe53-4e44-991e-bc94909e65da",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Esta funcion esta en desarrollo.\n\n9. Volver al menu principal",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "0d06b214-f98e-431b-b1f7-26c0b09c8480",
      "name": "Send Tarea En Desarrollo",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -111648,
        133008
      ],
      "webhookId": "5f139d57-31ed-407b-9997-28339f4dd806",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Opcion no valida. Presiona 9 para ir al menÃº principal.",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "1ab6cba3-eb50-465a-abb0-d95ad560c152",
      "name": "Send Invalid Tarea",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109632,
        129240
      ],
      "webhookId": "54979764-291d-4640-a20e-16d8717ced43",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 37820303,
          "cachedResultName": "TAREAS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "creado_por",
              "lookupValue": "={{ $('Set Variables').item.json.telegram_user }}"
            },
            {
              "lookupColumn": "estado",
              "lookupValue": "pendiente"
            }
          ]
        },
        "options": {}
      },
      "id": "c7fd2c14-3fc4-49a1-9360-4a39f9676ebe",
      "name": "Get Tareas Para Completar",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109632,
        129432
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nif (!items.length || !items[0].json.titulo) {\n  return [{json:{mensaje:'COMPLETAR TAREA:\\n\\nNo tienes tareas pendientes para completar.\\n\\n9. Volver', list: []}}];\n}\nlet t = 'COMPLETAR TAREA:\\n\\nSelecciona el numero de la tarea a completar:\\n\\n';\nconst list = [];\nfor (let i = 0; i < items.length; i++) {\n  const prioridad = items[i].json.prioridad ? ' - Prioridad: ' + items[i].json.prioridad : '';\n  t += (i+1)+'. '+items[i].json.titulo + prioridad + '\\n';\n  list.push({index: i+1, id_tarea: items[i].json.id_tarea, titulo: items[i].json.titulo});\n}\nreturn [{json:{mensaje:t+'\\n9. Volver', list: list}}];"
      },
      "id": "47223536-c43d-4061-b45f-2a50b94618a0",
      "name": "Format Lista Completar Tareas",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109408,
        129432
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $json.mensaje }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "72c4191d-ec56-4573-aedf-0f5313d8ced6",
      "name": "Send Lista Completar Tareas",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        129432
      ],
      "webhookId": "2fa3bef5-656e-4963-924e-f28e5ad1262d",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "tarea_completar_1",
            "paso_actual": "1",
            "datos_parciales": "={{ JSON.stringify($('Format Lista Completar Tareas').first().json.list) }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "b6d7d49d-2e23-4b35-947e-d419f039a480",
      "name": "Update Session Completar Tarea",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108960,
        129432
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const mensaje = $('Set Variables').first().json.mensaje;\nconst listJson = $('Merge Session Data').first().json.datos_parciales || '[]';\nlet list = [];\ntry {\n  list = JSON.parse(listJson);\n  if (!Array.isArray(list)) list = [];\n} catch(e) {\n  list = [];\n}\n\nif (mensaje === '9') {\n  return [{json: {valid: false, cancel: true}}];\n}\n\nconst index = parseInt(mensaje);\nif (isNaN(index) || index < 1 || index > list.length || !list[index - 1]) {\n  return [{json: {valid: false, cancel: false, error: 'Seleccion no valida. Escribe el numero de la tarea o 9 para volver.'}}];\n}\n\nconst selected = list[index - 1];\nreturn [{json: {valid: true, id_tarea: selected.id_tarea, titulo: selected.titulo}}];"
      },
      "id": "0ebb536d-37fa-4415-a95e-abc337e85c5b",
      "name": "Logic Seleccion Completar Tarea",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -108736,
        130336
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "41105f0a-a83e-405c-9592-80d07fd6a962",
      "name": "If Valid Completar Tarea",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -108512,
        130336
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 37820303,
          "cachedResultName": "TAREAS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id_tarea": "={{ $json.id_tarea }}",
            "estado": "completada"
          },
          "matchingColumns": [
            "id_tarea"
          ]
        },
        "options": {}
      },
      "id": "86a6cf5a-7139-4f7a-84e7-fbe9f8796078",
      "name": "Update Tarea Completada",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108288,
        130240
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "=âœ… Tarea completada: {{ $('Logic Seleccion Completar Tarea').first().json.titulo }}\n\n9. Volver al menu de tareas",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "4817dd6e-f8d2-4d57-81c3-a50b05280e1e",
      "name": "Send Tarea Completada",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108064,
        130552
      ],
      "webhookId": "7f331e41-8627-439b-90a5-924120da63d5",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.cancel }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "4d4797a2-77e8-40ba-b46b-a1dbc29d5c6e",
      "name": "If Cancel Completar Tarea",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -108288,
        130432
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $('Logic Seleccion Completar Tarea').first().json.error }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "224da8bd-28df-44e8-8641-fdbf14f0688d",
      "name": "Send Error Completar Tarea",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108064,
        130792
      ],
      "webhookId": "ed08f888-ef75-41eb-b524-8889a601f0e0",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "tarea_completada_confirm",
            "paso_actual": "1",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "1ef67fe0-8ac3-4a41-84ea-b8256a29517f",
      "name": "Update Session Tarea Completada",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -107840,
        130552
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').first().json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "volver"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "07db5869-efb4-417d-95cb-5eced08ff30c",
      "name": "Tarea Completada Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -108288,
        130000
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "Opcion no valida. Presiona 9 para volver al menu de tareas.",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "c76106d4-f2b2-4922-aa32-2b1af5a938b2",
      "name": "Send Invalid Tarea Completada",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108064,
        130360
      ],
      "webhookId": "05aa8380-3dad-4ee4-ab57-26f0e9150d8a",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 37820303,
          "cachedResultName": "TAREAS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "creado_por",
              "lookupValue": "={{ $('Set Variables').item.json.telegram_user }}"
            },
            {
              "lookupColumn": "estado",
              "lookupValue": "pendiente"
            }
          ]
        },
        "options": {}
      },
      "id": "0e1dc10e-d6f1-47c5-bda0-30091fcc8521",
      "name": "Get Tareas Para Eliminar",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109632,
        129624
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nif (!items.length || !items[0].json.titulo) {\n  return [{json:{mensaje:'ELIMINAR TAREA:\\n\\nNo tienes tareas pendientes para eliminar.\\n\\n9. Volver', list: []}}];\n}\nlet t = 'ELIMINAR TAREA:\\n\\nSelecciona el numero de la tarea a eliminar:\\n\\n';\nconst list = [];\nfor (let i = 0; i < items.length; i++) {\n  const prioridad = items[i].json.prioridad ? ' - Prioridad: ' + items[i].json.prioridad : '';\n  t += (i+1)+'. '+items[i].json.titulo + prioridad + '\\n';\n  list.push({index: i+1, id_tarea: items[i].json.id_tarea, titulo: items[i].json.titulo});\n}\nreturn [{json:{mensaje:t+'\\n9. Volver', list: list}}];"
      },
      "id": "da70286d-395a-4c01-84eb-a47f12c5b59f",
      "name": "Format Lista Eliminar Tareas",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109408,
        129624
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $json.mensaje }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "4384d6b0-84f1-45e4-aaa7-b528f1624cd6",
      "name": "Send Lista Eliminar Tareas",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        129624
      ],
      "webhookId": "ec27ffbc-6de2-48a4-920d-3613ca720028",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "tarea_eliminar_1",
            "paso_actual": "1",
            "datos_parciales": "={{ JSON.stringify($('Format Lista Eliminar Tareas').first().json.list) }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "c281ef6a-e166-4872-9773-2ce9bea2fdf2",
      "name": "Update Session Eliminar Tarea",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108960,
        129624
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const mensaje = $('Set Variables').first().json.mensaje;\nconst listJson = $('Merge Session Data').first().json.datos_parciales || '[]';\nlet list = [];\ntry {\n  list = JSON.parse(listJson);\n  if (!Array.isArray(list)) list = [];\n} catch(e) {\n  list = [];\n}\n\nif (mensaje === '9') {\n  return [{json: {valid: false, cancel: true}}];\n}\n\nconst index = parseInt(mensaje);\nif (isNaN(index) || index < 1 || index > list.length || !list[index - 1]) {\n  return [{json: {valid: false, cancel: false, error: 'Seleccion no valida. Escribe el numero de la tarea o 9 para volver.'}}];\n}\n\nconst selected = list[index - 1];\nreturn [{json: {valid: true, id_tarea: selected.id_tarea, titulo: selected.titulo}}];"
      },
      "id": "52630381-3ded-422f-83c2-6a4ed185045e",
      "name": "Logic Seleccion Eliminar Tarea",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -108736,
        132320
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "a4416d8f-4a25-421d-8990-8a82a6508ab5",
      "name": "If Valid Eliminar Tarea",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -108512,
        132320
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 37820303,
          "cachedResultName": "TAREAS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id_tarea": "={{ $json.id_tarea }}",
            "estado": "eliminada"
          },
          "matchingColumns": [
            "id_tarea"
          ]
        },
        "options": {}
      },
      "id": "721e27ef-6f10-44ff-8c87-c985f9dfbca5",
      "name": "Delete Tarea",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108288,
        132104
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "=ðŸ—‘ï¸ Tarea eliminada: {{ $('Logic Seleccion Eliminar Tarea').first().json.titulo }}\n\n9. Volver al menu de tareas",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "bdf14646-4533-4d36-9dd8-245330553173",
      "name": "Send Tarea Eliminada",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108064,
        132128
      ],
      "webhookId": "fc1e612a-e7f3-4796-9285-e38589bfd44e",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.cancel }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "0e945599-ce65-488e-97ac-43620de83773",
      "name": "If Cancel Eliminar Tarea",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -108288,
        132320
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $('Logic Seleccion Eliminar Tarea').first().json.error }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "487f4bbe-3ec1-4f88-a177-ecb083b803c5",
      "name": "Send Error Eliminar Tarea",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108064,
        132344
      ],
      "webhookId": "92a4a29a-d178-4955-8790-b35ab34ea261",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "tarea_eliminada_confirm",
            "paso_actual": "1",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "02ef8009-cf82-492d-814a-40935459f959",
      "name": "Update Session Tarea Eliminada",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -107840,
        132128
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').first().json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "volver"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "74c4b44a-abdf-4bae-b0df-27635ea24c7b",
      "name": "Tarea Eliminada Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -108288,
        131864
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "Opcion no valida. Presiona 9 para volver al menu de tareas.",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "a76c6cd4-d320-46a0-ab42-e41f8d23955b",
      "name": "Send Invalid Tarea Eliminada",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108064,
        131936
      ],
      "webhookId": "a529cdd3-2b82-4672-8b9b-20825891b52a",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "tarea_crear_paso_1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "paso1"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "tarea_crear_paso_2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "paso2"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "tarea_crear_paso_3",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "paso3"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "9e65355e-382c-4752-b2d2-d9d971784957",
      "name": "Tarea Wizard Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -109856,
        131184
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
              "rightValue": "9",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "60e6b0df-0e1a-4053-932f-5230aeca0125",
      "name": "Cancelar Tarea?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -108288,
        130624
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "id_tarea",
              "value": "={{ 'TAREA-' + Date.now() }}",
              "type": "string"
            },
            {
              "id": "2",
              "name": "titulo",
              "value": "={{ JSON.parse($json.datos_parciales || '{}').titulo || '' }}",
              "type": "string"
            },
            {
              "id": "3",
              "name": "prioridad",
              "value": "={{ JSON.parse($json.datos_parciales || '{}').prioridad || 'media' }}",
              "type": "string"
            },
            {
              "id": "4",
              "name": "estado",
              "value": "pendiente",
              "type": "string"
            },
            {
              "id": "5",
              "name": "fecha_objetivo",
              "value": "={{ JSON.parse($json.datos_parciales || '{}').fecha_objetivo || '' }}",
              "type": "string"
            },
            {
              "id": "6",
              "name": "creado_por",
              "value": "={{ $('Set Variables').item.json.telegram_user }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "13a58a2c-f31a-4ac7-ba95-122daccb1581",
      "name": "Parse Tarea",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -108960,
        131512
      ]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 37820303,
          "cachedResultName": "TAREAS"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {}
        },
        "options": {}
      },
      "id": "d3138632-dcf9-4d8c-82ef-51cccf5ab213",
      "name": "Guardar Tarea",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108736,
        131512
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "=TAREA CREADA!\n\nTitulo: {{ $('Parse Tarea').item.json.titulo }}\nPrioridad: {{ $('Parse Tarea').item.json.prioridad }}\nFecha: {{ $('Parse Tarea').item.json.fecha_objetivo || 'Sin fecha' }}\n\n(Volviendo al menu de tareas...)",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "228070ef-8080-4d37-8214-fe09b8950079",
      "name": "Tarea OK",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108512,
        131512
      ],
      "webhookId": "a3bd33d0-9edd-4680-9afc-f2bd3b36359e",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "tareas_menu",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "774a20b3-9e11-4d1f-8465-78b234c950a0",
      "name": "Update After Tarea",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108288,
        131512
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ titulo: $('Set Variables').item.json.mensaje }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "3f9e2d8a-70b4-40aa-be80-3f4f54424edb",
      "name": "Set Titulo Tarea",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -108064,
        130984
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "tarea_crear_paso_2",
            "paso_actual": "2",
            "datos_parciales": "={{ $json.datos_parciales }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "1072d069-1308-4983-9a39-58a0291cb1c2",
      "name": "Update Tarea Paso 2",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -107840,
        130984
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "CREAR TAREA - Paso 2/3\n\nPrioridad?\n\n1. Alta\n2. Media\n3. Baja\n\n9. Cancelar",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "445b6345-a59d-4f07-9fc7-75790a570293",
      "name": "Send Tarea Paso 2",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -107616,
        130984
      ],
      "webhookId": "cbc29f99-733a-452e-a909-10cfc49d4633",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
              "rightValue": "9",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "5688d9e1-3ef3-45cb-b25f-95d3be883a19",
      "name": "Cancelar Tarea 2?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -108288,
        131200
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "alta"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "media"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "3",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "baja"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "4d541a14-b2b7-4593-8840-46e967436dd3",
      "name": "Prioridad Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -108064,
        131464
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ ...JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}'), prioridad: 'alta' }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "f93a697d-b2b4-42fe-b55d-43f2c1f376ef",
      "name": "Set Prioridad Alta",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -107840,
        131176
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ ...JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}'), prioridad: 'media' }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "6bf56086-5479-40ae-99c8-a2321305dea4",
      "name": "Set Prioridad Media",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -107840,
        131368
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ ...JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}'), prioridad: 'baja' }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "443119e1-64d7-488e-8dd7-411e81f77ae7",
      "name": "Set Prioridad Baja",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -107840,
        131704
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "tarea_crear_paso_3",
            "paso_actual": "3",
            "datos_parciales": "={{ $json.datos_parciales }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "1db4d7e3-3844-4eb0-bb19-a748760ccf36",
      "name": "Update Tarea Paso 3",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -107616,
        131368
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "CREAR TAREA - Paso 3/3\n\nFecha objetivo? (YYYY-MM-DD)\nEj: 2025-02-15\n\nEscribe 0 para saltar\n\n9. Cancelar",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "b7097cd9-712d-42e8-8c8b-c2cf540869f3",
      "name": "Send Tarea Paso 3",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -107392,
        131368
      ],
      "webhookId": "bb3ade50-1628-4a33-82c8-fb5382a69867",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
              "rightValue": "9",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "3ef88084-c547-4862-8287-dc8f13763b91",
      "name": "Cancelar Tarea 3?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109632,
        131536
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
              "rightValue": "^(\\d{4}-\\d{2}-\\d{2}|0)$",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "f836e8c6-da7e-4ce9-9238-8570ed2ca537",
      "name": "Fecha Valida?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109408,
        131608
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ ...JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}'), fecha_objetivo: $('Set Variables').item.json.mensaje === '0' ? '' : $('Set Variables').item.json.mensaje }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "f59ba5bb-1eed-4df3-91e4-e2a38e5bcc1b",
      "name": "Set Fecha Tarea",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -109184,
        131512
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Formato incorrecto. Usa YYYY-MM-DD o 0 para saltar.\n\n9. Cancelar",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "944b1bfa-1527-4f22-a9fa-fd3f1274a518",
      "name": "Send Fecha Invalida",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        131704
      ],
      "webhookId": "b666ecac-cf59-4587-a0c7-b21ebab2f3b3",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Opcion no valida. Escribe 1, 2, 3 o 9.",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "a27bcfe9-fd08-4392-882f-def9619d5540",
      "name": "Send Prioridad Invalida",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -107840,
        131896
      ],
      "webhookId": "4dbc2283-e2e2-42af-8de4-19398aa097c6",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 0,
          "cachedResultName": "CITAS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "creado_por",
              "lookupValue": "={{ $('Set Variables').first().json.telegram_user }}"
            },
            {
              "lookupColumn": "estado",
              "lookupValue": "pendiente"
            }
          ]
        },
        "options": {}
      },
      "id": "729759f0-46c9-4902-bd37-f42916c15de0",
      "name": "Get Citas Para Reprogramar",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109408,
        124312
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nif (items.length === 0 || !items[0].json.nombre) {\n    return { json: { text: \"No tienes citas pendientes para reprogramar.\\n\\n9. Volver\", list: [] } };\n}\n\nlet text = \"ðŸ“… Selecciona la cita a reprogramar:\\n\\n\";\nconst list = items.map((item, index) => {\n    text += `${index + 1}. ${item.json.fecha} ${item.json.hora} - ${item.json.nombre}\\n`;\n    return { id_cita: item.json.id_cita, detail: `${item.json.fecha} ${item.json.hora} - ${item.json.nombre}` };\n});\n\ntext += \"\\nIngresa el nÃºmero de la cita.\\n9. Cancelar\";\n\nreturn { json: { text, list } };"
      },
      "id": "a55bf9f3-86a7-4ba5-8d00-63b56e5c31d2",
      "name": "Format Lista Repro",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109184,
        124312
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $json.text }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "a01e3e60-ac27-4828-8e42-40902d76f38d",
      "name": "Send Lista Para Reprogramar",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108960,
        124312
      ],
      "webhookId": "dc93a917-ef2a-49f6-9889-d1f7aa8e47e7",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "agenda_repro_1",
            "paso_actual": "1",
            "datos_parciales": "={{ JSON.stringify($('Format Lista Repro').first().json.list) }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "d8bffcff-1c4a-4cf6-b654-09242bae80ba",
      "name": "Update Session Repro 1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108736,
        124312
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const msg = $(\"Set Variables\").first().json.mensaje;\nconst list = JSON.parse($(\"Merge Session Data\").first().json.datos_parciales || \"[]\");\nconst index = parseInt(msg) - 1;\nif (isNaN(index) || index < 0 || index >= list.length) {\n    return { json: { valid: false, error: \"SelecciÃ³n no vÃ¡lida. Elige un nÃºmero de la lista.\" } };\n}\n\nreturn { json: { valid: true, id_cita: list[index].id_cita, detail: list[index].detail } };"
      },
      "id": "eb0680e3-ba5f-4f29-bdd7-42d25d7beec2",
      "name": "Logic Seleccion Cita",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109856,
        124928
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "=Has seleccionado: {{ $json.detail }}\\n\\nPor favor, ingresa la NUEVA FECHA (YYYY-MM-DD):",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "86af8ce0-b8af-4b32-89d7-af07ad4f2b85",
      "name": "Send Solicitar Nueva Fecha",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109632,
        124928
      ],
      "webhookId": "00ff6c81-ea97-4186-bce4-a293a0d5629a",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "agenda_repro_2",
            "paso_actual": "2",
            "datos_parciales": "={{ JSON.stringify($('Logic Seleccion Cita').first().json) }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "5999cbf0-6828-41d2-829c-e71943190e18",
      "name": "Update Session Repro 2",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109408,
        124928
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 0,
          "cachedResultName": "CITAS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "fecha": "={{ $json.fecha_cita }}",
            "id_cita": "={{ $json.id_cita }}"
          },
          "matchingColumns": [
            "id_cita"
          ]
        },
        "options": {}
      },
      "id": "496402ba-d2d8-47c1-87dc-8ef27644dada",
      "name": "Update Cita DB",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109632,
        127440
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "âœ… Â¡Cita reprogramada con Ã©xito!\\n\\nPresiona 9 para volver al menÃº.",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "f79d4533-a61b-4ff3-a9ae-463123765772",
      "name": "Send Confirmacion Repro",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109408,
        127440
      ],
      "webhookId": "4fdd0a2f-ca0d-4e63-9fb1-3df545ae627a",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const session = $(\"Merge Session Data\").first().json;\nlet reproData = {};\ntry {\n    const dp = session.datos_parciales;\n    reproData = (typeof dp === 'string') ? JSON.parse(dp) : dp;\n} catch (e) {}\n\nreturn { \n  id_cita: reproData.id_cita, \n  fecha_cita: $(\"Set Variables\").first().json.mensaje \n};"
      },
      "id": "ddf5ae42-780a-4b26-a4e3-b7704c64019a",
      "name": "Extract Repro Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109856,
        127440
      ]
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 0,
          "cachedResultName": "CITAS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "creado_por",
              "lookupValue": "={{ $('Set Variables').first().json.telegram_user }}"
            },
            {
              "lookupColumn": "estado",
              "lookupValue": "pendiente"
            }
          ]
        },
        "options": {}
      },
      "id": "ee961c94-cd1d-49c6-a603-7315830b9926",
      "name": "Get Citas Para Cancelar",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109408,
        124504
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nif (items.length === 0 || !items[0].json.nombre) {\n    return { json: { text: \"No tienes citas pendientes para cancelar.\\n\\n9. Volver\", list: [] } };\n}\n\nlet text = \"âŒ Selecciona la cita a CANCELAR:\\n\\n\";\nconst list = items.map((item, index) => {\n    text += `${index + 1}. ${item.json.fecha} ${item.json.hora} - ${item.json.nombre}\\n`;\n    return { id_cita: item.json.id_cita, detail: `${item.json.fecha} ${item.json.hora} - ${item.json.nombre}` };\n});\n\ntext += \"\\nIngresa el nÃºmero de la cita.\\n9. Cancelar\";\n\nreturn { json: { text, list } };"
      },
      "id": "e0d5bc8a-4fd2-490d-8983-05cb4c44e498",
      "name": "Format Lista Cancel",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109184,
        124504
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $json.text }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "77064838-25e9-4589-aa00-071575ac1830",
      "name": "Send Lista Para Cancelar",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108960,
        124504
      ],
      "webhookId": "7e05a80c-f726-44a1-b2fc-940f9b8a1d35",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "agenda_cancel_1",
            "paso_actual": "1",
            "datos_parciales": "={{ JSON.stringify($('Format Lista Cancel').first().json.list) }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "f754589c-4843-4abf-ae61-94805a237477",
      "name": "Update Session Cancel 1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108736,
        124504
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const msg = $(\"Set Variables\").first().json.mensaje;\nconst list = JSON.parse($(\"Merge Session Data\").first().json.datos_parciales || \"[]\");\nconst index = parseInt(msg) - 1;\nif (isNaN(index) || index < 0 || index >= list.length) {\n    return { json: { valid: false, error: \"SelecciÃ³n no vÃ¡lida. Elige un nÃºmero de la lista.\" } };\n}\n\nreturn { json: { valid: true, id_cita: list[index].id_cita, detail: list[index].detail } };"
      },
      "id": "8dfa81c8-ea40-4526-bfed-8812a8125240",
      "name": "Logic Seleccion Cancel",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109856,
        127728
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "c85f6231-a036-4e4b-898e-35cd7ae6cce1",
      "name": "If Valid Cancel",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109632,
        127728
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 0,
          "cachedResultName": "CITAS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "estado": "cancelada",
            "id_cita": "={{ $('Logic Seleccion Cancel').first().json.id_cita }}"
          },
          "matchingColumns": [
            "id_cita"
          ]
        },
        "options": {}
      },
      "id": "6cad6a8d-559e-43b3-9afa-06222d99040a",
      "name": "Update Cita Cancelada",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109408,
        127632
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "=âœ… Cita cancelada: {{ $('Logic Seleccion Cancel').first().json.detail }}\\n\\nPresiona 9 para volver al menÃº.",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "75ca7746-9546-4dea-ac91-a9d72af20a30",
      "name": "Send Confirmacion Cancel",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        127632
      ],
      "webhookId": "7b6a260a-fcb5-47fa-844e-d79b3004c12a",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "agenda_menu",
            "paso_actual": "",
            "datos_parciales": "",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "50af6bd6-7b0a-493b-b865-60988c7bba9e",
      "name": "Update Session Back Agenda",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108960,
        127632
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $('Logic Seleccion Cancel').first().json.error }}\\n\\n9. Volver",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "702417ba-e9cc-4679-a60e-7173b8e40794",
      "name": "Send Error Cancel",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109408,
        127824
      ],
      "webhookId": "b69f63d7-8247-46a5-a690-8d5438e39ba1",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 0,
          "cachedResultName": "CITAS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "creado_por",
              "lookupValue": "={{ $('Set Variables').first().json.telegram_user }}"
            },
            {
              "lookupColumn": "estado",
              "lookupValue": "pendiente"
            }
          ]
        },
        "options": {}
      },
      "id": "dec101d7-3af4-4b29-a4c5-53d42cdb8d2d",
      "name": "Get Citas Para Completar",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109408,
        124696
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nif (items.length === 0 || !items[0].json.nombre) {\n    return { json: { text: \"No tienes citas pendientes para completar.\\n\\n9. Volver\", list: [] } };\n}\n\nlet text = \"âœ… Selecciona la cita a marcar como COMPLETADA:\\n\\n\";\nconst list = items.map((item, index) => {\n    text += `${index + 1}. ${item.json.fecha} ${item.json.hora} - ${item.json.nombre}\\n`;\n    return { id_cita: item.json.id_cita, detail: `${item.json.fecha} ${item.json.hora} - ${item.json.nombre}` };\n});\n\ntext += \"\\nIngresa el nÃºmero de la cita.\\n9. Cancelar\";\n\nreturn { json: { text, list } };"
      },
      "id": "86be956b-903f-4863-9bc0-a6073c60e653",
      "name": "Format Lista Completar",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109184,
        124696
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $json.text }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "7495d827-2e99-4ffc-82de-a8a94ae7d3c3",
      "name": "Send Lista Para Completar",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108960,
        124696
      ],
      "webhookId": "608b7c6b-84a6-45db-afd6-64828fcfa9e5",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "agenda_completar_1",
            "paso_actual": "1",
            "datos_parciales": "={{ JSON.stringify($('Format Lista Completar').first().json.list) }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "9f630ab5-fa99-4f03-bd7b-3a0d42471eef",
      "name": "Update Session Completar 1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108736,
        124696
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const msg = $(\"Set Variables\").first().json.mensaje;\nconst list = JSON.parse($(\"Merge Session Data\").first().json.datos_parciales || \"[]\");\nconst index = parseInt(msg) - 1;\nif (isNaN(index) || index < 0 || index >= list.length) {\n    return { json: { valid: false, error: \"SelecciÃ³n no vÃ¡lida. Elige un nÃºmero de la lista.\" } };\n}\n\nreturn { json: { valid: true, id_cita: list[index].id_cita, detail: list[index].detail } };"
      },
      "id": "d76cfc26-5d17-4d7f-bb2d-7fdda0c348bf",
      "name": "Logic Seleccion Completar",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109856,
        128112
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "8f31f9e4-0bad-465e-b6d7-184ea1df3c40",
      "name": "If Valid Completar",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109632,
        128112
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 0,
          "cachedResultName": "CITAS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "estado": "completada",
            "id_cita": "={{ $('Logic Seleccion Completar').first().json.id_cita }}"
          },
          "matchingColumns": [
            "id_cita"
          ]
        },
        "options": {}
      },
      "id": "de71cd93-10a7-4da2-9608-f46e9d05049d",
      "name": "Update Cita Completada",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109408,
        128016
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "=âœ… Cita completada: {{ $('Logic Seleccion Completar').first().json.detail }}\\n\\nPresiona 9 para volver al menÃº.",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "371aa0c7-50ee-477b-9d03-65d9a01d3469",
      "name": "Send Confirmacion Completar",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        128016
      ],
      "webhookId": "a30fd60c-860d-411a-9867-728533588e24",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "agenda_menu",
            "paso_actual": "",
            "datos_parciales": "",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "35bb64e0-1de5-4b60-9c69-791c4b1092a9",
      "name": "Update Session Back Agenda Completar",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108960,
        128016
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $('Logic Seleccion Completar').first().json.error }}\\n\\n9. Volver",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "95c683f0-3f79-498b-a6e7-fb4f7b4b681f",
      "name": "Send Error Completar",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109408,
        128208
      ],
      "webhookId": "6ad91131-2055-40b6-b6f9-8eab906e25af",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 1513010529,
          "cachedResultName": "USUARIOS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "telegram_user",
              "lookupValue": "={{ $('Set Variables').first().json.telegram_user }}"
            }
          ]
        },
        "options": {}
      },
      "id": "1938ec3b-1d53-4394-8193-d15ddb45302d",
      "name": "Get Usuario Rol",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109408,
        121912
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.rol }}",
              "rightValue": "admin",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ac30ea93-9957-4f10-954d-db5bdcae29f5",
      "name": "If Es Admin",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109184,
        121912
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "â›” No tienes permisos para acceder a esta secciÃ³n.\n\nPresiona 9 para volver al menÃº principal.",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "c884cee1-381e-47ea-9891-746ab3485a77",
      "name": "Send No Permisos",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108960,
        121816
      ],
      "webhookId": "410b5719-86d5-4823-9b70-e2dede35341a",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 1513010529,
          "cachedResultName": "USUARIOS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "nombre": "={{ $('Set Variables').first().json.username }}",
            "rol": "usuario",
            "permitido": "true"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telegram_user",
              "displayName": "telegram_user",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "nombre",
              "displayName": "nombre",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "rol",
              "displayName": "rol",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "permitido",
              "displayName": "permitido",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "5170ac64-a6c2-4e19-b18e-7b77e6d01cd3",
      "name": "Create Usuario",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -110304,
        120160
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 1513010529,
          "cachedResultName": "USUARIOS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "telegram_user",
              "lookupValue": "={{ $('Set Variables').first().json.telegram_user }}"
            }
          ]
        },
        "options": {}
      },
      "id": "682dcda7-8010-41be-a2c8-c0569a2b0a31",
      "name": "Check Rol Para Menu",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108064,
        115520
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.rol }}",
              "rightValue": "admin",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "86935bbd-4993-4af9-9091-eca8c4273eab",
      "name": "If Admin Menu",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -107840,
        115520
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "MENU\n0. Ayuda\n1. Agenda\n2. Tareas\n3. Recordatorios\n4. Habitos\n5. Listas\n6. Reportes",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "8624f4b4-02a2-40ac-9d89-f8a7633a153c",
      "name": "Send Menu Usuario",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -107616,
        117088
      ],
      "webhookId": "3bb124cd-7b7f-4580-acdc-9300a5f94f4f",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 0,
          "cachedResultName": "CITAS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "fecha",
              "lookupValue": "={{ $json.fecha }}"
            },
            {
              "lookupColumn": "hora",
              "lookupValue": "={{ $json.hora }}"
            },
            {
              "lookupColumn": "estado",
              "lookupValue": "pendiente"
            }
          ]
        },
        "options": {}
      },
      "id": "01855590-5f85-4a86-bf69-2155584e6d15",
      "name": "Check Doble Reserva",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109184,
        127208
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $json.id_cita }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "empty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "3e85073f-81d3-49ff-9014-564aaacbaea9",
      "name": "If No Existe Cita",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -108960,
        127208
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "=âš ï¸ Ya existe una cita para el {{ $('Parse Cita').first().json.fecha }} a las {{ $('Parse Cita').first().json.hora }}.\n\nPor favor elige otra fecha u hora.\n\n9. Volver al menÃº",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "fd643419-5d40-4b90-9919-0782dfb6a946",
      "name": "Error Doble Reserva",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108736,
        126488
      ],
      "webhookId": "dba9a990-f9b6-48bd-ab2f-8f1e71d1f46a",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').first().json.mensaje }}",
                    "rightValue": "1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "dia"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').first().json.mensaje }}",
                    "rightValue": "2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "semana"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').first().json.mensaje }}",
                    "rightValue": "3",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "productividad"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').first().json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "volver"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "31272778-4632-4bae-9d3d-eba934945d02",
      "name": "Reportes Menu Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -109856,
        120856
      ]
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 0,
          "cachedResultName": "CITAS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=0"
        },
        "options": {}
      },
      "id": "0e342db2-9568-404b-a0ee-fdd3082d1707",
      "name": "Get Citas Report",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109632,
        120568
      ],
      "alwaysOutputData": true,
      "executeOnce": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 37820303,
          "cachedResultName": "TAREAS"
        },
        "options": {}
      },
      "id": "6525f24f-83a9-4752-8ad7-62e5624dee4a",
      "name": "Get Tareas Report",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109408,
        120568
      ],
      "alwaysOutputData": true,
      "executeOnce": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 563773723,
          "cachedResultName": "HABITOS"
        },
        "options": {}
      },
      "id": "c7e22db1-301c-4d6c-b4cc-1f27bee5d52d",
      "name": "Get Habitos Report",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109184,
        120568
      ],
      "alwaysOutputData": true,
      "executeOnce": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const citas = $('Get Citas Report').all();\nconst tareas = $('Get Tareas Report').all();\nconst habitos = $('Get Habitos Report').all();\nconst user = String($('Set Variables').first().json.telegram_user);\n\n// Usar fecha local en vez de UTC\nconst hoy = new Date();\nconst aÃ±o = hoy.getFullYear();\nconst mes = String(hoy.getMonth() + 1).padStart(2, '0');\nconst dia = String(hoy.getDate()).padStart(2, '0');\nconst hoyStr = aÃ±o + '-' + mes + '-' + dia;\n\n// Citas de hoy\nconst citasHoy = citas.filter(c => c.json.creado_por && String(c.json.creado_por) === user && c.json.fecha === hoyStr && c.json.estado === 'pendiente');\n\n// Tareas pendientes para hoy\nconst tareasHoy = tareas.filter(t => t.json.creado_por && String(t.json.creado_por) === user && t.json.fecha_objetivo === hoyStr && t.json.estado === 'pendiente');\n\n// HÃ¡bitos activos\nconst habitosActivos = habitos.filter(h => h.json.creado_por && String(h.json.creado_por) === user && h.json.estado === 'activo');\n\nlet msg = 'ðŸ“… RESUMEN DEL DÃA\\n' + hoyStr + '\\n\\n';\n\nmsg += 'ðŸ“‹ CITAS HOY: ' + citasHoy.length + '\\n';\nif (citasHoy.length > 0) {\n  citasHoy.forEach(c => { msg += '  â€¢ ' + c.json.hora + ' - ' + c.json.nombre + '\\n'; });\n} else {\n  msg += '  Sin citas programadas\\n';\n}\n\nmsg += '\\nâœ… TAREAS PENDIENTES: ' + tareasHoy.length + '\\n';\nif (tareasHoy.length > 0) {\n  tareasHoy.forEach(t => { msg += '  â€¢ ' + t.json.descripcion + '\\n'; });\n} else {\n  msg += '  Sin tareas para hoy\\n';\n}\n\nmsg += '\\nðŸŽ¯ HÃBITOS: ' + habitosActivos.length + '\\n';\nif (habitosActivos.length > 0) {\n  habitosActivos.forEach(h => { msg += '  â€¢ ' + h.json.nombre + ' (' + h.json.hora_recordatorio + ')\\n'; });\n} else {\n  msg += '  Sin hÃ¡bitos activos\\n';\n}\n\nmsg += '\\n9. Volver';\nreturn [{json: {mensaje: msg}}];"
      },
      "id": "be4ad34d-b91d-4e4a-bce8-a44e56223ffa",
      "name": "Format Report Dia",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -108960,
        120568
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $json.mensaje }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "eb741ae1-cdfa-4a0e-a5f7-3d1567b786c0",
      "name": "Send Report Dia",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108736,
        120568
      ],
      "webhookId": "b308342a-934c-452e-8aff-a32667cd872b",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 0,
          "cachedResultName": "CITAS"
        },
        "options": {}
      },
      "id": "d28659d0-16b9-4288-8792-c25358a55f6b",
      "name": "Get Citas Semanal",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109632,
        120760
      ],
      "alwaysOutputData": true,
      "executeOnce": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 37820303,
          "cachedResultName": "TAREAS"
        },
        "options": {}
      },
      "id": "6751f864-6639-4521-aac4-dc894892acda",
      "name": "Get Tareas Semanal",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109408,
        120760
      ],
      "alwaysOutputData": true,
      "executeOnce": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 563773723,
          "cachedResultName": "HABITOS"
        },
        "options": {}
      },
      "id": "b2ff9ab2-634e-4bc1-9d80-fa219313e142",
      "name": "Get Habitos Semanal",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109184,
        120760
      ],
      "alwaysOutputData": true,
      "executeOnce": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const citas = $('Get Citas Semanal').all();\nconst tareas = $('Get Tareas Semanal').all();\nconst habitos = $('Get Habitos Semanal').all();\nconst user = String($('Set Variables').first().json.telegram_user);\n\n// FunciÃ³n para formatear fecha local\nfunction formatDate(d) {\n  return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');\n}\n\nconst hoy = new Date();\nconst inicioSemana = new Date(hoy);\ninicioSemana.setDate(hoy.getDate() - hoy.getDay());\nconst finSemana = new Date(inicioSemana);\nfinSemana.setDate(inicioSemana.getDate() + 6);\n\nconst inicioStr = formatDate(inicioSemana);\nconst finStr = formatDate(finSemana);\n\n// Citas de la semana\nconst citasSemana = citas.filter(c => {\n  if (!c.json.creado_por || String(c.json.creado_por) !== user) return false;\n  return c.json.fecha >= inicioStr && c.json.fecha <= finStr;\n});\n\n// Tareas de la semana\nconst tareasUser = tareas.filter(t => t.json.creado_por && String(t.json.creado_por) === user);\nconst tareasCompletadas = tareasUser.filter(t => t.json.estado === 'completada');\nconst tareasPendientes = tareasUser.filter(t => t.json.estado === 'pendiente');\n\n// HÃ¡bitos activos\nconst habitosActivos = habitos.filter(h => h.json.creado_por && String(h.json.creado_por) === user && h.json.estado === 'activo');\n\nlet msg = 'ðŸ“Š RESUMEN SEMANAL\\n' + inicioStr + ' al ' + finStr + '\\n\\n';\n\nmsg += 'ðŸ“‹ CITAS ESTA SEMANA: ' + citasSemana.length + '\\n';\nif (citasSemana.length > 0) {\n  citasSemana.slice(0, 5).forEach(c => { msg += '  â€¢ ' + c.json.fecha + ' ' + c.json.hora + ' - ' + c.json.nombre + '\\n'; });\n  if (citasSemana.length > 5) msg += '  ... y ' + (citasSemana.length - 5) + ' mÃ¡s\\n';\n}\n\nmsg += '\\nâœ… TAREAS:\\n';\nmsg += '  Completadas: ' + tareasCompletadas.length + '\\n';\nmsg += '  Pendientes: ' + tareasPendientes.length + '\\n';\n\nmsg += '\\nðŸŽ¯ HÃBITOS ACTIVOS: ' + habitosActivos.length + '\\n';\nhabitosActivos.forEach(h => { msg += '  â€¢ ' + h.json.nombre + '\\n'; });\n\nmsg += '\\n9. Volver';\nreturn [{json: {mensaje: msg}}];"
      },
      "id": "1835787a-d996-46bb-8d52-2e86e410b3e7",
      "name": "Format Report Semanal",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -108960,
        120760
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $json.mensaje }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "06a16006-8448-47e4-86f5-8fa0ed5e2edb",
      "name": "Send Report Semanal",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -108736,
        120760
      ],
      "webhookId": "4b024cd0-0d91-4e20-a87a-aa6f193cb08a",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 37820303,
          "cachedResultName": "TAREAS"
        },
        "options": {}
      },
      "id": "d4a71229-ffb5-4536-a6a2-908fc695bb7b",
      "name": "Get Tareas Productividad",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -109632,
        120952
      ],
      "alwaysOutputData": true,
      "executeOnce": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const tareas = $('Get Tareas Productividad').all();\nconst user = String($('Set Variables').first().json.telegram_user);\n\nconst tareasUser = tareas.filter(t => t.json.creado_por && String(t.json.creado_por) === user);\nconst completadas = tareasUser.filter(t => t.json.estado === 'completada');\nconst pendientes = tareasUser.filter(t => t.json.estado === 'pendiente');\nconst eliminadas = tareasUser.filter(t => t.json.estado === 'eliminada');\n\nconst total = tareasUser.length;\nconst porcentaje = total > 0 ? Math.round((completadas.length / total) * 100) : 0;\n\nlet msg = 'ðŸ“ˆ PRODUCTIVIDAD\\n\\n';\nmsg += 'ðŸ“Š ESTADÃSTICAS DE TAREAS:\\n\\n';\nmsg += '  Total creadas: ' + total + '\\n';\nmsg += '  âœ… Completadas: ' + completadas.length + '\\n';\nmsg += '  â³ Pendientes: ' + pendientes.length + '\\n';\nmsg += '  ðŸ—‘ï¸ Eliminadas: ' + eliminadas.length + '\\n\\n';\nmsg += '  ðŸ“ˆ Tasa de completado: ' + porcentaje + '%\\n';\n\n// Barra de progreso visual\nconst barraLlena = Math.round(porcentaje / 10);\nconst barraVacia = 10 - barraLlena;\nmsg += '  [' + 'â–ˆ'.repeat(barraLlena) + 'â–‘'.repeat(barraVacia) + ']\\n';\n\nmsg += '\\n9. Volver';\nreturn [{json: {mensaje: msg}}];"
      },
      "id": "20f2d408-3cec-4c1d-95d4-c80ace5d86d8",
      "name": "Format Report Productividad",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -109408,
        120952
      ]
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "={{ $json.mensaje }}",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "f3d91923-2e8a-4460-9bea-546d5568553c",
      "name": "Send Report Productividad",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109184,
        120952
      ],
      "webhookId": "6d40deba-ec97-4a74-b388-9cd794adf001",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "OpciÃ³n no vÃ¡lida.\n\nðŸ“Š REPORTES\n\n1. Resumen del dÃ­a\n2. Resumen semanal\n3. Productividad\n9. Volver",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "02361889-1518-4857-915d-4926d3870419",
      "name": "Send Invalid Reportes",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109632,
        121320
      ],
      "webhookId": "72a7347f-dd6b-45f6-8251-0c7a9dd08990",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "reporte_dia",
            "paso_actual": "1",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "06883651-6d3e-4640-ae49-cf5f31bd0600",
      "name": "Update Session Report Dia",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108512,
        120568
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "reporte_semanal",
            "paso_actual": "1",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "8dffcc33-f06c-471a-8ac2-e904570cfbd7",
      "name": "Update Session Report Semanal",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108512,
        120760
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').first().json.telegram_user }}",
            "pantalla_actual": "reporte_productividad",
            "paso_actual": "1",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').first().json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "id": "be9ee087-a567-45be-ac09-a4cb6b65ebf2",
      "name": "Update Session Report Productividad",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -108960,
        120952
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').first().json.chat_id }}",
        "text": "Presiona 9 para volver al menÃº de reportes.",
        "additionalFields": {"appendAttribution": false}
      },
      "id": "90b6e519-a375-4596-9e42-2aa3af6c280a",
      "name": "Send Invalid Reporte",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -109408,
        123112
      ],
      "webhookId": "9f47200a-9ef6-4caf-b18e-d4509668bc83",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Set Variables').first().json.mensaje }}",
              "rightValue": "9",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "f04c56d3-bcca-4889-ae50-478a34a32ddf",
      "name": "Reporte Volver Router",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -109632,
        123064
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Set Variables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Variables": {
      "main": [
        [
          {
            "node": "Get Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Session": {
      "main": [
        [
          {
            "node": "Session Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Session Exists?": {
      "main": [
        [
          {
            "node": "Merge Session Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set New User Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Session Data": {
      "main": [
        [
          {
            "node": "Log Interaction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set New User Data": {
      "main": [
        [
          {
            "node": "Create New Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create New Session": {
      "main": [
        [
          {
            "node": "Log Interaction",
            "type": "main",
            "index": 0
          },
          {
            "node": "Create Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Interaction": {
      "main": [
        [
          {
            "node": "Router Principal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Bienvenida": {
      "main": [
        [
          {
            "node": "Prepare Update Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Update Data": {
      "main": [
        [
          {
            "node": "Update Session to Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router Principal": {
      "main": [
        [
          {
            "node": "Send Bienvenida",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Bienvenida",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Menu Principal Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Agenda Menu Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Agenda Wizard Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Tareas Menu Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Tarea Wizard Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Habitos Menu Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Listas Menu Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Option",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reportes Menu Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Option",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Option",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Ayuda Menu Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Logic Seleccion Cita",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Repro Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Logic Seleccion Cancel",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Logic Seleccion Completar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Consultar Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Ver Pendientes Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Ver Completadas Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Logic Seleccion Completar Tarea",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Tarea Completada Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Logic Seleccion Eliminar Tarea",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Tarea Eliminada Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Ver Habitos Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Logic Seleccion Eliminar Habito",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Habito Eliminado Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Habito Crear Paso 2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Habito Crear Paso 3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Guardar Habito",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Logic Seleccion Recordatorio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Guardar Hora Recordatorio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Lista Crear Nombre",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Lista Agregar Item",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Logic Seleccion Lista",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Items Lista Menu Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Logic Agregar Item",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Logic Seleccion Completar Item",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Logic Seleccion Eliminar Item",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reporte Volver Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reporte Volver Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reporte Volver Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reporte Volver Router": {
      "main": [
        [
          {
            "node": "Send Reportes Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Reporte",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Router": {
      "main": [
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Consultar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Ayuda": {
      "main": [
        [
          {
            "node": "Update to Ayuda",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ayuda Menu Router": {
      "main": [
        [
          {
            "node": "Check Rol Para Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Option",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Menu Principal Router": {
      "main": [
        [
          {
            "node": "Send Ayuda",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Tareas Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Habitos Recordatorio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Habitos Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Listas Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Reportes Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Config Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Usuario Rol",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Option",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Agenda Menu": {
      "main": [
        [
          {
            "node": "Update to Agenda Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Tareas Menu": {
      "main": [
        [
          {
            "node": "Update to Tareas Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Habitos Menu": {
      "main": [
        [
          {
            "node": "Update to Habitos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Habitos Menu Router": {
      "main": [
        [
          {
            "node": "Send Habito Paso 1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Habitos Activos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Habitos Para Eliminar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check Rol Para Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Habitos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Habito Paso 1": {
      "main": [
        [
          {
            "node": "Update Habito Paso 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Habitos Activos": {
      "main": [
        [
          {
            "node": "Format Habitos Activos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Habitos Activos": {
      "main": [
        [
          {
            "node": "Send Habitos Activos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Habitos Activos": {
      "main": [
        [
          {
            "node": "Update Session Ver Habitos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ver Habitos Router": {
      "main": [
        [
          {
            "node": "Send Habitos Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Ver Habitos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Habitos Para Eliminar": {
      "main": [
        [
          {
            "node": "Format Lista Eliminar Habitos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Lista Eliminar Habitos": {
      "main": [
        [
          {
            "node": "Send Lista Eliminar Habitos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Lista Eliminar Habitos": {
      "main": [
        [
          {
            "node": "Update Session Eliminar Habito",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Logic Seleccion Eliminar Habito": {
      "main": [
        [
          {
            "node": "If Valid Eliminar Habito",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Valid Eliminar Habito": {
      "main": [
        [
          {
            "node": "Update Habito Eliminado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If Cancel Eliminar Habito",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Habito Eliminado": {
      "main": [
        [
          {
            "node": "Send Habito Eliminado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Habito Eliminado": {
      "main": [
        [
          {
            "node": "Update Session Habito Eliminado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Cancel Eliminar Habito": {
      "main": [
        [
          {
            "node": "Send Habitos Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Error Eliminar Habito",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Habito Eliminado Router": {
      "main": [
        [
          {
            "node": "Send Habitos Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Habito Eliminado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Habito Crear Paso 2": {
      "main": [
        [
          {
            "node": "If Cancel Crear Habito",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Cancel Crear Habito": {
      "main": [
        [
          {
            "node": "Send Habitos Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Habito Paso 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Habito Paso 2": {
      "main": [
        [
          {
            "node": "Update Habito Paso 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Habito Crear Paso 3": {
      "main": [
        [
          {
            "node": "If Cancel Crear Habito 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Cancel Crear Habito 2": {
      "main": [
        [
          {
            "node": "Send Habitos Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Habito Paso 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Habito Paso 3": {
      "main": [
        [
          {
            "node": "Update Habito Paso 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Habito": {
      "main": [
        [
          {
            "node": "If Cancel Crear Habito 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Cancel Crear Habito 3": {
      "main": [
        [
          {
            "node": "Send Habitos Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Insert Habito",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Habito": {
      "main": [
        [
          {
            "node": "Send Habito Creado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Habitos Recordatorio": {
      "main": [
        [
          {
            "node": "Format Lista Recordatorios",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Lista Recordatorios": {
      "main": [
        [
          {
            "node": "Send Lista Recordatorios",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Lista Recordatorios": {
      "main": [
        [
          {
            "node": "Update Session Recordatorio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Logic Seleccion Recordatorio": {
      "main": [
        [
          {
            "node": "If Valid Recordatorio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Valid Recordatorio": {
      "main": [
        [
          {
            "node": "Send Pedir Hora",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If Cancel Recordatorio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Pedir Hora": {
      "main": [
        [
          {
            "node": "Update Session Recordatorio 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Cancel Recordatorio": {
      "main": [
        [
          {
            "node": "Check Rol Para Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Error Recordatorio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Hora Recordatorio": {
      "main": [
        [
          {
            "node": "If Cancel Guardar Hora",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Cancel Guardar Hora": {
      "main": [
        [
          {
            "node": "Check Rol Para Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Hora Habito",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Hora Habito": {
      "main": [
        [
          {
            "node": "Send Hora Actualizada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Hora Actualizada": {
      "main": [
        [
          {
            "node": "Check Rol Para Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Listas Menu": {
      "main": [
        [
          {
            "node": "Update to Listas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Listas Menu Router": {
      "main": [
        [
          {
            "node": "Send Lista Paso 1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Listas Usuario",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check Rol Para Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Listas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Lista Paso 1": {
      "main": [
        [
          {
            "node": "Update Lista Paso 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lista Crear Nombre": {
      "main": [
        [
          {
            "node": "If Cancel Lista 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Cancel Lista 1": {
      "main": [
        [
          {
            "node": "Send Listas Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Insert Lista",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Lista": {
      "main": [
        [
          {
            "node": "Send Lista Paso 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Lista Paso 2": {
      "main": [
        [
          {
            "node": "Update Lista Paso 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lista Agregar Item": {
      "main": [
        [
          {
            "node": "Lista Action Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lista Action Router": {
      "main": [
        [
          {
            "node": "Insert Item Lista",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Lista Creada",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Listas Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Item Lista": {
      "main": [
        [
          {
            "node": "Send Item Agregado Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Item Agregado Loop": {
      "main": [
        [
          {
            "node": "Update Session Item Loop",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Lista Creada": {
      "main": [
        [
          {
            "node": "Check Rol Para Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Listas Usuario": {
      "main": [
        [
          {
            "node": "Format Listas Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Listas Usuario": {
      "main": [
        [
          {
            "node": "Send Listas Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Listas Usuario": {
      "main": [
        [
          {
            "node": "Update Session Ver Listas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Logic Seleccion Lista": {
      "main": [
        [
          {
            "node": "If Valid Lista",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Valid Lista": {
      "main": [
        [
          {
            "node": "Get Items Lista",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If Cancel Ver Listas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Cancel Ver Listas": {
      "main": [
        [
          {
            "node": "Send Listas Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Error Ver Listas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Items Lista": {
      "main": [
        [
          {
            "node": "Format Items Lista",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Items Lista": {
      "main": [
        [
          {
            "node": "Send Items Lista",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Items Lista": {
      "main": [
        [
          {
            "node": "Update Session Items Lista",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Items Lista Menu Router": {
      "main": [
        [
          {
            "node": "Send Agregar Item",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Items Completar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Format Items Eliminar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Listas Usuario",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Items Lista",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Agregar Item": {
      "main": [
        [
          {
            "node": "Update Session Agregar Item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Logic Agregar Item": {
      "main": [
        [
          {
            "node": "If Cancel Agregar Item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Cancel Agregar Item": {
      "main": [
        [
          {
            "node": "Get Items Lista",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Insert Item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Item": {
      "main": [
        [
          {
            "node": "Send Item Agregado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Item Agregado": {
      "main": [
        [
          {
            "node": "Get Items Lista",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Items Completar": {
      "main": [
        [
          {
            "node": "Send Items Completar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Items Completar": {
      "main": [
        [
          {
            "node": "Update Session Completar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Logic Seleccion Completar Item": {
      "main": [
        [
          {
            "node": "If Valid Completar Item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Valid Completar Item": {
      "main": [
        [
          {
            "node": "Update Item Completado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If Cancel Completar Item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Item Completado": {
      "main": [
        [
          {
            "node": "Send Item Completado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Item Completado": {
      "main": [
        [
          {
            "node": "Get Items Lista",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Cancel Completar Item": {
      "main": [
        [
          {
            "node": "Get Items Lista",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Error Completar Item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Items Eliminar": {
      "main": [
        [
          {
            "node": "Send Items Eliminar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Items Eliminar": {
      "main": [
        [
          {
            "node": "Update Session Eliminar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Logic Seleccion Eliminar Item": {
      "main": [
        [
          {
            "node": "If Valid Eliminar Item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Valid Eliminar Item": {
      "main": [
        [
          {
            "node": "Update Item Eliminado",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If Cancel Eliminar Item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Item Eliminado": {
      "main": [
        [
          {
            "node": "Send Item Eliminado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Item Eliminado": {
      "main": [
        [
          {
            "node": "Get Items Lista",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Cancel Eliminar Item": {
      "main": [
        [
          {
            "node": "Get Items Lista",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Error Eliminar Item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Reportes Menu": {
      "main": [
        [
          {
            "node": "Update to Reportes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reportes Menu Router": {
      "main": [
        [
          {
            "node": "Get Citas Report",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Citas Semanal",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Tareas Productividad",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Menu Principal",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Reportes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Citas Report": {
      "main": [
        [
          {
            "node": "Get Tareas Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Tareas Report": {
      "main": [
        [
          {
            "node": "Get Habitos Report",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Habitos Report": {
      "main": [
        [
          {
            "node": "Format Report Dia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Report Dia": {
      "main": [
        [
          {
            "node": "Send Report Dia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Report Dia": {
      "main": [
        [
          {
            "node": "Update Session Report Dia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Citas Semanal": {
      "main": [
        [
          {
            "node": "Get Tareas Semanal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Tareas Semanal": {
      "main": [
        [
          {
            "node": "Get Habitos Semanal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Habitos Semanal": {
      "main": [
        [
          {
            "node": "Format Report Semanal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Report Semanal": {
      "main": [
        [
          {
            "node": "Send Report Semanal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Report Semanal": {
      "main": [
        [
          {
            "node": "Update Session Report Semanal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Tareas Productividad": {
      "main": [
        [
          {
            "node": "Format Report Productividad",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Report Productividad": {
      "main": [
        [
          {
            "node": "Send Report Productividad",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Report Productividad": {
      "main": [
        [
          {
            "node": "Update Session Report Productividad",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Config Menu": {
      "main": [
        [
          {
            "node": "Update to Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Admin Menu": {
      "main": [
        [
          {
            "node": "Update to Admin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Menu Principal": {
      "main": [
        [
          {
            "node": "Update Volver Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agenda Menu Router": {
      "main": [
        [
          {
            "node": "Send Agenda Paso 1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Citas Usuario",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Citas Para Reprogramar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Citas Para Cancelar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Citas Para Completar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check Rol Para Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Agenda",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Agenda Paso 1": {
      "main": [
        [
          {
            "node": "Update Agenda Paso 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Citas Usuario": {
      "main": [
        [
          {
            "node": "Format Citas Lista",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Citas Lista": {
      "main": [
        [
          {
            "node": "Send Consultar Citas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Consultar Citas": {
      "main": [
        [
          {
            "node": "Update Session Consultar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agenda Wizard Router": {
      "main": [
        [
          {
            "node": "Cancelar?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cancelar 2?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cancelar 3?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cancelar 4?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Canal Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Confirmar Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Agenda",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar?": {
      "main": [
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Validar Fecha",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Fecha": {
      "main": [
        [
          {
            "node": "If Fecha Valida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Fecha Valida": {
      "main": [
        [
          {
            "node": "Set Fecha",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Fecha",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Fecha": {
      "main": [
        [
          {
            "node": "Update Paso 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Paso 2": {
      "main": [
        [
          {
            "node": "Send Paso 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar 2?": {
      "main": [
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Validar Hora",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Hora": {
      "main": [
        [
          {
            "node": "Set Hora",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Hora",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Hora": {
      "main": [
        [
          {
            "node": "Update Paso 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Paso 3": {
      "main": [
        [
          {
            "node": "Send Paso 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar 3?": {
      "main": [
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Nombre",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Nombre": {
      "main": [
        [
          {
            "node": "Update Paso 4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Paso 4": {
      "main": [
        [
          {
            "node": "Send Paso 4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar 4?": {
      "main": [
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Motivo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Motivo": {
      "main": [
        [
          {
            "node": "Update Paso 5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Paso 5": {
      "main": [
        [
          {
            "node": "Send Paso 5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Canal Router": {
      "main": [
        [
          {
            "node": "Set Presencial",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Virtual",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Llamada",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Agenda",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Presencial": {
      "main": [
        [
          {
            "node": "Update Paso 6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Virtual": {
      "main": [
        [
          {
            "node": "Update Paso 6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Llamada": {
      "main": [
        [
          {
            "node": "Update Paso 6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Paso 6": {
      "main": [
        [
          {
            "node": "Send Paso 6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Router": {
      "main": [
        [
          {
            "node": "Parse Cita",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Agenda Paso 1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Agenda",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Cita": {
      "main": [
        [
          {
            "node": "Check Doble Reserva",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Doble Reserva": {
      "main": [
        [
          {
            "node": "If No Existe Cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If No Existe Cita": {
      "main": [
        [
          {
            "node": "Guardar Cita",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Doble Reserva",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Cita": {
      "main": [
        [
          {
            "node": "Update After Cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update After Cita": {
      "main": [
        [
          {
            "node": "Cita OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cita OK": {
      "main": [
        [
          {
            "node": "Check Rol Para Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Volver Router": {
      "main": [
        [
          {
            "node": "Check Rol Para Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Option",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tareas Menu Router": {
      "main": [
        [
          {
            "node": "Send Tarea Paso 1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Tareas Pendientes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Tareas Completadas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Tareas Para Completar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Tareas Para Eliminar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check Rol Para Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Tarea Paso 1": {
      "main": [
        [
          {
            "node": "Update Tarea Paso 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Tareas Pendientes": {
      "main": [
        [
          {
            "node": "Format Tareas Pendientes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Tareas Pendientes": {
      "main": [
        [
          {
            "node": "Send Tareas Pendientes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Tareas Pendientes": {
      "main": [
        [
          {
            "node": "Update Session Ver Pendientes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ver Pendientes Router": {
      "main": [
        [
          {
            "node": "Send Tareas Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Ver Pendientes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Tareas Completadas": {
      "main": [
        [
          {
            "node": "Format Tareas Completadas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Tareas Completadas": {
      "main": [
        [
          {
            "node": "Send Tareas Completadas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Tareas Completadas": {
      "main": [
        [
          {
            "node": "Update Session Ver Completadas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ver Completadas Router": {
      "main": [
        [
          {
            "node": "Send Tareas Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Ver Completadas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Tareas Para Completar": {
      "main": [
        [
          {
            "node": "Format Lista Completar Tareas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Lista Completar Tareas": {
      "main": [
        [
          {
            "node": "Send Lista Completar Tareas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Lista Completar Tareas": {
      "main": [
        [
          {
            "node": "Update Session Completar Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Logic Seleccion Completar Tarea": {
      "main": [
        [
          {
            "node": "If Valid Completar Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Valid Completar Tarea": {
      "main": [
        [
          {
            "node": "Update Tarea Completada",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If Cancel Completar Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Tarea Completada": {
      "main": [
        [
          {
            "node": "Send Tarea Completada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Tarea Completada": {
      "main": [
        [
          {
            "node": "Update Session Tarea Completada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Cancel Completar Tarea": {
      "main": [
        [
          {
            "node": "Send Tareas Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Error Completar Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tarea Completada Router": {
      "main": [
        [
          {
            "node": "Send Tareas Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Tarea Completada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Tareas Para Eliminar": {
      "main": [
        [
          {
            "node": "Format Lista Eliminar Tareas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Lista Eliminar Tareas": {
      "main": [
        [
          {
            "node": "Send Lista Eliminar Tareas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Lista Eliminar Tareas": {
      "main": [
        [
          {
            "node": "Update Session Eliminar Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Logic Seleccion Eliminar Tarea": {
      "main": [
        [
          {
            "node": "If Valid Eliminar Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Valid Eliminar Tarea": {
      "main": [
        [
          {
            "node": "Delete Tarea",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "If Cancel Eliminar Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Tarea": {
      "main": [
        [
          {
            "node": "Send Tarea Eliminada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Tarea Eliminada": {
      "main": [
        [
          {
            "node": "Update Session Tarea Eliminada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Cancel Eliminar Tarea": {
      "main": [
        [
          {
            "node": "Send Tareas Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Error Eliminar Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tarea Eliminada Router": {
      "main": [
        [
          {
            "node": "Send Tareas Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Tarea Eliminada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tarea Wizard Router": {
      "main": [
        [
          {
            "node": "Cancelar Tarea?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cancelar Tarea 2?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cancelar Tarea 3?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar Tarea?": {
      "main": [
        [
          {
            "node": "Send Tareas Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Titulo Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Titulo Tarea": {
      "main": [
        [
          {
            "node": "Update Tarea Paso 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Tarea Paso 2": {
      "main": [
        [
          {
            "node": "Send Tarea Paso 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar Tarea 2?": {
      "main": [
        [
          {
            "node": "Send Tareas Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prioridad Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prioridad Router": {
      "main": [
        [
          {
            "node": "Set Prioridad Alta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Prioridad Media",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Prioridad Baja",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Prioridad Invalida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Prioridad Alta": {
      "main": [
        [
          {
            "node": "Update Tarea Paso 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Prioridad Media": {
      "main": [
        [
          {
            "node": "Update Tarea Paso 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Prioridad Baja": {
      "main": [
        [
          {
            "node": "Update Tarea Paso 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Tarea Paso 3": {
      "main": [
        [
          {
            "node": "Send Tarea Paso 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar Tarea 3?": {
      "main": [
        [
          {
            "node": "Send Tareas Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fecha Valida?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fecha Valida?": {
      "main": [
        [
          {
            "node": "Set Fecha Tarea",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Fecha Invalida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Fecha Tarea": {
      "main": [
        [
          {
            "node": "Parse Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Tarea": {
      "main": [
        [
          {
            "node": "Guardar Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Tarea": {
      "main": [
        [
          {
            "node": "Tarea OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tarea OK": {
      "main": [
        [
          {
            "node": "Update After Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update After Tarea": {
      "main": [
        [
          {
            "node": "Send Tareas Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Citas Para Reprogramar": {
      "main": [
        [
          {
            "node": "Format Lista Repro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Lista Repro": {
      "main": [
        [
          {
            "node": "Send Lista Para Reprogramar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Lista Para Reprogramar": {
      "main": [
        [
          {
            "node": "Update Session Repro 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Logic Seleccion Cita": {
      "main": [
        [
          {
            "node": "Send Solicitar Nueva Fecha",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Solicitar Nueva Fecha": {
      "main": [
        [
          {
            "node": "Update Session Repro 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Repro Data": {
      "main": [
        [
          {
            "node": "Update Cita DB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Cita DB": {
      "main": [
        [
          {
            "node": "Send Confirmacion Repro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Confirmacion Repro": {
      "main": [
        [
          {
            "node": "Update to Agenda Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Citas Para Cancelar": {
      "main": [
        [
          {
            "node": "Format Lista Cancel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Lista Cancel": {
      "main": [
        [
          {
            "node": "Send Lista Para Cancelar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Lista Para Cancelar": {
      "main": [
        [
          {
            "node": "Update Session Cancel 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Logic Seleccion Cancel": {
      "main": [
        [
          {
            "node": "If Valid Cancel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Valid Cancel": {
      "main": [
        [
          {
            "node": "Update Cita Cancelada",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Error Cancel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Cita Cancelada": {
      "main": [
        [
          {
            "node": "Send Confirmacion Cancel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Confirmacion Cancel": {
      "main": [
        [
          {
            "node": "Update Session Back Agenda",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Citas Para Completar": {
      "main": [
        [
          {
            "node": "Format Lista Completar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Lista Completar": {
      "main": [
        [
          {
            "node": "Send Lista Para Completar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Lista Para Completar": {
      "main": [
        [
          {
            "node": "Update Session Completar 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Logic Seleccion Completar": {
      "main": [
        [
          {
            "node": "If Valid Completar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Valid Completar": {
      "main": [
        [
          {
            "node": "Update Cita Completada",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Error Completar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Cita Completada": {
      "main": [
        [
          {
            "node": "Send Confirmacion Completar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Confirmacion Completar": {
      "main": [
        [
          {
            "node": "Update Session Back Agenda Completar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Usuario Rol": {
      "main": [
        [
          {
            "node": "If Es Admin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Es Admin": {
      "main": [
        [
          {
            "node": "Send Admin Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send No Permisos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Rol Para Menu": {
      "main": [
        [
          {
            "node": "If Admin Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Admin Menu": {
      "main": [
        [
          {
            "node": "Send Menu Principal",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Menu Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Menu Usuario": {
      "main": [
        [
          {
            "node": "Update Volver Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "7c123d1e-b30b-4951-9475-85d6990849d5",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "f9c95d1c6c5a88f42f809307f78f6486a001bde66068e0e4a3dd1b4652866230"
  },
  "id": "jJ7XgGYsF7CmC2HtBzYm2",
  "tags": []
}