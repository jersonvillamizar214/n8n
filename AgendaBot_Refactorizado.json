{
    "name": "AgendaBot Refactorizado",
    "nodes": [
        {
            "parameters": {
                "updates": [
                    "message"
                ]
            },
            "name": "Telegram Trigger",
            "type": "n8n-nodes-base.telegramTrigger",
            "typeVersion": 1.2,
            "position": [
                240,
                300
            ],
            "webhookId": "PLACEHOLDER",
            "credentials": {
                "telegramApi": {
                    "id": "PLACEHOLDER",
                    "name": "Telegram account"
                }
            }
        },
        {
            "parameters": {
                "assignments": {
                    "assignments": [
                        {
                            "id": "1",
                            "name": "telegram_user",
                            "value": "={{ $json.message.from.id }}",
                            "type": "string"
                        },
                        {
                            "id": "2",
                            "name": "chat_id",
                            "value": "={{ $json.message.chat.id }}",
                            "type": "string"
                        },
                        {
                            "id": "3",
                            "name": "mensaje",
                            "value": "={{ $json.message.text }}",
                            "type": "string"
                        },
                        {
                            "id": "4",
                            "name": "timestamp",
                            "value": "={{ new Date().toISOString() }}",
                            "type": "string"
                        }
                    ]
                }
            },
            "name": "Set Variables",
            "type": "n8n-nodes-base.set",
            "typeVersion": 3.4,
            "position": [
                460,
                300
            ]
        },
        {
            "parameters": {
                "documentId": {
                    "__rl": true,
                    "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
                    "mode": "id"
                },
                "sheetName": {
                    "__rl": true,
                    "mode": "name",
                    "value": "SESSIONS"
                },
                "filtersUI": {
                    "values": [
                        {
                            "lookupColumn": "telegram_user",
                            "lookupValue": "={{ $json.telegram_user }}"
                        }
                    ]
                },
                "options": {}
            },
            "name": "Get Session",
            "type": "n8n-nodes-base.googleSheets",
            "typeVersion": 4.5,
            "position": [
                680,
                300
            ],
            "alwaysOutputData": true,
            "credentials": {
                "googleSheetsOAuth2Api": {
                    "id": "PLACEHOLDER",
                    "name": "Google Sheets account"
                }
            }
        },
        {
            "parameters": {
                "conditions": {
                    "options": {
                        "caseSensitive": true,
                        "leftValue": "",
                        "typeValidation": "loose"
                    },
                    "conditions": [
                        {
                            "leftValue": "={{ $json.row_number }}",
                            "rightValue": "",
                            "operator": {
                                "type": "number",
                                "operation": "notEmpty"
                            }
                        }
                    ],
                    "combinator": "and"
                },
                "options": {}
            },
            "name": "Session Exists?",
            "type": "n8n-nodes-base.if",
            "typeVersion": 2.2,
            "position": [
                900,
                300
            ]
        },
        {
            "parameters": {
                "jsCode": "// Combinar datos de sesiÃ³n con variables del usuario\nconst setVarsData = $input.first();\nconst sessionData = $input.last();\n\n// Si hay datos de sesiÃ³n, combinarlos; si no, usar valores por defecto\nconst merged = {\n  ...setVarsData.json,\n  ...sessionData.json,\n  // Asegurar que siempre tengamos estos campos del input original\n  telegram_user: setVarsData.json.telegram_user,\n  chat_id: setVarsData.json.chat_id,\n  mensaje: setVarsData.json.mensaje,\n  timestamp: setVarsData.json.timestamp\n};\n\nreturn { json: merged };"
            },
            "name": "Merge Session Data",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1120,
                200
            ]
        },
        {
            "parameters": {
                "operation": "append",
                "documentId": {
                    "__rl": true,
                    "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
                    "mode": "id"
                },
                "sheetName": {
                    "__rl": true,
                    "mode": "name",
                    "value": "SESSIONS"
                },
                "columns": {
                    "mappingMode": "defineBelow",
                    "value": {
                        "telegram_user": "={{ $json.telegram_user }}",
                        "pantalla_actual": "menu_principal",
                        "paso_actual": "0",
                        "datos_parciales": "{}",
                        "timestamp_ultima_interaccion": "={{ $json.timestamp }}"
                    }
                },
                "options": {}
            },
            "name": "Create New Session",
            "type": "n8n-nodes-base.googleSheets",
            "typeVersion": 4.5,
            "position": [
                1120,
                420
            ],
            "credentials": {
                "googleSheetsOAuth2Api": {
                    "id": "PLACEHOLDER",
                    "name": "Google Sheets account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// ========================================\n// AGENDA BOT - PROCESADOR DE LÃ“GICA CENTRAL\n// ========================================\n\nconst userInput = $node[\"Set Variables\"].json;\nconst session = $node[\"Merge Session Data\"].json;\n\nconst msg = userInput.mensaje?.trim() || \"\";\nconst chatId = userInput.chat_id;\nconst telegramUser = userInput.telegram_user;\nconst timestamp = userInput.timestamp;\n\n// Estado actual\nlet pantalla = session.pantalla_actual || \"menu_principal\";\nlet paso = parseInt(session.paso_actual || \"0\");\nlet datos = {};\ntry {\n  datos = JSON.parse(session.datos_parciales || \"{}\");\n} catch(e) {\n  datos = {};\n}\n\n// Variables de salida\nlet mensaje = \"\";\nlet nextPantalla = pantalla;\nlet nextPaso = paso;\nlet nextDatos = datos;\nlet accion = \"mensaje\"; // mensaje | get_citas | update_cita | update_session\nlet dbConfig = null;\n\n// ========================================\n// MÃQUINA DE ESTADOS\n// ========================================\n\nswitch(pantalla) {\n  \n  // ============ MENÃš PRINCIPAL ============\n  case \"menu_principal\":\n    if (msg === \"1\") {\n      mensaje = \"ðŸ“… MENÃš DE AGENDA\\n\\n1ï¸âƒ£ Crear cita\\n2ï¸âƒ£ Ver citas pendientes\\n3ï¸âƒ£ Reprogramar cita\\n4ï¸âƒ£ Cancelar cita\\n5ï¸âƒ£ Completar cita\\n\\n9ï¸âƒ£ Volver al menÃº principal\";\n      nextPantalla = \"agenda_menu\";\n      nextPaso = 0;\n    } else if (msg === \"2\") {\n      mensaje = \"ðŸ“‹ MENÃš DE TAREAS\\n\\n(Funcionalidad en desarrollo)\\n\\n9ï¸âƒ£ Volver\";\n      nextPantalla = \"tareas_menu\";\n    } else if (msg === \"3\") {\n      mensaje = \"â“ MENÃš DE AYUDA\\n\\n(Funcionalidad en desarrollo)\\n\\n9ï¸âƒ£ Volver\";\n      nextPantalla = \"ayuda_menu\";\n    } else {\n      mensaje = \"ðŸ¤– Bienvenido al AgendaBot\\n\\n1ï¸âƒ£ Agenda\\n2ï¸âƒ£ Tareas\\n3ï¸âƒ£ Ayuda\\n\\nSelecciona una opciÃ³n:\";\n    }\n    break;\n\n  // ============ MENÃš DE AGENDA ============\n  case \"agenda_menu\":\n    if (msg === \"1\") {\n      mensaje = \"ðŸ“ CREAR CITA - Paso 1/5\\n\\nIngresa el nombre del cliente o tÃ­tulo de la cita:\\n\\n0ï¸âƒ£ Cancelar\";\n      nextPantalla = \"crear_cita\";\n      nextPaso = 1;\n      nextDatos = {};\n    } else if (msg === \"2\") {\n      accion = \"get_citas\";\n      dbConfig = {\n        table: \"CITAS\",\n        filters: [{column: \"creado_por\", value: telegramUser}, {column: \"estado\", value: \"pendiente\"}],\n        nextState: \"ver_citas\"\n      };\n    } else if (msg === \"3\") {\n      accion = \"get_citas\";\n      dbConfig = {\n        table: \"CITAS\",\n        filters: [{column: \"creado_por\", value: telegramUser}, {column: \"estado\", value: \"pendiente\"}],\n        nextState: \"reprogramar_cita\",\n        nextPaso: 1\n      };\n    } else if (msg === \"4\") {\n      accion = \"get_citas\";\n      dbConfig = {\n        table: \"CITAS\",\n        filters: [{column: \"creado_por\", value: telegramUser}, {column: \"estado\", value: \"pendiente\"}],\n        nextState: \"cancelar_cita\",\n        nextPaso: 1\n      };\n    } else if (msg === \"5\") {\n      accion = \"get_citas\";\n      dbConfig = {\n        table: \"CITAS\",\n        filters: [{column: \"creado_por\", value: telegramUser}, {column: \"estado\", value: \"pendiente\"}],\n        nextState: \"completar_cita\",\n        nextPaso: 1\n      };\n    } else if (msg === \"9\") {\n      mensaje = \"ðŸ¤– Bienvenido al AgendaBot\\n\\n1ï¸âƒ£ Agenda\\n2ï¸âƒ£ Tareas\\n3ï¸âƒ£ Ayuda\\n\\nSelecciona una opciÃ³n:\";\n      nextPantalla = \"menu_principal\";\n      nextPaso = 0;\n      nextDatos = {};\n    } else {\n      mensaje = \"âŒ OpciÃ³n no vÃ¡lida. Por favor selecciona 1-5 o 9.\";\n    }\n    break;\n\n  // ============ CREAR CITA (5 PASOS) ============\n  case \"crear_cita\":\n    if (msg === \"0\") {\n      mensaje = \"âŒ Proceso cancelado. Volviendo al menÃº de agenda...\\n\\nðŸ“… MENÃš DE AGENDA\\n\\n1ï¸âƒ£ Crear cita\\n2ï¸âƒ£ Ver citas pendientes\\n3ï¸âƒ£ Reprogramar cita\\n4ï¸âƒ£ Cancelar cita\\n5ï¸âƒ£ Completar cita\\n\\n9ï¸âƒ£ Volver al menÃº principal\";\n      nextPantalla = \"agenda_menu\";\n      nextPaso = 0;\n      nextDatos = {};\n    } else if (paso === 1) {\n      nextDatos.nombre = msg;\n      mensaje = \"ðŸ“… CREAR CITA - Paso 2/5\\n\\nIngresa la fecha de la cita:\\nFormato: YYYY-MM-DD (ej: 2026-02-15)\\n\\n0ï¸âƒ£ Cancelar\";\n      nextPaso = 2;\n    } else if (paso === 2) {\n      if (!/^\\d{4}-\\d{2}-\\d{2}$/.test(msg)) {\n        mensaje = \"âŒ Formato invÃ¡lido. Usa YYYY-MM-DD (ej: 2026-02-15)\\n\\n0ï¸âƒ£ Cancelar\";\n      } else {\n        nextDatos.fecha = msg;\n        mensaje = \"ðŸ• CREAR CITA - Paso 3/5\\n\\nIngresa la hora de la cita:\\nFormato: HH:MM (ej: 14:30)\\n\\n0ï¸âƒ£ Cancelar\";\n        nextPaso = 3;\n      }\n    } else if (paso === 3) {\n      if (!/^\\d{2}:\\d{2}$/.test(msg)) {\n        mensaje = \"âŒ Formato invÃ¡lido. Usa HH:MM (ej: 14:30)\\n\\n0ï¸âƒ£ Cancelar\";\n      } else {\n        nextDatos.hora = msg;\n        mensaje = \"ðŸ“‹ CREAR CITA - Paso 4/5\\n\\nIngresa el motivo de la cita:\\n(ej: Consulta, Seguimiento, RevisiÃ³n)\\n\\n0ï¸âƒ£ Cancelar\";\n        nextPaso = 4;\n      }\n    } else if (paso === 4) {\n      nextDatos.motivo = msg;\n      mensaje = \"ðŸ“ž CREAR CITA - Paso 5/5\\n\\nSelecciona el canal:\\n\\n1ï¸âƒ£ Presencial\\n2ï¸âƒ£ Virtual\\n3ï¸âƒ£ Llamada\\n\\n0ï¸âƒ£ Cancelar\";\n      nextPaso = 5;\n    } else if (paso === 5) {\n      let canal = \"\";\n      if (msg === \"1\") canal = \"Presencial\";\n      else if (msg === \"2\") canal = \"Virtual\";\n      else if (msg === \"3\") canal = \"Llamada\";\n      \n      if (!canal) {\n        mensaje = \"âŒ OpciÃ³n no vÃ¡lida. Selecciona 1-3 o 0 para cancelar.\";\n      } else {\n        nextDatos.canal = canal;\n        accion = \"crear_cita\";\n        dbConfig = {\n          table: \"CITAS\",\n          data: {\n            id_cita: `CITA-${Date.now()}`,\n            nombre: nextDatos.nombre,\n            fecha: nextDatos.fecha,\n            hora: nextDatos.hora,\n            motivo: nextDatos.motivo,\n            canal: nextDatos.canal,\n            estado: \"pendiente\",\n            creado_por: telegramUser,\n            timestamp_creacion: timestamp\n          }\n        };\n        mensaje = `âœ… Â¡Cita creada exitosamente!\\n\\nðŸ“‹ ${nextDatos.nombre}\\nðŸ“… ${nextDatos.fecha} a las ${nextDatos.hora}\\nðŸ“ ${nextDatos.motivo} (${nextDatos.canal})\\n\\nVolviendo al menÃº de agenda...`;\n        nextPantalla = \"agenda_menu\";\n        nextPaso = 0;\n        nextDatos = {};\n      }\n    }\n    break;\n\n  // ============ VER CITAS ============\n  case \"ver_citas\":\n    const citas = datos.citas || [];\n    if (citas.length === 0) {\n      mensaje = \"âŒ No tienes citas pendientes.\\n\\n0ï¸âƒ£ Volver al menÃº de agenda\";\n    } else {\n      mensaje = \"ðŸ“‹ CITAS PENDIENTES:\\n\\n\";\n      citas.forEach((c, i) => {\n        mensaje += `${i+1}ï¸âƒ£ ${c.nombre}\\n   ðŸ“… ${c.fecha} a las ${c.hora}\\n   ðŸ“ ${c.motivo} (${c.canal})\\n\\n`;\n      });\n      mensaje += \"0ï¸âƒ£ Volver\";\n    }\n    \n    if (msg === \"0\" || msg === \"9\") {\n      mensaje = \"ðŸ“… MENÃš DE AGENDA\\n\\n1ï¸âƒ£ Crear cita\\n2ï¸âƒ£ Ver citas pendientes\\n3ï¸âƒ£ Reprogramar cita\\n4ï¸âƒ£ Cancelar cita\\n5ï¸âƒ£ Completar cita\\n\\n9ï¸âƒ£ Volver al menÃº principal\";\n      nextPantalla = \"agenda_menu\";\n      nextPaso = 0;\n      nextDatos = {};\n    }\n    break;\n\n  // ============ REPROGRAMAR CITA ============\n  case \"reprogramar_cita\":\n    const citasRepr = datos.citas || [];\n    \n    if (paso === 1) {\n      if (citasRepr.length === 0) {\n        mensaje = \"âŒ No tienes citas pendientes para reprogramar.\\n\\n0ï¸âƒ£ Volver al menÃº de agenda\";\n        if (msg === \"0\") {\n          mensaje = \"ðŸ“… MENÃš DE AGENDA\\n\\n1ï¸âƒ£ Crear cita\\n2ï¸âƒ£ Ver citas pendientes\\n3ï¸âƒ£ Reprogramar cita\\n4ï¸âƒ£ Cancelar cita\\n5ï¸âƒ£ Completar cita\\n\\n9ï¸âƒ£ Volver al menÃº principal\";\n          nextPantalla = \"agenda_menu\";\n          nextPaso = 0;\n          nextDatos = {};\n        }\n      } else {\n        mensaje = \"ðŸ”„ REPROGRAMAR CITA\\n\\nSelecciona el nÃºmero de la cita que deseas reprogramar:\\n\\n\";\n        citasRepr.forEach((c, i) => {\n          mensaje += `${i+1}ï¸âƒ£ ${c.nombre}\\n   ðŸ“… ${c.fecha} a las ${c.hora}\\n   ðŸ“ ${c.motivo} (${c.canal})\\n\\n`;\n        });\n        mensaje += \"0ï¸âƒ£ Cancelar\";\n        \n        if (msg === \"0\") {\n          mensaje = \"ðŸ“… MENÃš DE AGENDA\\n\\n1ï¸âƒ£ Crear cita\\n2ï¸âƒ£ Ver citas pendientes\\n3ï¸âƒ£ Reprogramar cita\\n4ï¸âƒ£ Cancelar cita\\n5ï¸âƒ£ Completar cita\\n\\n9ï¸âƒ£ Volver al menÃº principal\";\n          nextPantalla = \"agenda_menu\";\n          nextPaso = 0;\n          nextDatos = {};\n        } else {\n          const num = parseInt(msg);\n          if (!isNaN(num) && num >= 1 && num <= citasRepr.length) {\n            nextDatos.cita_seleccionada = num - 1;\n            mensaje = `ðŸ“… NUEVA FECHA\\n\\nIngresa la nueva fecha para la cita:\\n${citasRepr[num-1].nombre}\\n\\nFormato: YYYY-MM-DD (ejemplo: 2026-02-15)\\n\\n0ï¸âƒ£ Cancelar`;\n            nextPaso = 2;\n          } else if (msg && msg !== \"0\") {\n            mensaje = \"âŒ SelecciÃ³n invÃ¡lida. Por favor ingresa un nÃºmero vÃ¡lido de la lista.\";\n          }\n        }\n      }\n    } else if (paso === 2) {\n      if (msg === \"0\") {\n        mensaje = \"ðŸ“… MENÃš DE AGENDA\\n\\n1ï¸âƒ£ Crear cita\\n2ï¸âƒ£ Ver citas pendientes\\n3ï¸âƒ£ Reprogramar cita\\n4ï¸âƒ£ Cancelar cita\\n5ï¸âƒ£ Completar cita\\n\\n9ï¸âƒ£ Volver al menÃº principal\";\n        nextPantalla = \"agenda_menu\";\n        nextPaso = 0;\n        nextDatos = {};\n      } else if (!/^\\d{4}-\\d{2}-\\d{2}$/.test(msg)) {\n        mensaje = \"âŒ Formato invÃ¡lido. Por favor verifica e intenta nuevamente.\";\n      } else {\n        nextDatos.fecha_nueva = msg;\n        mensaje = \"ðŸ• NUEVA HORA\\n\\nIngresa la nueva hora para la cita:\\n\\nFormato: HH:MM (ejemplo: 14:30)\\n\\n0ï¸âƒ£ Cancelar\";\n        nextPaso = 3;\n      }\n    } else if (paso === 3) {\n      if (msg === \"0\") {\n        mensaje = \"ðŸ“… MENÃš DE AGENDA\\n\\n1ï¸âƒ£ Crear cita\\n2ï¸âƒ£ Ver citas pendientes\\n3ï¸âƒ£ Reprogramar cita\\n4ï¸âƒ£ Cancelar cita\\n5ï¸âƒ£ Completar cita\\n\\n9ï¸âƒ£ Volver al menÃº principal\";\n        nextPantalla = \"agenda_menu\";\n        nextPaso = 0;\n        nextDatos = {};\n      } else if (!/^\\d{2}:\\d{2}$/.test(msg)) {\n        mensaje = \"âŒ Formato invÃ¡lido. Por favor verifica e intenta nuevamente.\";\n      } else {\n        const citaSel = citasRepr[nextDatos.cita_seleccionada];\n        accion = \"update_cita\";\n        dbConfig = {\n          table: \"CITAS\",\n          idColumn: \"id_cita\",\n          idValue: citaSel.id_cita,\n          data: {\n            fecha: nextDatos.fecha_nueva,\n            hora: msg\n          }\n        };\n        mensaje = `âœ… Cita reprogramada exitosamente\\n\\nðŸ“‹ ${citaSel.nombre}\\nðŸ“… Nueva fecha: ${nextDatos.fecha_nueva} a las ${msg}\\n\\nVolviendo al menÃº de agenda...`;\n        nextPantalla = \"agenda_menu\";\n        nextPaso = 0;\n        nextDatos = {};\n      }\n    }\n    break;\n\n  // ============ CANCELAR CITA ============\n  case \"cancelar_cita\":\n    const citasCanc = datos.citas || [];\n    \n    if (paso === 1) {\n      if (citasCanc.length === 0) {\n        mensaje = \"âŒ No tienes citas pendientes para cancelar.\\n\\n0ï¸âƒ£ Volver al menÃº de agenda\";\n        if (msg === \"0\") {\n          mensaje = \"ðŸ“… MENÃš DE AGENDA\\n\\n1ï¸âƒ£ Crear cita\\n2ï¸âƒ£ Ver citas pendientes\\n3ï¸âƒ£ Reprogramar cita\\n4ï¸âƒ£ Cancelar cita\\n5ï¸âƒ£ Completar cita\\n\\n9ï¸âƒ£ Volver al menÃº principal\";\n          nextPantalla = \"agenda_menu\";\n          nextPaso = 0;\n          nextDatos = {};\n        }\n      } else {\n        mensaje = \"âŒ CANCELAR CITA\\n\\nSelecciona el nÃºmero de la cita que deseas cancelar:\\n\\n\";\n        citasCanc.forEach((c, i) => {\n          mensaje += `${i+1}ï¸âƒ£ ${c.nombre}\\n   ðŸ“… ${c.fecha} a las ${c.hora}\\n   ðŸ“ ${c.motivo} (${c.canal})\\n\\n`;\n        });\n        mensaje += \"0ï¸âƒ£ Volver\";\n        \n        if (msg === \"0\") {\n          mensaje = \"ðŸ“… MENÃš DE AGENDA\\n\\n1ï¸âƒ£ Crear cita\\n2ï¸âƒ£ Ver citas pendientes\\n3ï¸âƒ£ Reprogramar cita\\n4ï¸âƒ£ Cancelar cita\\n5ï¸âƒ£ Completar cita\\n\\n9ï¸âƒ£ Volver al menÃº principal\";\n          nextPantalla = \"agenda_menu\";\n          nextPaso = 0;\n          nextDatos = {};\n        } else {\n          const num = parseInt(msg);\n          if (!isNaN(num) && num >= 1 && num <= citasCanc.length) {\n            nextDatos.cita_seleccionada = num - 1;\n            const citaSel = citasCanc[num-1];\n            mensaje = `âš ï¸ Â¿EstÃ¡s seguro de que deseas cancelar esta cita?\\n\\nðŸ“‹ ${citaSel.nombre}\\nðŸ“… ${citaSel.fecha} a las ${citaSel.hora}\\n\\n1ï¸âƒ£ SÃ­, cancelar\\n2ï¸âƒ£ No, volver`;\n            nextPaso = 2;\n          } else if (msg && msg !== \"0\") {\n            mensaje = \"âŒ SelecciÃ³n invÃ¡lida. Por favor ingresa un nÃºmero vÃ¡lido de la lista.\";\n          }\n        }\n      }\n    } else if (paso === 2) {\n      if (msg === \"1\") {\n        const citaSel = citasCanc[nextDatos.cita_seleccionada];\n        accion = \"update_cita\";\n        dbConfig = {\n          table: \"CITAS\",\n          idColumn: \"id_cita\",\n          idValue: citaSel.id_cita,\n          data: {\n            estado: \"cancelada\"\n          }\n        };\n        mensaje = `âœ… Cita cancelada exitosamente\\n\\nðŸ“‹ ${citaSel.nombre}\\n\\nVolviendo al menÃº de agenda...`;\n        nextPantalla = \"agenda_menu\";\n        nextPaso = 0;\n        nextDatos = {};\n      } else if (msg === \"2\" || msg === \"0\") {\n        mensaje = \"ðŸ“… MENÃš DE AGENDA\\n\\n1ï¸âƒ£ Crear cita\\n2ï¸âƒ£ Ver citas pendientes\\n3ï¸âƒ£ Reprogramar cita\\n4ï¸âƒ£ Cancelar cita\\n5ï¸âƒ£ Completar cita\\n\\n9ï¸âƒ£ Volver al menÃº principal\";\n        nextPantalla = \"agenda_menu\";\n        nextPaso = 0;\n        nextDatos = {};\n      } else {\n        mensaje = \"âŒ OpciÃ³n no vÃ¡lida. Selecciona 1 (SÃ­) o 2 (No).\";\n      }\n    }\n    break;\n\n  // ============ COMPLETAR CITA ============\n  case \"completar_cita\":\n    const citasComp = datos.citas || [];\n    \n    if (paso === 1) {\n      if (citasComp.length === 0) {\n        mensaje = \"âŒ No tienes citas pendientes para completar.\\n\\n0ï¸âƒ£ Volver al menÃº de agenda\";\n        if (msg === \"0\") {\n          mensaje = \"ðŸ“… MENÃš DE AGENDA\\n\\n1ï¸âƒ£ Crear cita\\n2ï¸âƒ£ Ver citas pendientes\\n3ï¸âƒ£ Reprogramar cita\\n4ï¸âƒ£ Cancelar cita\\n5ï¸âƒ£ Completar cita\\n\\n9ï¸âƒ£ Volver al menÃº principal\";\n          nextPantalla = \"agenda_menu\";\n          nextPaso = 0;\n          nextDatos = {};\n        }\n      } else {\n        mensaje = \"âœ… COMPLETAR CITA\\n\\nSelecciona el nÃºmero de la cita que deseas marcar como completada:\\n\\n\";\n        citasComp.forEach((c, i) => {\n          mensaje += `${i+1}ï¸âƒ£ ${c.nombre}\\n   ðŸ“… ${c.fecha} a las ${c.hora}\\n   ðŸ“ ${c.motivo} (${c.canal})\\n\\n`;\n        });\n        mensaje += \"0ï¸âƒ£ Volver\";\n        \n        if (msg === \"0\") {\n          mensaje = \"ðŸ“… MENÃš DE AGENDA\\n\\n1ï¸âƒ£ Crear cita\\n2ï¸âƒ£ Ver citas pendientes\\n3ï¸âƒ£ Reprogramar cita\\n4ï¸âƒ£ Cancelar cita\\n5ï¸âƒ£ Completar cita\\n\\n9ï¸âƒ£ Volver al menÃº principal\";\n          nextPantalla = \"agenda_menu\";\n          nextPaso = 0;\n          nextDatos = {};\n        } else {\n          const num = parseInt(msg);\n          if (!isNaN(num) && num >= 1 && num <= citasComp.length) {\n            const citaSel = citasComp[num-1];\n            accion = \"update_cita\";\n            dbConfig = {\n              table: \"CITAS\",\n              idColumn: \"id_cita\",\n              idValue: citaSel.id_cita,\n              data: {\n                estado: \"completada\"\n              }\n            };\n            mensaje = `âœ… Â¡Cita completada exitosamente!\\n\\nðŸ“‹ ${citaSel.nombre}\\n\\nVolviendo al menÃº de agenda...`;\n            nextPantalla = \"agenda_menu\";\n            nextPaso = 0;\n            nextDatos = {};\n          } else if (msg && msg !== \"0\") {\n            mensaje = \"âŒ SelecciÃ³n invÃ¡lida. Por favor ingresa un nÃºmero vÃ¡lido de la lista.\";\n          }\n        }\n      }\n    }\n    break;\n\n  // ============ OTROS MENÃšS ============\n  case \"tareas_menu\":\n  case \"ayuda_menu\":\n    if (msg === \"9\" || msg === \"0\") {\n      mensaje = \"ðŸ¤– Bienvenido al AgendaBot\\n\\n1ï¸âƒ£ Agenda\\n2ï¸âƒ£ Tareas\\n3ï¸âƒ£ Ayuda\\n\\nSelecciona una opciÃ³n:\";\n      nextPantalla = \"menu_principal\";\n      nextPaso = 0;\n      nextDatos = {};\n    }\n    break;\n\n  default:\n    mensaje = \"ðŸ¤– Bienvenido al AgendaBot\\n\\n1ï¸âƒ£ Agenda\\n2ï¸âƒ£ Tareas\\n3ï¸âƒ£ Ayuda\\n\\nSelecciona una opciÃ³n:\";\n    nextPantalla = \"menu_principal\";\n    nextPaso = 0;\n    nextDatos = {};\n}\n\n// ========================================\n// SALIDA\n// ========================================\n\nreturn {\n  json: {\n    chat_id: chatId,\n    mensaje: mensaje,\n    accion: accion,\n    nextState: {\n      telegram_user: telegramUser,\n      pantalla_actual: nextPantalla,\n      paso_actual: nextPaso.toString(),\n      datos_parciales: JSON.stringify(nextDatos),\n      timestamp_ultima_interaccion: timestamp\n    },\n    dbConfig: dbConfig\n  }\n};"
            },
            "name": "Logic Processor",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                1340,
                200
            ]
        },
        {
            "parameters": {
                "rules": {
                    "values": [
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "loose"
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.accion }}",
                                        "rightValue": "get_citas",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "get_citas"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "loose"
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.accion }}",
                                        "rightValue": "crear_cita",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "crear_cita"
                        },
                        {
                            "conditions": {
                                "options": {
                                    "caseSensitive": true,
                                    "leftValue": "",
                                    "typeValidation": "loose"
                                },
                                "conditions": [
                                    {
                                        "leftValue": "={{ $json.accion }}",
                                        "rightValue": "update_cita",
                                        "operator": {
                                            "type": "string",
                                            "operation": "equals"
                                        }
                                    }
                                ],
                                "combinator": "and"
                            },
                            "renameOutput": true,
                            "outputKey": "update_cita"
                        }
                    ]
                },
                "options": {
                    "fallbackOutput": "extra"
                }
            },
            "name": "Action Router",
            "type": "n8n-nodes-base.switch",
            "typeVersion": 3.2,
            "position": [
                1560,
                200
            ]
        },
        {
            "parameters": {
                "documentId": {
                    "__rl": true,
                    "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
                    "mode": "id"
                },
                "sheetName": {
                    "__rl": true,
                    "mode": "name",
                    "value": "={{ $json.dbConfig.table }}"
                },
                "filtersUI": {
                    "values": "={{ $json.dbConfig.filters.map(f => ({ lookupColumn: f.column, lookupValue: f.value })) }}"
                },
                "options": {}
            },
            "name": "Get Citas",
            "type": "n8n-nodes-base.googleSheets",
            "typeVersion": 4.5,
            "position": [
                1780,
                80
            ],
            "alwaysOutputData": true,
            "credentials": {
                "googleSheetsOAuth2Api": {
                    "id": "PLACEHOLDER",
                    "name": "Google Sheets account"
                }
            }
        },
        {
            "parameters": {
                "operation": "append",
                "documentId": {
                    "__rl": true,
                    "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
                    "mode": "id"
                },
                "sheetName": {
                    "__rl": true,
                    "mode": "name",
                    "value": "={{ $('Logic Processor').item.json.dbConfig.table }}"
                },
                "columns": {
                    "mappingMode": "defineBelow",
                    "value": "={{ $('Logic Processor').item.json.dbConfig.data }}"
                },
                "options": {}
            },
            "name": "Create Cita",
            "type": "n8n-nodes-base.googleSheets",
            "typeVersion": 4.5,
            "position": [
                1780,
                200
            ],
            "credentials": {
                "googleSheetsOAuth2Api": {
                    "id": "PLACEHOLDER",
                    "name": "Google Sheets account"
                }
            }
        },
        {
            "parameters": {
                "operation": "update",
                "documentId": {
                    "__rl": true,
                    "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
                    "mode": "id"
                },
                "sheetName": {
                    "__rl": true,
                    "mode": "name",
                    "value": "={{ $('Logic Processor').item.json.dbConfig.table }}"
                },
                "columns": {
                    "mappingMode": "defineBelow",
                    "value": "={{ Object.assign({}, $('Logic Processor').item.json.dbConfig.data, { [$('Logic Processor').item.json.dbConfig.idColumn]: $('Logic Processor').item.json.dbConfig.idValue }) }}",
                    "matchingColumns": "={{ [$('Logic Processor').item.json.dbConfig.idColumn] }}"
                },
                "options": {}
            },
            "name": "Update Cita",
            "type": "n8n-nodes-base.googleSheets",
            "typeVersion": 4.5,
            "position": [
                1780,
                320
            ],
            "credentials": {
                "googleSheetsOAuth2Api": {
                    "id": "PLACEHOLDER",
                    "name": "Google Sheets account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// Procesar las citas obtenidas y actualizar el estado\nconst logicData = $node[\"Logic Processor\"].json;\nconst citasRaw = $input.all();\nconst citas = citasRaw.map(c => c.json);\n\nconst nextState = logicData.dbConfig.nextState;\nconst nextPaso = logicData.dbConfig.nextPaso || 1;\n\nreturn {\n  json: {\n    ...logicData,\n    nextState: {\n      ...logicData.nextState,\n      pantalla_actual: nextState,\n      paso_actual: nextPaso.toString(),\n      datos_parciales: JSON.stringify({ citas: citas })\n    }\n  }\n};"
            },
            "name": "Process Citas",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                2000,
                80
            ]
        },
        {
            "parameters": {
                "operation": "update",
                "documentId": {
                    "__rl": true,
                    "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
                    "mode": "id"
                },
                "sheetName": {
                    "__rl": true,
                    "mode": "name",
                    "value": "SESSIONS"
                },
                "columns": {
                    "mappingMode": "defineBelow",
                    "value": {
                        "telegram_user": "={{ $json.nextState.telegram_user }}",
                        "pantalla_actual": "={{ $json.nextState.pantalla_actual }}",
                        "paso_actual": "={{ $json.nextState.paso_actual }}",
                        "datos_parciales": "={{ $json.nextState.datos_parciales }}",
                        "timestamp_ultima_interaccion": "={{ $json.nextState.timestamp_ultima_interaccion }}"
                    },
                    "matchingColumns": [
                        "telegram_user"
                    ]
                },
                "options": {}
            },
            "name": "Update Session",
            "type": "n8n-nodes-base.googleSheets",
            "typeVersion": 4.5,
            "position": [
                2220,
                200
            ],
            "credentials": {
                "googleSheetsOAuth2Api": {
                    "id": "PLACEHOLDER",
                    "name": "Google Sheets account"
                }
            }
        },
        {
            "parameters": {
                "jsCode": "// Recuperar chat_id y mensaje del Logic Processor\nconst logicData = $node[\"Logic Processor\"].json;\n\nreturn {\n  json: {\n    chat_id: logicData.chat_id,\n    mensaje: logicData.mensaje\n  }\n};"
            },
            "name": "Prepare Message",
            "type": "n8n-nodes-base.code",
            "typeVersion": 2,
            "position": [
                2440,
                200
            ]
        },
        {
            "parameters": {
                "chatId": "={{ $json.chat_id }}",
                "text": "={{ $json.mensaje }}",
                "additionalFields": {}
            },
            "name": "Send Message",
            "type": "n8n-nodes-base.telegram",
            "typeVersion": 1.2,
            "position": [
                2660,
                200
            ],
            "credentials": {
                "telegramApi": {
                    "id": "PLACEHOLDER",
                    "name": "Telegram account"
                }
            }
        }
    ],
    "connections": {
        "Telegram Trigger": {
            "main": [
                [
                    {
                        "node": "Set Variables",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Set Variables": {
            "main": [
                [
                    {
                        "node": "Get Session",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "Merge Session Data",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Session": {
            "main": [
                [
                    {
                        "node": "Session Exists?",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Session Exists?": {
            "main": [
                [
                    {
                        "node": "Merge Session Data",
                        "type": "main",
                        "index": 1
                    }
                ],
                [
                    {
                        "node": "Create New Session",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Merge Session Data": {
            "main": [
                [
                    {
                        "node": "Logic Processor",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Create New Session": {
            "main": [
                [
                    {
                        "node": "Merge Session Data",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Logic Processor": {
            "main": [
                [
                    {
                        "node": "Action Router",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Action Router": {
            "main": [
                [
                    {
                        "node": "Get Citas",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Create Cita",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Update Cita",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Update Session",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get Citas": {
            "main": [
                [
                    {
                        "node": "Process Citas",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Create Cita": {
            "main": [
                [
                    {
                        "node": "Update Session",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Update Cita": {
            "main": [
                [
                    {
                        "node": "Update Session",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Process Citas": {
            "main": [
                [
                    {
                        "node": "Update Session",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Update Session": {
            "main": [
                [
                    {
                        "node": "Prepare Message",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Prepare Message": {
            "main": [
                [
                    {
                        "node": "Send Message",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "pinData": {},
    "active": false,
    "settings": {
        "executionOrder": "v1"
    },
    "versionId": "",
    "meta": {
        "templateCredsSetupCompleted": true
    },
    "id": "",
    "tags": []
}