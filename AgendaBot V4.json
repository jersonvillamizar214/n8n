{
  "name": "AgendaBot V4",
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "name": "Telegram Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [
        -5760,
        9024
      ],
      "id": "5c561725-c08c-4325-be06-f931083def64",
      "webhookId": "315bfef2-ef88-45c3-99a7-a1e7ee093b99",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "telegram_user",
              "name": "telegram_user",
              "value": "={{ String($json.message.from.id) }}",
              "type": "string"
            },
            {
              "id": "username",
              "name": "username",
              "value": "={{ $json.message.from.first_name || $json.message.from.username || 'Usuario' }}",
              "type": "string"
            },
            {
              "id": "mensaje",
              "name": "mensaje",
              "value": "={{ ($json.message.text || '').trim() }}",
              "type": "string"
            },
            {
              "id": "chat_id",
              "name": "chat_id",
              "value": "={{ String($json.message.chat.id) }}",
              "type": "string"
            },
            {
              "id": "timestamp",
              "name": "timestamp",
              "value": "={{ new Date().toISOString() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "name": "Set Variables",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5520,
        9024
      ],
      "id": "cf3ea55d-fa9c-419e-b852-cb974ba0eb95"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit?usp=drivesdk",
          "mode": "url"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "SESSIONS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "=telegram_user",
              "lookupValue": "={{ $json.telegram_user }}"
            }
          ]
        },
        "options": {}
      },
      "name": "Get Session",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -5312,
        9024
      ],
      "alwaysOutputData": true,
      "id": "a24573c4-a426-4383-8404-c5fa67c1d384",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "session-exists",
              "leftValue": "={{ $json.pantalla_actual }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "Session Exists?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5088,
        9024
      ],
      "id": "dd90bf2c-555a-41a2-bbbb-6182c4b23ef4"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "telegram_user",
              "name": "telegram_user",
              "value": "={{ $('Set Variables').item.json.telegram_user }}",
              "type": "string"
            },
            {
              "id": "chat_id",
              "name": "chat_id",
              "value": "={{ $('Set Variables').item.json.chat_id }}",
              "type": "string"
            },
            {
              "id": "mensaje",
              "name": "mensaje",
              "value": "={{ $('Set Variables').item.json.mensaje }}",
              "type": "string"
            },
            {
              "id": "username",
              "name": "username",
              "value": "={{ $('Set Variables').item.json.username }}",
              "type": "string"
            },
            {
              "id": "timestamp",
              "name": "timestamp",
              "value": "={{ $('Set Variables').item.json.timestamp }}",
              "type": "string"
            },
            {
              "id": "pantalla_actual",
              "name": "pantalla_actual",
              "value": "={{ $json.pantalla_actual || 'menu_principal' }}",
              "type": "string"
            },
            {
              "id": "paso_actual",
              "name": "paso_actual",
              "value": "={{ $json.paso_actual || '0' }}",
              "type": "string"
            },
            {
              "id": "datos_parciales",
              "name": "datos_parciales",
              "value": "={{ $json.datos_parciales || '{}' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "name": "Merge Session Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -4864,
        8928
      ],
      "id": "d3055c5d-cda1-455f-9ebc-029a278998da"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "telegram_user",
              "name": "telegram_user",
              "value": "={{ $('Set Variables').item.json.telegram_user }}",
              "type": "string"
            },
            {
              "id": "chat_id",
              "name": "chat_id",
              "value": "={{ $('Set Variables').item.json.chat_id }}",
              "type": "string"
            },
            {
              "id": "mensaje",
              "name": "mensaje",
              "value": "={{ $('Set Variables').item.json.mensaje }}",
              "type": "string"
            },
            {
              "id": "username",
              "name": "username",
              "value": "={{ $('Set Variables').item.json.username }}",
              "type": "string"
            },
            {
              "id": "timestamp",
              "name": "timestamp",
              "value": "={{ $('Set Variables').item.json.timestamp }}",
              "type": "string"
            },
            {
              "id": "pantalla_actual",
              "name": "pantalla_actual",
              "value": "nuevo_usuario",
              "type": "string"
            },
            {
              "id": "paso_actual",
              "name": "paso_actual",
              "value": "0",
              "type": "string"
            },
            {
              "id": "datos_parciales",
              "name": "datos_parciales",
              "value": "{}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "name": "Set New User Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -4864,
        9120
      ],
      "id": "1ee57b52-ed4b-48a5-bbd4-a826114f3a7d"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 319260215,
          "mode": "list",
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1hotrf-91CoJyrer3T8fgQzWAZaC6NZn-FfVSDZtKUn8/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $json.telegram_user }}",
            "pantalla_actual": "={{ $json.pantalla_actual }}",
            "paso_actual": "={{ $json.paso_actual }}",
            "datos_parciales": "={{ $json.datos_parciales }}",
            "timestamp_ultima_interaccion": "={{ $json.timestamp }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "telegram_user",
              "displayName": "telegram_user",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pantalla_actual",
              "displayName": "pantalla_actual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "paso_actual",
              "displayName": "paso_actual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "datos_parciales",
              "displayName": "datos_parciales",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "timestamp_ultima_interaccion",
              "displayName": "timestamp_ultima_interaccion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "name": "Create New Session",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -4640,
        9120
      ],
      "id": "1f848e5c-b353-472a-abd4-99b2db9475c3",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 2000502643,
          "mode": "list",
          "cachedResultName": "LOGS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1hotrf-91CoJyrer3T8fgQzWAZaC6NZn-FfVSDZtKUn8/edit#gid=2000502643"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "timestamp": "={{ $json.timestamp }}",
            "telegram_user": "={{ $json.telegram_user }}",
            "pantalla": "={{ $json.pantalla_actual }}",
            "opcion_elegida": "={{ $json.mensaje }}",
            "resultado": "procesando"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "telegram_user",
              "displayName": "telegram_user",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pantalla",
              "displayName": "pantalla",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "opcion_elegida",
              "displayName": "opcion_elegida",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "resultado",
              "displayName": "resultado",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "name": "Log Interaction",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -4432,
        9024
      ],
      "id": "5bf9562d-99a4-4ca3-9c86-bfe137454d63",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "=Hola {{ $json.username }}, soy AgendaBot üëã\n\nEstoy aqu√≠ para ayudarte a organizar tus citas, tareas y recordatorios de forma sencilla y sin complicaciones.\n\nPuedes escribirme en cualquier momento.\nPara avanzar, solo tienes que escribir el n√∫mero de la opci√≥n que quieras usar.\n\nMen√∫ principal:\n0. Ayuda\n1. Agenda (citas)\n2. Tareas\n3. Recordatorios\n4. H√°bitos\n5. Listas\n6. Reportes\n7. Configuraci√≥n\n8. Administrador\n\nüí° Tip: escribe solo el n√∫mero (ej: 1) y presiona enviar.",
        "additionalFields": {}
      },
      "name": "Send Bienvenida",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3584,
        7472
      ],
      "id": "12a3a1fc-f11e-4bf2-84b3-39cc308d6c28",
      "webhookId": "0b991700-52cf-4a0a-9d29-941fd691a3d3",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": 319260215,
          "mode": "list",
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1hotrf-91CoJyrer3T8fgQzWAZaC6NZn-FfVSDZtKUn8/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $json.telegram_user }}",
            "pantalla_actual": "menu_principal",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ],
          "schema": [
            {
              "id": "telegram_user",
              "displayName": "telegram_user",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "pantalla_actual",
              "displayName": "pantalla_actual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "paso_actual",
              "displayName": "paso_actual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "datos_parciales",
              "displayName": "datos_parciales",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "timestamp_ultima_interaccion",
              "displayName": "timestamp_ultima_interaccion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "name": "Update Session to Menu",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -3200,
        7424
      ],
      "id": "fa600fb3-e5ea-43ef-9e18-d4d5a54876a2",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "fcf71e05-8000-4cf2-bc68-c48b3f232755",
              "name": "=telegram_user",
              "value": "={{ $('Set Variables').item.json.telegram_user }}",
              "type": "string"
            },
            {
              "id": "78e868ab-851a-4b9c-81a6-79cfb640560d",
              "name": "timestamp",
              "value": "={{ $('Set Variables').item.json.timestamp }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3376,
        7424
      ],
      "name": "Prepare Update Data",
      "id": "b0c30c6e-e5bb-406d-b0c9-ccd5bd3abd25"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "nuevo_usuario",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "78ae880b-7907-4375-ba18-175e41ba057f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "bienvenida"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": false,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "reset",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  },
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "/start",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "or"
              },
              "renameOutput": true,
              "outputKey": "inicio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "menu_principal",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "46d39ddb-d57d-49de-83d0-2b2de8613b20"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "menu_principal"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "agenda_menu",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "8efa232e-9513-44cf-85d5-516eebcc9339"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "agenda_menu"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "agenda_crear_paso",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    },
                    "id": "1eeaf8e8-f782-4d21-a504-88d6049dc594"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "agenda_wizard"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "tareas_menu",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "68f4f53e-5398-4e8b-8df7-e751e9e4a927"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "tareas_menu"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "tarea_crear_paso",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    },
                    "id": "tarea-wizard-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "tarea_wizard"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "habitos_menu",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "c94dec9f-13e2-4ff4-b4eb-e0c7a9eacdbb"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "habitos_menu"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "listas_menu",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "acfd0fd7-8ca3-4e8c-9532-9feb7dfe9e99"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "listas_menu"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "recordatorios_menu",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "eba92eb3-0f47-4ef0-82c4-4e7d1a276cc6"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "recordatorios_menu"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "reportes_menu",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "f9f5b1cf-eeed-4f59-a238-687aea491b5d"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reportes_menu"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "config_menu",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "cb04c32b-2d72-48bc-8df1-bfcf70f52e9b"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "config_menu"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "admin_menu",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "ff5f693e-9967-489c-935a-2c4ef27a74ff"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "admin_menu"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "reprogramar_cita",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "reprogramar-cita-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reprogramar_cita"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "cancelar_cita",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "cancelar-cita-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cancelar_cita"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "completar_cita",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "completar-cita-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "completar_cita"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "ayuda_menu",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "ayuda-menu-condition"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ayuda_menu"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "name": "Router Principal",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -4128,
        8864
      ],
      "id": "f7d4d4e6-7640-4724-abc2-483d6ee23480"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "0",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ayuda"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "agenda"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "tareas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "3",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "recordatorios"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "4",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "habitos"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "5",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "listas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "6",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reportes"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "7",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "config"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "8",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "admin"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "name": "Menu Principal Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3888,
        8768
      ],
      "id": "0b9a3ca6-1cf7-414b-abd1-64fdcfb1d6fc"
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "AYUDA - AgendaBot\n\nAgenda: Gestiona citas\nTareas: Pendientes\nRecordatorios: No olvides nada\nHabitos: Rutinas\nListas: Organiza items\nReportes: Resumen\n\n9. Volver al menu",
        "additionalFields": {}
      },
      "name": "Send Ayuda",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3584,
        7680
      ],
      "id": "f0f8d8a9-0720-4c67-a19f-5e48717c7741",
      "webhookId": "9b548c91-7bdc-4c42-bbde-19dffe6f8263",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "üìÖ MEN√ö DE AGENDA\n\nSelecciona una opci√≥n:\n\n1Ô∏è‚É£ Crear nueva cita\n2Ô∏è‚É£ Ver citas pendientes\n3Ô∏è‚É£ Reprogramar cita\n4Ô∏è‚É£ Cancelar cita\n5Ô∏è‚É£ Completar cita\n\n0Ô∏è‚É£ Volver al men√∫ principal",
        "additionalFields": {}
      },
      "name": "Send Agenda Menu",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3584,
        7840
      ],
      "id": "384acd72-4dbb-4711-9dd7-03557ea8a5fd",
      "webhookId": "65c12e94-70ab-4577-a2a1-09c4d57b2eb8",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "agenda_menu",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}",
            "row_number": 0
          },
          "matchingColumns": [
            "telegram_user"
          ],
          "schema": [
            {
              "id": "telegram_user",
              "displayName": "telegram_user",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "pantalla_actual",
              "displayName": "pantalla_actual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "paso_actual",
              "displayName": "paso_actual",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "datos_parciales",
              "displayName": "datos_parciales",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "timestamp_ultima_interaccion",
              "displayName": "timestamp_ultima_interaccion",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "name": "Update to Agenda Menu",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -3344,
        7840
      ],
      "id": "cbe40e1f-8554-4198-ba7f-15ef1908a06e",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "üìù MEN√ö DE TAREAS\n\nSelecciona una opci√≥n:\n\n1Ô∏è‚É£ Crear nueva tarea\n2Ô∏è‚É£ Ver tareas pendientes\n3Ô∏è‚É£ Ver tareas completadas\n4Ô∏è‚É£ Completar tarea\n5Ô∏è‚É£ Eliminar tarea\n\n0Ô∏è‚É£ Volver al men√∫ principal",
        "additionalFields": {}
      },
      "name": "Send Tareas Menu",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3584,
        8016
      ],
      "id": "d8ee9dab-9aba-4530-87f4-589e028dd77b",
      "webhookId": "686e29f3-4dea-4b37-b462-5e830c06c743",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "tareas_menu",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "name": "Update to Tareas Menu",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -3344,
        8016
      ],
      "id": "aa835caa-bee3-4c98-9083-e04feda5c65b",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "RECORDATORIOS\n\n1. Crear\n2. Ver activos\n3. Cancelar\n9. Volver",
        "additionalFields": {}
      },
      "name": "Send Recordatorios Menu",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3536,
        8208
      ],
      "id": "15023a57-938d-4fc8-b591-83f055307296",
      "webhookId": "63e1f0aa-bdc3-44da-a9d4-5f4984ac3b44",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "recordatorios_menu",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "name": "Update to Recordatorios",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -3296,
        8208
      ],
      "id": "f56c048f-a3e1-427a-8ba8-35856a4cc2ec",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "HABITOS\n\n1. Crear\n2. Ver\n3. Pausar\n4. Reactivar\n5. Eliminar\n9. Volver",
        "additionalFields": {}
      },
      "name": "Send Habitos Menu",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3552,
        8400
      ],
      "id": "62b35348-c1fe-49f4-a52b-44814d521174",
      "webhookId": "f6f0f416-2b7d-4a44-af63-73cfb429b19c",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "habitos_menu",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "name": "Update to Habitos",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -3312,
        8400
      ],
      "id": "59e0bf4e-4b9b-44eb-88c8-ce41e4f8dac5",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "LISTAS\n\n1. Crear\n2. Ver\n3. Agregar item\n4. Completar item\n5. Eliminar\n9. Volver",
        "additionalFields": {}
      },
      "name": "Send Listas Menu",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3536,
        8592
      ],
      "id": "1c1f2255-5a37-4ac6-981e-eb3f11445600",
      "webhookId": "7947d946-d38b-4df2-9919-65a25551f84f",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "listas_menu",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "name": "Update to Listas",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -3296,
        8592
      ],
      "id": "315bc87e-aeac-4a35-8f4b-126cb7f08835",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "REPORTES\n\n1. Dia\n2. Semana\n3. Citas mes\n4. Tareas completadas\n9. Volver",
        "additionalFields": {}
      },
      "name": "Send Reportes Menu",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3504,
        8784
      ],
      "id": "46bf968f-c297-4fff-a7e2-2dbce01944aa",
      "webhookId": "623a4650-d67e-4b06-aa41-bbae56f97820",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "reportes_menu",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "name": "Update to Reportes",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -3264,
        8784
      ],
      "id": "05a3430d-775c-4360-84dd-095666823684",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "CONFIG\n\n1. Zona horaria\n2. Recordatorios on/off\n3. Mi info\n9. Volver",
        "additionalFields": {}
      },
      "name": "Send Config Menu",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3536,
        8992
      ],
      "id": "051c53e1-fda0-4d2f-991d-ab165d0dbeb1",
      "webhookId": "ab40cc2d-3c8c-48f8-a8b8-f668b34c0690",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "config_menu",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "name": "Update to Config",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -3296,
        8992
      ],
      "id": "c152e64e-8cc6-4c9f-819a-9a6815cb4492",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "ADMIN\n\n1. Usuarios\n2. Agregar\n3. Bloquear\n4. Logs\n5. Exportar\n9. Volver",
        "additionalFields": {}
      },
      "name": "Send Admin Menu",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3520,
        9184
      ],
      "id": "49d45906-9c71-4668-8688-d333c8468d2c",
      "webhookId": "305abfca-54f8-4528-a823-c2cfae08061d",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "admin_menu",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "name": "Update to Admin",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -3280,
        9184
      ],
      "id": "a5a30223-963d-426d-93a0-32aaa4c6bba1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Opcion no valida. Escribe 0-8.",
        "additionalFields": {}
      },
      "name": "Send Invalid Option",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3536,
        9376
      ],
      "id": "5a3ee863-4cc7-4f56-9791-ad7b5ec900ab",
      "webhookId": "e09c9c08-6ecf-4103-8516-b6f0923aa7a3",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "MENU\n0. Ayuda\n1. Agenda\n2. Tareas\n3. Recordatorios\n4. Habitos\n5. Listas\n6. Reportes\n7. Config\n8. Admin",
        "additionalFields": {}
      },
      "name": "Send Menu Principal",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3072,
        8400
      ],
      "id": "5ee7f2e2-b257-4ec4-b348-96d6ea63f4ac",
      "webhookId": "dbfc6753-c8fb-45d8-a7ca-51300cfb3d08",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "ayuda_menu",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "name": "Update to Ayuda",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -3344,
        7680
      ],
      "id": "cadd5124-b5aa-41e5-a6c1-f4862187d540",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "volver"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "name": "Ayuda Menu Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3888,
        8976
      ],
      "id": "9f089201-c28b-4050-97a8-907c499302d2"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "menu_principal",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "name": "Update Volver Menu",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -2832,
        8400
      ],
      "id": "1f7603c8-76ec-4798-9145-cf426b338c8e",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear_cita"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "consultar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "3",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reprogramar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "4",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cancelar_cita"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "5",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "completar_cita"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "volver"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "name": "Agenda Menu Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3888,
        9760
      ],
      "id": "e548417b-fa53-4aad-8ec6-f0d482b8c0ba"
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "CREAR CITA - Paso 1/6\n\nFecha? (YYYY-MM-DD)\nEj: 2025-12-20\n\n9. Cancelar",
        "additionalFields": {}
      },
      "name": "Send Agenda Paso 1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3552,
        9584
      ],
      "id": "5afe90a4-ea7f-4da0-91b1-85884d3e13c8",
      "webhookId": "aa7d85f8-9717-429d-aa47-5f41c8198ce9",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "agenda_crear_paso_1",
            "paso_actual": "1",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "name": "Update Agenda Paso 1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -3296,
        9584
      ],
      "id": "3059bd27-e4fa-4c4a-a925-cdca6b611b15",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 0,
          "cachedResultName": "CITAS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=0"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "creado_por",
              "lookupValue": "={{ $('Set Variables').item.json.telegram_user }}"
            },
            {
              "lookupColumn": "estado",
              "lookupValue": "pendiente"
            }
          ]
        },
        "options": {}
      },
      "name": "Get Citas Usuario",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -3520,
        9792
      ],
      "alwaysOutputData": true,
      "id": "33c605af-5248-49cf-b66c-8d4a420bb221",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "=TUS CITAS:\n\n{{ $json.fecha ? $json.fecha + ' ' + $json.hora + ' - ' + $json.nombre : 'Sin citas' }}\n\n9. Volver",
        "additionalFields": {}
      },
      "name": "Send Consultar Citas",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3312,
        9776
      ],
      "id": "53765269-17d1-414b-8d10-fcf766f1390c",
      "webhookId": "e56c0561-822c-4a2b-9196-bb2d5bee1cea",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Opcion no valida. 1-5 o 9.",
        "additionalFields": {}
      },
      "name": "Send Invalid Agenda",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3664,
        9920
      ],
      "id": "558b8b30-4e49-47a9-8175-4f010c63cddf",
      "webhookId": "5974385a-2ab4-41de-b97f-055062ad64dd",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Esta funcion esta en desarrollo.\n\n9. Volver al menu principal",
        "additionalFields": {}
      },
      "name": "Send En Desarrollo",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3664,
        10016
      ],
      "id": "2b8254fe-3493-44bf-b949-00f1b07b1273",
      "webhookId": "7448ada5-9d8a-42cd-9bac-696d5dee0776",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "agenda_crear_paso_1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "paso1"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "agenda_crear_paso_2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "paso2"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "agenda_crear_paso_3",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "paso3"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "agenda_crear_paso_4",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "paso4"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "agenda_crear_paso_5",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "paso5"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "agenda_crear_paso_6",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "paso6"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "name": "Agenda Wizard Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3888,
        10160
      ],
      "id": "3892753f-fb2b-4d70-b46e-17c25b9ea935"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
              "rightValue": "9",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "Cancelar?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3648,
        10064
      ],
      "id": "c639a6a0-53b7-48e1-80b2-69cf7c825459"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
              "rightValue": "^\\d{4}-\\d{2}-\\d{2}$",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "Validar Fecha",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3408,
        10160
      ],
      "id": "46dd1e5d-2b14-475d-9685-ae936c2d1252"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ fecha: $('Set Variables').item.json.mensaje }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "name": "Set Fecha",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3168,
        10064
      ],
      "id": "f8cb69d7-0c8a-4d64-9a74-c3fc9b468df3"
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Paso 2/6 - Hora? (HH:MM)\nEj: 14:30\n\n9. Cancelar",
        "additionalFields": {}
      },
      "name": "Send Paso 2",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2928,
        10064
      ],
      "id": "576fe378-0405-4c95-86ab-1aade019cee8",
      "webhookId": "0af8968b-3a5a-42df-a113-3851d3eaeac8",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "agenda_crear_paso_2",
            "paso_actual": "2",
            "datos_parciales": "={{ $json.datos_parciales }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "name": "Update Paso 2",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -2688,
        10064
      ],
      "id": "5442bd7e-cd16-411b-a8c1-dacb9257f7aa",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Formato incorrecto. Usa YYYY-MM-DD\n\n9. Cancelar",
        "additionalFields": {}
      },
      "name": "Error Fecha",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3168,
        10272
      ],
      "id": "a1e5687c-7561-4c37-967f-3d8fda58b0fc",
      "webhookId": "bb670aad-95e9-49da-b37c-36e3d6974aa1",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
              "rightValue": "9",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "Cancelar 2?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3648,
        10368
      ],
      "id": "5173f420-0d8a-453a-a77a-d17f1fa2509f"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
              "rightValue": "^\\d{2}:\\d{2}$",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "Validar Hora",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3408,
        10464
      ],
      "id": "efcb21a9-53fa-41c9-94a5-a3d5cd156aba"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ ...JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}'), hora: $('Set Variables').item.json.mensaje }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "name": "Set Hora",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3168,
        10368
      ],
      "id": "fca38385-bda0-464e-9d36-1c2fc294de0a"
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Paso 3/6 - Nombre cliente?\n\n9. Cancelar",
        "additionalFields": {}
      },
      "name": "Send Paso 3",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2928,
        10368
      ],
      "id": "c5b9797c-89cf-4444-a9a1-2ed26ebb4e5c",
      "webhookId": "616f7149-084d-49a9-b291-e4066250f2cf",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "agenda_crear_paso_3",
            "paso_actual": "3",
            "datos_parciales": "={{ $json.datos_parciales }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "name": "Update Paso 3",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -2688,
        10368
      ],
      "id": "61049355-31cd-45ee-99de-55785a31c7fd",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Formato incorrecto. Usa HH:MM\n\n9. Cancelar",
        "additionalFields": {}
      },
      "name": "Error Hora",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3168,
        10560
      ],
      "id": "56eca649-c93b-40d7-895e-46870338b5a7",
      "webhookId": "60fa0711-ae5c-4258-923f-57ef4140df49",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
              "rightValue": "9",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "Cancelar 3?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3648,
        10688
      ],
      "id": "3c8adc6a-3cc8-44a7-826a-29f1bfc71c8c"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ ...JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}'), nombre: $('Set Variables').item.json.mensaje }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "name": "Set Nombre",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3408,
        10688
      ],
      "id": "f38c6e7c-f503-4b78-86a3-639718094ad0"
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Paso 4/6 - Motivo?\n\n9. Cancelar",
        "additionalFields": {}
      },
      "name": "Send Paso 4",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3168,
        10688
      ],
      "id": "281c0d86-7037-4c08-bf62-2c4151ddc7ba",
      "webhookId": "6228a62e-811a-4b9c-96e5-2c6464550399",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "agenda_crear_paso_4",
            "paso_actual": "4",
            "datos_parciales": "={{ $json.datos_parciales }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "name": "Update Paso 4",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -2928,
        10688
      ],
      "id": "4eccffa1-0b22-4270-8385-12bcced6d0d7",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
              "rightValue": "9",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "Cancelar 4?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3648,
        10976
      ],
      "id": "954666df-12be-4c70-aa40-47b8c8898d67"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ ...JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}'), motivo: $('Set Variables').item.json.mensaje }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "name": "Set Motivo",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3408,
        10976
      ],
      "id": "1203caf9-9d62-4322-a788-e96aea6a48ee"
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Paso 5/6 - Canal?\n\n1. Presencial\n2. Virtual\n3. Llamada\n9. Cancelar",
        "additionalFields": {}
      },
      "name": "Send Paso 5",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3168,
        10976
      ],
      "id": "86589746-8172-4b33-a34b-7b42eff55b96",
      "webhookId": "59884b2d-adef-49f5-b26a-0bf5189c0930",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "agenda_crear_paso_5",
            "paso_actual": "5",
            "datos_parciales": "={{ $json.datos_parciales }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "name": "Update Paso 5",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -2928,
        10976
      ],
      "id": "4e76b900-a95c-420b-a805-1980891a2239",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "presencial"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "virtual"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "3",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "llamada"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cancelar"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "name": "Canal Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3648,
        11280
      ],
      "id": "a6f070fc-50fe-4aa2-9b64-a1ab894d01ed"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ ...JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}'), canal: 'Presencial' }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "name": "Set Presencial",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3408,
        11184
      ],
      "id": "448b4ba4-cb52-4ad3-9eb9-8298a95ed48b"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ ...JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}'), canal: 'Virtual' }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "name": "Set Virtual",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3408,
        11280
      ],
      "id": "46ebceeb-e8d0-4f52-a3aa-6805c2c1c0f2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ ...JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}'), canal: 'Llamada' }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "name": "Set Llamada",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3408,
        11376
      ],
      "id": "dd817b78-ec40-48da-8beb-ad4fc0e072e1"
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "=Paso 6/6 - CONFIRMAR:\n\n{{ (() => { try { const d = JSON.parse($json.datos_parciales || '{}'); return 'Fecha: ' + d.fecha + '\\nHora: ' + d.hora + '\\nCliente: ' + d.nombre + '\\nMotivo: ' + d.motivo + '\\nCanal: ' + d.canal; } catch(e) { return 'Error: ' + e.message; } })() }}\n\n1. Confirmar\n2. Editar\n3. Cancelar",
        "additionalFields": {}
      },
      "name": "Send Paso 6",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3168,
        11280
      ],
      "id": "c4baac7d-5e45-4af8-b21c-95afe750791f",
      "webhookId": "d7455bc3-55a7-42f8-98a6-dd45eba1062c",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "agenda_crear_paso_6",
            "paso_actual": "6",
            "datos_parciales": "={{ $json.datos_parciales }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "name": "Update Paso 6",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -2928,
        11280
      ],
      "id": "4eb8d7f5-589a-4507-a95f-48b703fc1983",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "confirmar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "editar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "3",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cancelar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "cancelar"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "name": "Confirmar Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3648,
        11584
      ],
      "id": "85fa8a54-5b16-474b-a780-f9833d236d6f"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "id_cita",
              "value": "={{ 'CITA-' + Date.now() }}",
              "type": "string"
            },
            {
              "id": "2",
              "name": "fecha",
              "value": "={{ JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}').fecha }}",
              "type": "string"
            },
            {
              "id": "3",
              "name": "hora",
              "value": "={{ JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}').hora }}",
              "type": "string"
            },
            {
              "id": "4",
              "name": "nombre",
              "value": "={{ JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}').nombre }}",
              "type": "string"
            },
            {
              "id": "5",
              "name": "motivo",
              "value": "={{ JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}').motivo }}",
              "type": "string"
            },
            {
              "id": "6",
              "name": "canal",
              "value": "={{ JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}').canal }}",
              "type": "string"
            },
            {
              "id": "7",
              "name": "estado",
              "value": "pendiente",
              "type": "string"
            },
            {
              "id": "8",
              "name": "creado_por",
              "value": "={{ String($('Set Variables').item.json.telegram_user) }}",
              "type": "string"
            },
            {
              "id": "9",
              "name": "timestamp_creacion",
              "value": "={{ $('Set Variables').item.json.timestamp }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "name": "Parse Cita",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3408,
        11488
      ],
      "id": "8f3d8867-1c5f-4ce4-bede-6dfe493d93a6"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "CITAS",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {}
        },
        "options": {}
      },
      "name": "Guardar Cita",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -3168,
        11488
      ],
      "id": "72bf8d67-3846-4cde-9bf5-4bb3a35d01d6",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "=CITA GUARDADA!\n\nID: {{ $('Parse Cita').item.json.id_cita }}\nFecha: {{ $('Parse Cita').item.json.fecha }}\nHora: {{ $('Parse Cita').item.json.hora }}\n\n(Regresando al men√∫ principal...)",
        "additionalFields": {}
      },
      "name": "Cita OK",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2928,
        11488
      ],
      "id": "5cd92857-5a7b-4955-8936-62caf3a01a47",
      "webhookId": "a41d6039-65ee-4fdd-a4d8-e990ed25d831",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q/edit#gid=319260215"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "menu_principal",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "name": "Update After Cita",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -2688,
        11488
      ],
      "id": "1ddc8303-1298-4af1-953a-39407dcfd4d4",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "volver"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "name": "Volver Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3888,
        11888
      ],
      "id": "1451de74-5656-4afe-a7d5-5dc3d2331d2d"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "crear"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "pendientes"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "3",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "completadas"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "4",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "completar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "5",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "eliminar"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "9",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "volver"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "name": "Tareas Menu Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3888,
        12016
      ],
      "id": "f072fd17-0871-4fa2-ad8b-59dacf515cba"
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "CREAR TAREA\n\nEscribe el titulo de la tarea:\n\n9. Cancelar",
        "additionalFields": {}
      },
      "name": "Send Tarea Paso 1",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3664,
        11920
      ],
      "id": "7a9032c1-2510-4c54-b81f-a713def8f86a",
      "webhookId": "f0e74841-dbcc-4741-898f-7fd11a31ed02",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "tarea_crear_paso_1",
            "paso_actual": "1",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "name": "Update Tarea Paso 1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -3424,
        11920
      ],
      "id": "cd586dfe-d32a-49c8-a1e3-a358fc62b20a",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 37820303,
          "cachedResultName": "TAREAS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "creado_por",
              "lookupValue": "={{ $('Set Variables').item.json.telegram_user }}"
            },
            {
              "lookupColumn": "estado",
              "lookupValue": "pendiente"
            }
          ]
        },
        "options": {}
      },
      "name": "Get Tareas Pendientes",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -3664,
        12016
      ],
      "alwaysOutputData": true,
      "id": "6d1789b5-cf09-4a99-9aa8-d327fa83c92c",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "=TAREAS PENDIENTES:\n\n{{ $input.all().length > 0 ? $input.all().map((item, i) => (i+1) + '. ' + (item.json.titulo || 'Sin titulo')).join('\\n') : 'No tienes tareas pendientes.' }}\n\n9. Menu principal",
        "additionalFields": {}
      },
      "name": "Send Tareas Pendientes",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3424,
        12016
      ],
      "id": "2870f8a6-891c-41c8-8e8e-519020eace1d",
      "webhookId": "698ae5f8-74b0-49af-986c-a963f1e7a620",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 37820303,
          "cachedResultName": "TAREAS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "creado_por",
              "lookupValue": "={{ $('Set Variables').item.json.telegram_user }}"
            },
            {
              "lookupColumn": "estado",
              "lookupValue": "completada"
            }
          ]
        },
        "options": {}
      },
      "name": "Get Tareas Completadas",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -3664,
        12128
      ],
      "alwaysOutputData": true,
      "id": "90b4c7a5-824d-4a22-8ad2-6c7a0a26b7ae",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "=TAREAS COMPLETADAS:\n\n{{ $input.all().length > 0 ? $input.all().map((item, i) => (i+1) + '. ' + (item.json.titulo || 'Sin titulo') + ' ‚úì').join('\\n') : 'No tienes tareas completadas.' }}\n\n9. Menu principal",
        "additionalFields": {}
      },
      "name": "Send Tareas Completadas",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3424,
        12128
      ],
      "id": "18d2e59b-43d3-4513-a09a-c158cb6b74d3",
      "webhookId": "6e50c6b1-96fa-4a0b-85b0-b57b988f46af",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Esta funcion esta en desarrollo.\n\n9. Volver al menu principal",
        "additionalFields": {}
      },
      "name": "Send Tarea En Desarrollo",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3664,
        12224
      ],
      "id": "6332e8c6-d4c3-49f5-8070-c79a23ddb0ad",
      "webhookId": "b7d5c93f-1054-4840-a08a-31a5f919843b",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Opcion no valida. Escribe 1-5 o 9.",
        "additionalFields": {}
      },
      "name": "Send Invalid Tarea",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3664,
        12320
      ],
      "id": "83c28c09-0f45-496a-9fa6-0aecbb394697",
      "webhookId": "573b8543-52fd-49bc-9e5e-f1c56bd6628c",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "tarea_crear_paso_1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "paso1"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "tarea_crear_paso_2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "paso2"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.pantalla }}",
                    "rightValue": "tarea_crear_paso_3",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "paso3"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "name": "Tarea Wizard Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3888,
        12416
      ],
      "id": "7574cae3-4a58-441a-9104-35b02f8e0302"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
              "rightValue": "9",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "Cancelar Tarea?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3664,
        12416
      ],
      "id": "5fd3f4f7-a599-47fd-b680-e28179787f9a"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "id_tarea",
              "value": "={{ 'TAREA-' + Date.now() }}",
              "type": "string"
            },
            {
              "id": "2",
              "name": "titulo",
              "value": "={{ JSON.parse($json.datos_parciales || '{}').titulo || '' }}",
              "type": "string"
            },
            {
              "id": "3",
              "name": "prioridad",
              "value": "={{ JSON.parse($json.datos_parciales || '{}').prioridad || 'media' }}",
              "type": "string"
            },
            {
              "id": "4",
              "name": "estado",
              "value": "pendiente",
              "type": "string"
            },
            {
              "id": "5",
              "name": "fecha_objetivo",
              "value": "={{ JSON.parse($json.datos_parciales || '{}').fecha_objetivo || '' }}",
              "type": "string"
            },
            {
              "id": "6",
              "name": "creado_por",
              "value": "={{ $('Set Variables').item.json.telegram_user }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "name": "Parse Tarea",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3424,
        12480
      ],
      "id": "40589b31-ab98-4a71-aa3d-6b8bea15d6bc"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 37820303,
          "cachedResultName": "TAREAS"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {}
        },
        "options": {}
      },
      "name": "Guardar Tarea",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -3184,
        12480
      ],
      "id": "58da643f-b581-445d-977a-fec4fadb7227",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "=TAREA CREADA!\n\nTitulo: {{ $('Parse Tarea').item.json.titulo }}\nPrioridad: {{ $('Parse Tarea').item.json.prioridad }}\nFecha: {{ $('Parse Tarea').item.json.fecha_objetivo || 'Sin fecha' }}\n\n(Volviendo al menu de tareas...)",
        "additionalFields": {}
      },
      "name": "Tarea OK",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2944,
        12480
      ],
      "id": "17ce8b8d-2e47-4cff-9faa-3c5ffdecca41",
      "webhookId": "241ba9ee-ebb2-4f64-9494-97eeea65e222",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "tareas_menu",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "name": "Update After Tarea",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -2704,
        12480
      ],
      "id": "072782aa-bcf7-4460-a5b6-bf1aca1bf1ac",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ titulo: $('Set Variables').item.json.mensaje }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "name": "Set Titulo Tarea",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3424,
        12528
      ],
      "id": "7e56c38f-b973-465a-a18c-740cb4baf1ee"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "tarea_crear_paso_2",
            "paso_actual": "2",
            "datos_parciales": "={{ $json.datos_parciales }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "name": "Update Tarea Paso 2",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -3184,
        12528
      ],
      "id": "d69d42f4-6703-47e7-9d8e-9c12da416502",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "CREAR TAREA - Paso 2/3\n\nPrioridad?\n\n1. Alta\n2. Media\n3. Baja\n\n9. Cancelar",
        "additionalFields": {}
      },
      "name": "Send Tarea Paso 2",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2944,
        12528
      ],
      "id": "4b59fe76-5c1e-47d5-a919-2a73128f47c8",
      "webhookId": "c32bb1c6-2670-4564-85ee-90c46fa053d4",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
              "rightValue": "9",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "Cancelar Tarea 2?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3664,
        12624
      ],
      "id": "724a6e64-a9ca-4139-9731-9d78fb5e0c48"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "alta"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "media"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "loose"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
                    "rightValue": "3",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "baja"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "name": "Prioridad Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3424,
        12672
      ],
      "id": "32c15d14-39e4-444f-84f6-fe6e68146345"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ ...JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}'), prioridad: 'alta' }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "name": "Set Prioridad Alta",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3184,
        12576
      ],
      "id": "58866046-2ed8-45ec-b3f3-0ce816a5b5f0"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ ...JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}'), prioridad: 'media' }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "name": "Set Prioridad Media",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3184,
        12672
      ],
      "id": "60767a16-2e74-4ba5-a18d-25c6a75c7406"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ ...JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}'), prioridad: 'baja' }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "name": "Set Prioridad Baja",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3184,
        12768
      ],
      "id": "832ff7ec-32bb-4d88-afd7-d79cd97e33c0"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "mode": "id",
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q"
        },
        "sheetName": {
          "__rl": true,
          "mode": "list",
          "value": 319260215,
          "cachedResultName": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_user": "={{ $('Set Variables').item.json.telegram_user }}",
            "pantalla_actual": "tarea_crear_paso_3",
            "paso_actual": "3",
            "datos_parciales": "={{ $json.datos_parciales }}",
            "timestamp_ultima_interaccion": "={{ $('Set Variables').item.json.timestamp }}"
          },
          "matchingColumns": [
            "telegram_user"
          ]
        },
        "options": {}
      },
      "name": "Update Tarea Paso 3",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -2944,
        12672
      ],
      "id": "0250e80f-d659-4d91-8156-af134603fc58",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "CREAR TAREA - Paso 3/3\n\nFecha objetivo? (YYYY-MM-DD)\nEj: 2025-02-15\n\nEscribe 0 para saltar\n\n9. Cancelar",
        "additionalFields": {}
      },
      "name": "Send Tarea Paso 3",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2704,
        12672
      ],
      "id": "8e6a1fd8-d574-42ee-92e3-ce56c1ace695",
      "webhookId": "dc3979d8-3359-417c-8e3d-7bacb663e471",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
              "rightValue": "9",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "Cancelar Tarea 3?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3664,
        12816
      ],
      "id": "218ed5ff-f95c-4551-ba33-97bac0165d18"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "leftValue": "={{ $('Set Variables').item.json.mensaje }}",
              "rightValue": "^(\\d{4}-\\d{2}-\\d{2}|0)$",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "name": "Fecha Valida?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3424,
        12880
      ],
      "id": "cef0d035-f505-42d8-92fd-24837ba9fdc8"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1",
              "name": "datos_parciales",
              "value": "={{ JSON.stringify({ ...JSON.parse($('Merge Session Data').item.json.datos_parciales || '{}'), fecha_objetivo: $('Set Variables').item.json.mensaje === '0' ? '' : $('Set Variables').item.json.mensaje }) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "name": "Set Fecha Tarea",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3184,
        12816
      ],
      "id": "2111ec44-6ff8-42bd-bd24-cab6e6ce0678"
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Formato incorrecto. Usa YYYY-MM-DD o 0 para saltar.\n\n9. Cancelar",
        "additionalFields": {}
      },
      "name": "Send Fecha Invalida",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3184,
        12928
      ],
      "id": "6defdaa1-9880-4fad-82a1-860971cc7fb9",
      "webhookId": "503be0f6-3883-4440-b838-795c733687cb",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "Opcion no valida. Escribe 1, 2, 3 o 9.",
        "additionalFields": {}
      },
      "name": "Send Prioridad Invalida",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3184,
        12816
      ],
      "id": "6984a845-8d83-469f-837f-ed1472cb70a0",
      "webhookId": "df7f865c-2197-424b-b8a3-2dbc8434b62f",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "TAREAS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "telegram_user",
              "lookupValue": "={{ $json.telegram_user }}"
            },
            {
              "lookupColumn": "estado",
              "lookupValue": "pendiente"
            }
          ]
        },
        "options": {}
      },
      "name": "Get Tareas Para Completar",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1584,
        9616
      ],
      "alwaysOutputData": true,
      "id": "2e99d6be-28af-4978-b687-8c9a84f77eb3",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ \nlet tareas = $input.all();\nif (tareas.length === 0) {\n    return '‚ùå No tienes tareas pendientes para completar.\\n\\n0Ô∏è‚É£ Volver al men√∫ de tareas';\n}\nlet mensaje = '‚úÖ COMPLETAR TAREA\\n\\nSelecciona el n√∫mero de la tarea que deseas marcar como completada:\\n\\n';\nfor (let i = 0; i < tareas.length; i++) {\n    let tarea = tareas[i].json;\n    mensaje += (i+1) + 'Ô∏è‚É£ ' + tarea.titulo + '\\n   üìÖ ' + tarea.fecha_limite + '\\n   üî• Prioridad: ' + tarea.prioridad + '\\n\\n';\n}\nmensaje += '\\n0Ô∏è‚É£ Cancelar';\nreturn mensaje;\n}}",
        "additionalFields": {}
      },
      "name": "Send Lista Para Completar",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1360,
        9616
      ],
      "id": "2d61e962-fab9-45d6-9b2c-67dbc680e691",
      "webhookId": "9a2d87cf-fb78-434c-a27b-ec9a384f5b8d",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "pantalla_actual": "completar_tarea",
            "paso_actual": "1",
            "datos_parciales": "={{ JSON.stringify({tareas: $input.all().map(t => t.json)}) }}",
            "timestamp_ultima_interaccion": "={{ $json.timestamp }}"
          }
        },
        "options": {}
      },
      "name": "Update Session Completar Paso 1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1152,
        9616
      ],
      "id": "76d47be9-c31c-4eae-9d81-570e3bb27596",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "mode": "expression",
        "output": null
      },
      "name": "Completar Tarea Selection Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1584,
        9824
      ],
      "id": "f0e308e1-aca6-461b-8a41-f2f84f435bdc"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "TAREAS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "estado": "completada",
            "fecha_completado": "={{ new Date().toISOString().split('T')[0] }}"
          }
        },
        "options": {}
      },
      "name": "Marcar Tarea Como Completada",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1360,
        9824
      ],
      "id": "d50de1e8-a777-4c39-a5b7-b3cd36c08b1c",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ '‚úÖ ¬°Tarea completada exitosamente!\\n\\nüìã ' + JSON.parse($json.datos_parciales).tareas[parseInt($json.mensaje) - 1].titulo + '\\n\\nVolviendo al men√∫ de tareas...' }}",
        "additionalFields": {}
      },
      "name": "Send Tarea Completada Success",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1152,
        9824
      ],
      "id": "4795dc24-5e86-49d6-bffb-6889cb846bf2",
      "webhookId": "9c0af944-a4fa-4ddd-a86e-d63f580313a9",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "pantalla_actual": "menu_tareas",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $json.timestamp }}"
          }
        },
        "options": {}
      },
      "name": "Update After Completar",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -928,
        9824
      ],
      "id": "a84fc5cc-9e98-4ca3-ae8c-15c29cf591d7",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "‚ùå Selecci√≥n inv√°lida. Por favor ingresa un n√∫mero v√°lido de la lista.",
        "additionalFields": {}
      },
      "name": "Send Seleccion Invalida Completar",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1360,
        10016
      ],
      "id": "663a7f80-e9db-4432-b1ac-e066712dcbc0",
      "webhookId": "b258d260-a435-4e3d-a25b-5011b9c0d8db",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "TAREAS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "telegram_user",
              "lookupValue": "={{ $json.telegram_user }}"
            }
          ]
        },
        "options": {}
      },
      "name": "Get Tareas Para Eliminar",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1584,
        10224
      ],
      "alwaysOutputData": true,
      "id": "6cfd5ee9-a2e8-4c9d-b31f-3de410b1eff2",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ \nlet tareas = $input.all();\nif (tareas.length === 0) {\n    return '‚ùå No tienes tareas registradas para eliminar.\\n\\n0Ô∏è‚É£ Volver al men√∫ de tareas';\n}\nlet mensaje = 'üóëÔ∏è ELIMINAR TAREA\\n\\nSelecciona el n√∫mero de la tarea que deseas eliminar:\\n\\n';\nfor (let i = 0; i < tareas.length; i++) {\n    let tarea = tareas[i].json;\n    mensaje += (i+1) + 'Ô∏è‚É£ ' + tarea.titulo + '\\n   üìÖ ' + tarea.fecha_limite + '\\n   üìä Estado: ' + tarea.estado + '\\n\\n';\n}\nmensaje += '\\n0Ô∏è‚É£ Cancelar';\nreturn mensaje;\n}}",
        "additionalFields": {}
      },
      "name": "Send Lista Para Eliminar",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1360,
        10224
      ],
      "id": "17768598-85b3-4030-ad3f-d247e683c9af",
      "webhookId": "bb09b880-5066-4f15-bc44-1b1a805ad974",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "pantalla_actual": "eliminar_tarea",
            "paso_actual": "1",
            "datos_parciales": "={{ JSON.stringify({tareas: $input.all().map(t => t.json)}) }}",
            "timestamp_ultima_interaccion": "={{ $json.timestamp }}"
          }
        },
        "options": {}
      },
      "name": "Update Session Eliminar Paso 1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1152,
        10224
      ],
      "id": "e82dc47a-4713-48f4-af4b-de31a54a4dcd",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "mode": "expression",
        "output": null
      },
      "name": "Eliminar Tarea Selection Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1584,
        10416
      ],
      "id": "336a2816-5286-4139-9909-7619305bc841"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ '‚ö†Ô∏è ¬øEst√°s seguro de que deseas eliminar esta tarea?\\n\\nüìã ' + JSON.parse($json.datos_parciales).tareas[parseInt($json.mensaje) - 1].titulo + '\\n\\n1Ô∏è‚É£ S√≠, eliminar\\n2Ô∏è‚É£ No, cancelar' }}",
        "additionalFields": {}
      },
      "name": "Send Confirmar Eliminar",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1360,
        10416
      ],
      "id": "2dc71db4-68c2-489d-be59-14cf153c91a6",
      "webhookId": "e414f2f2-c04a-4215-89dc-11a5ddf3ecb4",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "paso_actual": "2",
            "datos_parciales": "={{ JSON.stringify({...JSON.parse($json.datos_parciales), tarea_seleccionada: parseInt($json.mensaje) - 1}) }}",
            "timestamp_ultima_interaccion": "={{ $json.timestamp }}"
          }
        },
        "options": {}
      },
      "name": "Update Session Eliminar Paso 2",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1152,
        10416
      ],
      "id": "317ca471-931d-417b-bc50-5b4219b0e22d",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "mode": "expression",
        "output": null
      },
      "name": "Confirmar Eliminar Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1584,
        10624
      ],
      "id": "c5d3fa7a-17bc-4308-9251-c23128289f52"
    },
    {
      "parameters": {
        "operation": "deleteRows",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        }
      },
      "name": "Delete Tarea",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1360,
        10624
      ],
      "id": "f31a1fc6-486c-4a8b-9a34-3ebe016870f2",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "={{ '‚úÖ Tarea eliminada exitosamente.\\n\\nüìã ' + JSON.parse($json.datos_parciales).tareas[JSON.parse($json.datos_parciales).tarea_seleccionada].titulo + '\\n\\nVolviendo al men√∫ de tareas...' }}",
        "additionalFields": {}
      },
      "name": "Send Tarea Eliminada Success",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1152,
        10624
      ],
      "id": "e0a705bd-e81b-452c-874c-bdc29a68e848",
      "webhookId": "65eb8859-a1a9-493a-a152-ea157e5db9a7",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "pantalla_actual": "menu_tareas",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $json.timestamp }}"
          }
        },
        "options": {}
      },
      "name": "Update After Eliminar",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -928,
        10624
      ],
      "id": "d39d2a4e-e9ce-461b-9f04-9b0b72070174",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "‚ùå Selecci√≥n inv√°lida. Por favor ingresa un n√∫mero v√°lido.",
        "additionalFields": {}
      },
      "name": "Send Seleccion Invalida Eliminar",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1360,
        10816
      ],
      "id": "94e0f358-8948-47cd-8a33-af2b35535712",
      "webhookId": "f14f531b-0c65-4d13-a441-93e9f0bcf309",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "CITAS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "creado_por",
              "lookupValue": "={{ $json.telegram_user }}"
            },
            {
              "lookupColumn": "estado",
              "lookupValue": "pendiente"
            }
          ]
        },
        "options": {}
      },
      "name": "Get Citas Para Reprogramar",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1584,
        11024
      ],
      "alwaysOutputData": true,
      "id": "429dbb6c-203d-457e-9b7b-5e2a25791fd5",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "={{ (() => {\nlet citas = $input.all();\nif (citas.length === 0) {\n    return '‚ùå No tienes citas pendientes para reprogramar.\\n\\n0Ô∏è‚É£ Volver al men√∫ de agenda';\n}\nlet mensaje = 'üîÑ REPROGRAMAR CITA\\n\\nSelecciona el n√∫mero de la cita que deseas reprogramar:\\n\\n';\nfor (let i = 0; i < citas.length; i++) {\n    let cita = citas[i].json;\n    mensaje += (i+1) + 'Ô∏è‚É£ ' + cita.nombre + '\\n   üìÖ ' + cita.fecha + ' a las ' + cita.hora + '\\n   üìù ' + cita.motivo + ' (' + cita.canal + ')\\n\\n';\n}\nmensaje += '\\n0Ô∏è‚É£ Cancelar';\nreturn mensaje;\n})() }}",
        "additionalFields": {}
      },
      "name": "Send Lista Para Reprogramar",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1360,
        11024
      ],
      "id": "3b265c5a-9210-4e0f-b8f0-693ab13c96d5",
      "webhookId": "f162df7d-a764-46f0-b71d-2bc62f545766",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "pantalla_actual": "reprogramar_cita",
            "paso_actual": "1",
            "datos_parciales": "={{ JSON.stringify({citas: $input.all().map(c => c.json)}) }}",
            "timestamp_ultima_interaccion": "={{ $json.timestamp }}"
          }
        },
        "options": {}
      },
      "name": "Update Session Reprogramar Paso 1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1152,
        11024
      ],
      "id": "f00d2368-84b4-40da-b980-0a5e10036b02",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "mode": "expression",
        "output": null
      },
      "name": "Reprogramar Cita Selection Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1584,
        11216
      ],
      "id": "0c80327f-9e98-4609-bbf7-c877a85865ca"
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "{{ 'üìÖ NUEVA FECHA\\n\\nIngresa la nueva fecha para la cita:\\n' + JSON.parse($json.datos_parciales).citas[parseInt($json.mensaje) - 1].nombre + '\\n\\nFormato: AAAA-MM-DD (ejemplo: 2026-02-15)\\n\\n0Ô∏è‚É£ Cancelar' }}",
        "additionalFields": {}
      },
      "name": "Send Solicitar Nueva Fecha",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1360,
        11216
      ],
      "id": "3742970f-b0ed-41a0-9a89-3070238d00c7",
      "webhookId": "cd883af2-2626-46f3-b2f8-d387703afc5a",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "paso_actual": "2",
            "datos_parciales": "={{ JSON.stringify({...JSON.parse($json.datos_parciales), cita_seleccionada: parseInt($json.mensaje) - 1}) }}",
            "timestamp_ultima_interaccion": "={{ $json.timestamp }}"
          }
        },
        "options": {}
      },
      "name": "Update Session Reprogramar Paso 2",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1152,
        11216
      ],
      "id": "10e9a210-f726-4735-bc05-bf4f2351903d",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "mode": "expression",
        "output": null
      },
      "name": "Validar Nueva Fecha Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1584,
        11424
      ],
      "id": "bb6162a2-cec8-4f75-8adb-e17e79fe255d"
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "üïê NUEVA HORA\\n\\nIngresa la nueva hora para la cita:\\n\\nFormato: HH:MM (ejemplo: 14:30)\\n\\n0Ô∏è‚É£ Cancelar",
        "additionalFields": {}
      },
      "name": "Send Solicitar Nueva Hora",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1360,
        11424
      ],
      "id": "5d594ba5-4d59-4376-9c5e-fc362b322c33",
      "webhookId": "54eb4693-9bfd-4876-b6de-830bfda3f004",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "paso_actual": "3",
            "datos_parciales": "={{ JSON.stringify({...JSON.parse($json.datos_parciales), nueva_fecha: $json.mensaje}) }}",
            "timestamp_ultima_interaccion": "={{ $json.timestamp }}"
          }
        },
        "options": {}
      },
      "name": "Update Session Reprogramar Paso 3",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1152,
        11424
      ],
      "id": "179c3b2e-15f9-4b8a-ad88-64e45642c7b5",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "mode": "expression",
        "output": null
      },
      "name": "Validar Nueva Hora Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1584,
        11616
      ],
      "id": "cda0dffa-6d68-4d88-a3db-050ef0be21dc"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "CITAS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id_cita": "={{ JSON.parse($json.datos_parciales).citas[JSON.parse($json.datos_parciales).cita_seleccionada].id_cita }}",
            "fecha": "={{ JSON.parse($json.datos_parciales).nueva_fecha }}",
            "hora": "={{ $json.mensaje }}"
          },
          "matchingColumns": [
            "id_cita"
          ]
        },
        "options": {}
      },
      "name": "Update Cita Reprogramada",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1360,
        11616
      ],
      "id": "68f1d246-502d-4d3e-98fc-e8cbfa344121",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "={{ '‚úÖ Cita reprogramada exitosamente\\n\\nüìã ' + JSON.parse($json.datos_parciales).citas[JSON.parse($json.datos_parciales).cita_seleccionada].nombre + '\\nüìÖ Nueva fecha: ' + JSON.parse($json.datos_parciales).nueva_fecha + ' a las ' + $json.mensaje + '\\n\\nVolviendo al men√∫ de agenda...' }}",
        "additionalFields": {}
      },
      "name": "Send Cita Reprogramada Success",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1152,
        11616
      ],
      "id": "9bd081ab-e56f-45e1-9cb6-85c7fe7df98b",
      "webhookId": "1f837955-0dd6-4ecf-a678-7f76ec20c96a",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "pantalla_actual": "menu_agenda",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $json.timestamp }}"
          }
        },
        "options": {}
      },
      "name": "Update After Reprogramar",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -928,
        11616
      ],
      "id": "7929f075-a17e-4481-aad6-7baee782594f",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "‚ùå Formato inv√°lido. Por favor verifica e intenta nuevamente.",
        "additionalFields": {}
      },
      "name": "Send Invalida Reprogramar",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1360,
        11824
      ],
      "id": "25c4b2c3-ff56-4b89-95a3-40f546c79574",
      "webhookId": "ca82810d-7557-4bea-8b1a-755e1fc44895",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "CITAS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "creado_por",
              "lookupValue": "={{ $json.telegram_user }}"
            },
            {
              "lookupColumn": "estado",
              "lookupValue": "pendiente"
            }
          ]
        },
        "options": {}
      },
      "name": "Get Citas Para Cancelar",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1584,
        12224
      ],
      "alwaysOutputData": true,
      "id": "c89dfa07-f368-4590-ad32-4bde8f1d6f96",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "={{ (() => {\nlet citas = $input.all();\nif (citas.length === 0) {\n    return '‚ùå No tienes citas pendientes para cancelar.\\n\\n0Ô∏è‚É£ Volver al men√∫ de agenda';\n}\nlet mensaje = '‚ùå CANCELAR CITA\\n\\nSelecciona el n√∫mero de la cita que deseas cancelar:\\n\\n';\nfor (let i = 0; i < citas.length; i++) {\n    let cita = citas[i].json;\n    mensaje += (i+1) + 'Ô∏è‚É£ ' + cita.nombre + '\\n   üìÖ ' + cita.fecha + ' a las ' + cita.hora + '\\n   üìù ' + cita.motivo + ' (' + cita.canal + ')\\n\\n';\n}\nmensaje += '\\n0Ô∏è‚É£ Volver';\nreturn mensaje;\n})() }}",
        "additionalFields": {}
      },
      "name": "Send Lista Para Cancelar",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1360,
        12224
      ],
      "id": "0329230f-8a3b-46c1-8849-6602269e5118",
      "webhookId": "144519de-c701-4a01-b672-763f594ee3d6",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "pantalla_actual": "cancelar_cita",
            "paso_actual": "1",
            "datos_parciales": "={{ JSON.stringify({citas: $input.all().map(c => c.json)}) }}",
            "timestamp_ultima_interaccion": "={{ $json.timestamp }}"
          }
        },
        "options": {}
      },
      "name": "Update Session Cancelar Paso 1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1152,
        12224
      ],
      "id": "04d6f3ce-5789-49f4-bfa6-4e29150a7b75",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "mode": "expression",
        "output": null
      },
      "name": "Cancelar Cita Selection Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1584,
        12416
      ],
      "id": "93953dc6-05b9-4dd1-9a60-c623c8672bfa"
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "={{ '‚ö†Ô∏è ¬øEst√°s seguro de que deseas cancelar esta cita?\\n\\nüìã ' + JSON.parse($json.datos_parciales).citas[parseInt($json.mensaje) - 1].nombre + '\\nüìÖ ' + JSON.parse($json.datos_parciales).citas[parseInt($json.mensaje) - 1].fecha + ' a las ' + JSON.parse($json.datos_parciales).citas[parseInt($json.mensaje) - 1].hora + '\\n\\n1Ô∏è‚É£ S√≠, cancelar\\n2Ô∏è‚É£ No, volver' }}",
        "additionalFields": {}
      },
      "name": "Send Confirmar Cancelar Cita",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1360,
        12416
      ],
      "id": "c2ceee4d-98fb-4ba1-9499-9e9f8cb996ef",
      "webhookId": "5506366e-1adb-44bd-b445-2116e4e6106c",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "paso_actual": "2",
            "datos_parciales": "={{ JSON.stringify({...JSON.parse($json.datos_parciales), cita_seleccionada: parseInt($json.mensaje) - 1}) }}",
            "timestamp_ultima_interaccion": "={{ $json.timestamp }}"
          }
        },
        "options": {}
      },
      "name": "Update Session Cancelar Paso 2",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1152,
        12416
      ],
      "id": "d3a4431a-946b-490a-8991-703280ac6093",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "mode": "expression",
        "output": null
      },
      "name": "Confirmar Cancelar Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1616,
        12672
      ],
      "id": "8e9e6c7f-669d-4107-a048-0185f3166f31"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "CITAS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id_cita": "={{ JSON.parse($json.datos_parciales).citas[JSON.parse($json.datos_parciales).cita_seleccionada].id_cita }}",
            "estado": "cancelada",
            "fecha_cancelado": "={{ new Date().toISOString().split('T')[0] }}"
          },
          "matchingColumns": [
            "id_cita"
          ]
        },
        "options": {}
      },
      "name": "Update Cita Cancelada",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1360,
        12624
      ],
      "id": "b0d3c1d1-ea91-4b9c-9bb3-ef3d15532b93",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "={{ '‚úÖ Cita cancelada exitosamente\\n\\nüìã ' + JSON.parse($json.datos_parciales).citas[JSON.parse($json.datos_parciales).cita_seleccionada].nombre + '\\n\\nVolviendo al men√∫ de agenda...' }}",
        "additionalFields": {}
      },
      "name": "Send Cita Cancelada Success",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1152,
        12624
      ],
      "id": "94fd9977-5303-4335-a082-c3d61e2c2758",
      "webhookId": "be25fbc0-b8ad-4a77-bdb6-08e0d2a11f1d",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "pantalla_actual": "menu_agenda",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $json.timestamp }}"
          }
        },
        "options": {}
      },
      "name": "Update After Cancelar",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -928,
        12624
      ],
      "id": "c6ce296b-4b40-4fd6-89bf-9abab8a776ca",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "‚ùå Selecci√≥n inv√°lida. Por favor ingresa una opci√≥n v√°lida.",
        "additionalFields": {}
      },
      "name": "Send Invalida Cancelar",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1360,
        12816
      ],
      "id": "64264574-6878-4860-b5c8-197f6f68e11c",
      "webhookId": "7c8df8ea-52d7-4ab3-9553-82c5c005801f",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "CITAS"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "creado_por",
              "lookupValue": "={{ $json.telegram_user }}"
            },
            {
              "lookupColumn": "estado",
              "lookupValue": "pendiente"
            }
          ]
        },
        "options": {}
      },
      "name": "Get Citas Para Completar",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1584,
        13024
      ],
      "alwaysOutputData": true,
      "id": "36f701af-6518-4ca4-8872-ef660e7e9ee9",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "={{ (() => {\nlet citas = $input.all();\nif (citas.length === 0) {\n    return '‚ùå No tienes citas pendientes para completar.\\n\\n0Ô∏è‚É£ Volver al men√∫ de agenda';\n}\nlet mensaje = '‚úÖ COMPLETAR CITA\\n\\nSelecciona el n√∫mero de la cita que deseas marcar como completada:\\n\\n';\nfor (let i = 0; i < citas.length; i++) {\n    let cita = citas[i].json;\n    mensaje += (i+1) + 'Ô∏è‚É£ ' + cita.nombre + '\\n   üìÖ ' + cita.fecha + ' a las ' + cita.hora + '\\n   üìù ' + cita.motivo + ' (' + cita.canal + ')\\n\\n';\n}\nmensaje += '\\n0Ô∏è‚É£ Volver';\nreturn mensaje;\n})() }}",
        "additionalFields": {}
      },
      "name": "Send Lista Para Completar Cita",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1360,
        13024
      ],
      "id": "4b1ea3bf-26a8-4d75-b275-d950a14212be",
      "webhookId": "27af17fd-6001-4257-8308-cb85606fa87b",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "pantalla_actual": "completar_cita",
            "paso_actual": "1",
            "datos_parciales": "={{ JSON.stringify({citas: $input.all().map(c => c.json)}) }}",
            "timestamp_ultima_interaccion": "={{ $json.timestamp }}"
          }
        },
        "options": {}
      },
      "name": "Update Session Completar Cita Paso 1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1152,
        13024
      ],
      "id": "91fe4d27-6215-449f-b5ce-007c1d47270d",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "mode": "expression",
        "output": null
      },
      "name": "Completar Cita Selection Router",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -1584,
        13216
      ],
      "id": "9da0b469-849e-4972-b1ad-ab08313758d5"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "CITAS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id_cita": "={{ JSON.parse($json.datos_parciales).citas[parseInt($json.mensaje) - 1].id_cita }}",
            "estado": "completada",
            "fecha_completado": "={{ new Date().toISOString().split('T')[0] }}"
          },
          "matchingColumns": [
            "id_cita"
          ]
        },
        "options": {}
      },
      "name": "Marcar Cita Como Completada",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -1360,
        13216
      ],
      "id": "ec0775c6-6e7e-4b27-8ede-c67490953934",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Set Variables').item.json.chat_id }}",
        "text": "={{ '‚úÖ ¬°Cita completada exitosamente!\\n\\nüìã ' + JSON.parse($json.datos_parciales).citas[parseInt($json.mensaje) - 1].nombre + '\\n\\nVolviendo al men√∫ de agenda...' }}",
        "additionalFields": {}
      },
      "name": "Send Cita Completada Success",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1152,
        13216
      ],
      "id": "546633cd-11e5-4e14-85dc-c21dc19d5ff1",
      "webhookId": "f53920d6-c2b3-4b5d-a9b0-f6224a2987a2",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "196K9mqVfhN8JUFpZfrvXQftcrTnQxOCqiUU_aB6I52Q",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "mode": "name",
          "value": "SESSIONS"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "pantalla_actual": "menu_agenda",
            "paso_actual": "0",
            "datos_parciales": "{}",
            "timestamp_ultima_interaccion": "={{ $json.timestamp }}"
          }
        },
        "options": {}
      },
      "name": "Update After Completar Cita",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        -928,
        13216
      ],
      "id": "a864efed-580e-4312-915b-3ffd11670383",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "fZ7jIZOfX6ts7GKS",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.chat_id }}",
        "text": "‚ùå Selecci√≥n inv√°lida. Por favor ingresa un n√∫mero v√°lido de la lista.",
        "additionalFields": {}
      },
      "name": "Send Invalida Completar Cita",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1360,
        13424
      ],
      "id": "4ae03307-31ab-404d-b43a-7e545365dcd5",
      "webhookId": "68938495-4ec9-438e-9ea0-8945f7cfa978",
      "credentials": {
        "telegramApi": {
          "id": "zSRrHWxaB0iogEXa",
          "name": "Telegram account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Telegram Trigger": {
      "main": [
        [
          {
            "node": "Set Variables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Variables": {
      "main": [
        [
          {
            "node": "Get Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Session": {
      "main": [
        [
          {
            "node": "Session Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Session Exists?": {
      "main": [
        [
          {
            "node": "Merge Session Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set New User Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Session Data": {
      "main": [
        [
          {
            "node": "Log Interaction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set New User Data": {
      "main": [
        [
          {
            "node": "Create New Session",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create New Session": {
      "main": [
        [
          {
            "node": "Log Interaction",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Interaction": {
      "main": [
        [
          {
            "node": "Router Principal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Bienvenida": {
      "main": [
        [
          {
            "node": "Prepare Update Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Update Data": {
      "main": [
        [
          {
            "node": "Update Session to Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router Principal": {
      "main": [
        [
          {
            "node": "Send Bienvenida",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Bienvenida",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Menu Principal Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Agenda Menu Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Agenda Wizard Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Tareas Menu Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Tarea Wizard Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Option",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Option",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Option",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Option",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Option",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Option",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Reprogramar Cita Selection Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cancelar Cita Selection Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Completar Cita Selection Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Ayuda Menu Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Option",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Ayuda": {
      "main": [
        [
          {
            "node": "Update to Ayuda",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ayuda Menu Router": {
      "main": [
        [
          {
            "node": "Send Menu Principal",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Option",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Menu Principal Router": {
      "main": [
        [
          {
            "node": "Send Ayuda",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Tareas Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Recordatorios Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Habitos Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Listas Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Reportes Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Config Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Admin Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Option",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Agenda Menu": {
      "main": [
        [
          {
            "node": "Update to Agenda Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Tareas Menu": {
      "main": [
        [
          {
            "node": "Update to Tareas Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Recordatorios Menu": {
      "main": [
        [
          {
            "node": "Update to Recordatorios",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Habitos Menu": {
      "main": [
        [
          {
            "node": "Update to Habitos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Listas Menu": {
      "main": [
        [
          {
            "node": "Update to Listas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Reportes Menu": {
      "main": [
        [
          {
            "node": "Update to Reportes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Config Menu": {
      "main": [
        [
          {
            "node": "Update to Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Admin Menu": {
      "main": [
        [
          {
            "node": "Update to Admin",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Menu Principal": {
      "main": [
        [
          {
            "node": "Update Volver Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agenda Menu Router": {
      "main": [
        [
          {
            "node": "Send Agenda Paso 1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Citas Usuario",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Citas Para Reprogramar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Citas Para Cancelar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Citas Para Completar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Menu Principal",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Agenda",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Agenda Paso 1": {
      "main": [
        [
          {
            "node": "Update Agenda Paso 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Citas Usuario": {
      "main": [
        [
          {
            "node": "Send Consultar Citas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agenda Wizard Router": {
      "main": [
        [
          {
            "node": "Cancelar?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cancelar 2?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cancelar 3?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cancelar 4?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Canal Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Confirmar Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Agenda",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar?": {
      "main": [
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Validar Fecha",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Fecha": {
      "main": [
        [
          {
            "node": "Set Fecha",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Fecha",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Fecha": {
      "main": [
        [
          {
            "node": "Update Paso 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Paso 2": {
      "main": [
        [
          {
            "node": "Send Paso 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar 2?": {
      "main": [
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Validar Hora",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Hora": {
      "main": [
        [
          {
            "node": "Set Hora",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Hora",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Hora": {
      "main": [
        [
          {
            "node": "Update Paso 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Paso 3": {
      "main": [
        [
          {
            "node": "Send Paso 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar 3?": {
      "main": [
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Nombre",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Nombre": {
      "main": [
        [
          {
            "node": "Update Paso 4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Paso 4": {
      "main": [
        [
          {
            "node": "Send Paso 4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar 4?": {
      "main": [
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Motivo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Motivo": {
      "main": [
        [
          {
            "node": "Update Paso 5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Paso 5": {
      "main": [
        [
          {
            "node": "Send Paso 5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Canal Router": {
      "main": [
        [
          {
            "node": "Set Presencial",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Virtual",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Llamada",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Agenda",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Presencial": {
      "main": [
        [
          {
            "node": "Update Paso 6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Virtual": {
      "main": [
        [
          {
            "node": "Update Paso 6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Llamada": {
      "main": [
        [
          {
            "node": "Update Paso 6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Paso 6": {
      "main": [
        [
          {
            "node": "Send Paso 6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Router": {
      "main": [
        [
          {
            "node": "Parse Cita",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Agenda Paso 1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Agenda",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Cita": {
      "main": [
        [
          {
            "node": "Guardar Cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Cita": {
      "main": [
        [
          {
            "node": "Update After Cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update After Cita": {
      "main": [
        [
          {
            "node": "Cita OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cita OK": {
      "main": [
        [
          {
            "node": "Send Menu Principal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Volver Router": {
      "main": [
        [
          {
            "node": "Send Menu Principal",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Option",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tareas Menu Router": {
      "main": [
        [
          {
            "node": "Send Tarea Paso 1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Tareas Pendientes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Tareas Completadas",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Tarea En Desarrollo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Tarea En Desarrollo",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Menu Principal",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Tarea Paso 1": {
      "main": [
        [
          {
            "node": "Update Tarea Paso 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Tareas Pendientes": {
      "main": [
        [
          {
            "node": "Send Tareas Pendientes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Tareas Completadas": {
      "main": [
        [
          {
            "node": "Send Tareas Completadas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tarea Wizard Router": {
      "main": [
        [
          {
            "node": "Cancelar Tarea?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cancelar Tarea 2?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Cancelar Tarea 3?",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalid Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar Tarea?": {
      "main": [
        [
          {
            "node": "Send Tareas Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Titulo Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Titulo Tarea": {
      "main": [
        [
          {
            "node": "Update Tarea Paso 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Tarea Paso 2": {
      "main": [
        [
          {
            "node": "Send Tarea Paso 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar Tarea 2?": {
      "main": [
        [
          {
            "node": "Send Tareas Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prioridad Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prioridad Router": {
      "main": [
        [
          {
            "node": "Set Prioridad Alta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Prioridad Media",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set Prioridad Baja",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Prioridad Invalida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Prioridad Alta": {
      "main": [
        [
          {
            "node": "Update Tarea Paso 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Prioridad Media": {
      "main": [
        [
          {
            "node": "Update Tarea Paso 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Prioridad Baja": {
      "main": [
        [
          {
            "node": "Update Tarea Paso 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Tarea Paso 3": {
      "main": [
        [
          {
            "node": "Send Tarea Paso 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar Tarea 3?": {
      "main": [
        [
          {
            "node": "Send Tareas Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Fecha Valida?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fecha Valida?": {
      "main": [
        [
          {
            "node": "Set Fecha Tarea",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Fecha Invalida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Fecha Tarea": {
      "main": [
        [
          {
            "node": "Parse Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Tarea": {
      "main": [
        [
          {
            "node": "Guardar Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Guardar Tarea": {
      "main": [
        [
          {
            "node": "Tarea OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Tarea OK": {
      "main": [
        [
          {
            "node": "Update After Tarea",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update After Tarea": {
      "main": [
        [
          {
            "node": "Send Tareas Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Tareas Para Completar": {
      "main": [
        [
          {
            "node": "Send Lista Para Completar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Lista Para Completar": {
      "main": [
        [
          {
            "node": "Update Session Completar Paso 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Completar Tarea Selection Router": {
      "main": [
        [
          {
            "node": "Send Tareas Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Marcar Tarea Como Completada",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Seleccion Invalida Completar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Marcar Tarea Como Completada": {
      "main": [
        [
          {
            "node": "Send Tarea Completada Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Tarea Completada Success": {
      "main": [
        [
          {
            "node": "Update After Completar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update After Completar": {
      "main": [
        [
          {
            "node": "Send Tareas Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Tareas Para Eliminar": {
      "main": [
        [
          {
            "node": "Send Lista Para Eliminar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Lista Para Eliminar": {
      "main": [
        [
          {
            "node": "Update Session Eliminar Paso 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Eliminar Tarea Selection Router": {
      "main": [
        [
          {
            "node": "Send Tareas Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Confirmar Eliminar",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Seleccion Invalida Eliminar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Confirmar Eliminar": {
      "main": [
        [
          {
            "node": "Update Session Eliminar Paso 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Eliminar Router": {
      "main": [
        [
          {
            "node": "Delete Tarea",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Tareas Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Seleccion Invalida Eliminar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Tarea": {
      "main": [
        [
          {
            "node": "Send Tarea Eliminada Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Tarea Eliminada Success": {
      "main": [
        [
          {
            "node": "Update After Eliminar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update After Eliminar": {
      "main": [
        [
          {
            "node": "Send Tareas Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Citas Para Reprogramar": {
      "main": [
        [
          {
            "node": "Send Lista Para Reprogramar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Lista Para Reprogramar": {
      "main": [
        [
          {
            "node": "Update Session Reprogramar Paso 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reprogramar Cita Selection Router": {
      "main": [
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Solicitar Nueva Fecha",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalida Reprogramar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Solicitar Nueva Fecha": {
      "main": [
        [
          {
            "node": "Update Session Reprogramar Paso 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Nueva Fecha Router": {
      "main": [
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Solicitar Nueva Hora",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalida Reprogramar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Solicitar Nueva Hora": {
      "main": [
        [
          {
            "node": "Update Session Reprogramar Paso 3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validar Nueva Hora Router": {
      "main": [
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Cita Reprogramada",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalida Reprogramar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Cita Reprogramada": {
      "main": [
        [
          {
            "node": "Send Cita Reprogramada Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Cita Reprogramada Success": {
      "main": [
        [
          {
            "node": "Update After Reprogramar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update After Reprogramar": {
      "main": [
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Citas Para Cancelar": {
      "main": [
        [
          {
            "node": "Send Lista Para Cancelar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Lista Para Cancelar": {
      "main": [
        [
          {
            "node": "Update Session Cancelar Paso 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cancelar Cita Selection Router": {
      "main": [
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Confirmar Cancelar Cita",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalida Cancelar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Confirmar Cancelar Cita": {
      "main": [
        [
          {
            "node": "Update Session Cancelar Paso 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirmar Cancelar Router": {
      "main": [
        [
          {
            "node": "Update Cita Cancelada",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalida Cancelar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Cita Cancelada": {
      "main": [
        [
          {
            "node": "Send Cita Cancelada Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Cita Cancelada Success": {
      "main": [
        [
          {
            "node": "Update After Cancelar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update After Cancelar": {
      "main": [
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Citas Para Completar": {
      "main": [
        [
          {
            "node": "Send Lista Para Completar Cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Lista Para Completar Cita": {
      "main": [
        [
          {
            "node": "Update Session Completar Cita Paso 1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Completar Cita Selection Router": {
      "main": [
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Marcar Cita Como Completada",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Invalida Completar Cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Marcar Cita Como Completada": {
      "main": [
        [
          {
            "node": "Send Cita Completada Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Cita Completada Success": {
      "main": [
        [
          {
            "node": "Update After Completar Cita",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update After Completar Cita": {
      "main": [
        [
          {
            "node": "Send Agenda Menu",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "00ffcc16-e220-4eba-ab26-34ba87f966a7",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "f9c95d1c6c5a88f42f809307f78f6486a001bde66068e0e4a3dd1b4652866230"
  },
  "id": "jJ7XgGYsF7CmC2HtBzYm2",
  "tags": []
}